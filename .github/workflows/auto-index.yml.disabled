name: Auto Generate Index

on:
  push:
    branches: [main]
    paths:
      - 'MAIN/**'
      - 'autodidactive/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Folder to index'
        required: false
        default: 'MAIN'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-index-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install openai

      - name: Generate file tree
        run: |
          # Generate structured file tree
          echo "# Repository Structure" > structure.txt
          echo "" >> structure.txt
          echo "Generated on: $(date -u '+%Y-%m-%d %H:%M UTC')" >> structure.txt
          echo "" >> structure.txt
          echo '```' >> structure.txt
          tree -L 3 --dirsfirst -I '__pycache__|*.pyc|.git|node_modules|dist|build|*.egg-info' MAIN/ >> structure.txt 2>/dev/null || find MAIN -type d -maxdepth 3 | head -50 >> structure.txt
          echo '```' >> structure.txt
          echo "" >> structure.txt

          # List key files with first lines
          echo "## Key Files" >> structure.txt
          for f in MAIN/*/README.md; do
            if [ -f "$f" ]; then
              dir=$(dirname "$f" | sed 's|MAIN/||')
              firstline=$(head -1 "$f" | sed 's/^#* *//')
              echo "- **$dir**: $firstline" >> structure.txt
            fi
          done

      - name: Generate index with AI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import os
          from openai import OpenAI

          # GitHub Models endpoint
          client = OpenAI(
              base_url="https://models.inference.ai.azure.com",
              api_key=os.environ["GITHUB_TOKEN"]
          )

          # Read structure
          with open("structure.txt", "r") as f:
              structure = f.read()

          # Read current INDEX.md for context
          current_index = ""
          if os.path.exists("MAIN/legacy-core/INDEX.md"):
              with open("MAIN/legacy-core/INDEX.md", "r") as f:
                  current_index = f.read()[:2000]  # First 2000 chars for context

          prompt = f"""Based on this repository structure, generate a GLOSSARY.md file.

          Current structure:
          {structure}

          Current INDEX.md excerpt (for style reference):
          {current_index[:1000] if current_index else "No existing index"}

          Requirements:
          1. Create a markdown navigation index
          2. Include a file tree diagram
          3. Add a table with folder names and brief descriptions
          4. Use the same formatting style as the existing INDEX.md
          5. Add a "Last auto-generated" timestamp
          6. Keep it concise but navigable

          Output only the markdown content, no explanations."""

          response = client.chat.completions.create(
              model="gpt-4o-mini",
              messages=[
                  {"role": "system", "content": "You are a documentation generator. Output clean markdown only."},
                  {"role": "user", "content": prompt}
              ],
              max_tokens=2000
          )

          content = response.choices[0].message.content

          with open("GLOSSARY.md", "w") as f:
              f.write(content)

          print("Generated index successfully")
          EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: auto-generate repository index

            Auto-generated using GitHub Models (gpt-4o-mini)
            Triggered by: ${{ github.event_name }}
          branch: auto-index-update
          delete-branch: true
          title: "docs: auto-generate repository index"
          body: |
            ## Auto-generated Index Update

            This PR was automatically created by the `auto-index.yml` workflow.

            **Changes:**
            - Updated `GLOSSARY.md` with current repository structure

            **Generated using:** GitHub Models (gpt-4o-mini)
            **Triggered by:** `${{ github.event_name }}`

            ---
            *This is an automated PR. Review and merge if the changes look correct.*
          labels: |
            documentation
            automated
          add-paths: |
            GLOSSARY.md
