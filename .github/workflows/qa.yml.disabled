name: QA Checks

on:
  push:
    branches: [main]
    paths:
      - 'MAIN/legacy-core/**'
      - 'docs/**'
      - '.github/workflows/qa.yml'
      - 'repo-metadata.json'
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 6am UTC
    - cron: '0 6 * * 0'

permissions:
  contents: read

concurrency:
  group: qa-${{ github.ref }}
  cancel-in-progress: true

jobs:
  brand-consistency:
    name: Brand Consistency Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Validate brand.json structure
        run: |
          echo "## Brand Consistency Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validate JSON syntax
          python -c "import json; json.load(open('MAIN/legacy-core/resources/brand/brand.json'))" || {
            echo "::error::brand.json has invalid JSON syntax"
            exit 1
          }
          echo "- JSON syntax: valid" >> $GITHUB_STEP_SUMMARY

          # Extract brand values
          ONI_NAME=$(python -c "import json; print(json.load(open('MAIN/legacy-core/resources/brand/brand.json'))['oni']['name'])")
          TARA_NAME=$(python -c "import json; print(json.load(open('MAIN/legacy-core/resources/brand/brand.json'))['tara']['name'])")
          ONI_VERSION=$(python -c "import json; print(json.load(open('MAIN/legacy-core/resources/brand/brand.json'))['oni']['version'])")
          TARA_VERSION=$(python -c "import json; print(json.load(open('MAIN/legacy-core/resources/brand/brand.json'))['tara']['version'])")

          echo "- ONI name: $ONI_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- TARA name: $TARA_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- ONI version: $ONI_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- TARA version: $TARA_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check brand loading in Python packages
        run: |
          echo "### Python Package Brand Loading" >> $GITHUB_STEP_SUMMARY

          # Install packages
          pip install -e MAIN/legacy-core/oni-framework -q
          pip install -e MAIN/legacy-core/tara-nsec-platform -q
          pip install -e autodidactive/oni-academy -q

          # Test oni-framework brand loading
          python -c "
          from oni.brand import ONI, TARA
          assert ONI.name == 'ONI Framework', f'ONI name mismatch: {ONI.name}'
          assert 'TARA' in TARA.name, f'TARA name mismatch: {TARA.name}'
          print(f'oni-framework: ONI={ONI.name}, TARA={TARA.name}')
          " || { echo "::error::oni-framework brand loading failed"; exit 1; }
          echo "- oni-framework: OK" >> $GITHUB_STEP_SUMMARY

          # Test tara brand loading
          python -c "
          from tara_mvp._brand import ONI, TARA
          assert ONI.name == 'ONI Framework', f'ONI name mismatch: {ONI.name}'
          assert 'TARA' in TARA.name, f'TARA name mismatch: {TARA.name}'
          print(f'tara_mvp: ONI={ONI.name}, TARA={TARA.name}')
          " || { echo "::error::tara_mvp brand loading failed"; exit 1; }
          echo "- tara_mvp: OK" >> $GITHUB_STEP_SUMMARY

          # Test oni-academy brand loading
          python -c "
          from oni_academy._brand import ONI, TARA
          assert ONI.name == 'ONI Framework', f'ONI name mismatch: {ONI.name}'
          assert 'TARA' in TARA.name, f'TARA name mismatch: {TARA.name}'
          print(f'oni_academy: ONI={ONI.name}, TARA={TARA.name}')
          " || { echo "::error::oni_academy brand loading failed"; exit 1; }
          echo "- oni_academy: OK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check for stale brand references
        run: |
          echo "### Stale Brand Reference Check" >> $GITHUB_STEP_SUMMARY

          # Get current TARA name from brand.json
          TARA_NAME=$(python -c "import json; print(json.load(open('MAIN/legacy-core/resources/brand/brand.json'))['tara']['name'])")

          # Check for old "TARA Platform" if current name is different
          if [ "$TARA_NAME" != "TARA Platform" ]; then
            OLD_REFS=$(grep -rn "TARA Platform" --include="*.py" --include="*.md" --include="*.html" --include="*.tsx" --include="*.ts" MAIN/legacy-core/ docs/ video/ 2>/dev/null | grep -v "_brand.py" | grep -v "OBSIDIAN" || true)
            if [ -n "$OLD_REFS" ]; then
              echo "::warning::Found stale 'TARA Platform' references:"
              echo "$OLD_REFS"
              echo "- Stale references found (see workflow log)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- No stale references found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Current name is 'TARA Platform', skipping stale check" >> $GITHUB_STEP_SUMMARY
          fi

  import-validation:
    name: Import Validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install all packages
        run: |
          pip install -e MAIN/legacy-core/oni-framework
          pip install -e MAIN/legacy-core/tara-nsec-platform
          pip install -e autodidactive/oni-academy

      - name: Validate core imports
        run: |
          echo "## Import Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ONI Framework imports
          python -c "
          from oni import ONIStack, Layer, NeuralFirewall, CoherenceMetric
          from oni.coherence import CoherenceMetric, VarianceComponents
          from oni.firewall import Signal, FilterResult, NeuralFirewall
          from oni.layers import ONIStack, Layer, Domain
          from oni.brand import ONI, TARA
          print('oni-framework imports: OK')
          " || { echo "::error::oni-framework import failed"; exit 1; }
          echo "- oni-framework: All core imports OK" >> $GITHUB_STEP_SUMMARY

          # TARA imports
          python -c "
          from tara_mvp import AttackSimulator, AttackPattern
          from tara_mvp.core.coherence import CoherenceMetric
          from tara_mvp.core.firewall import NeuralFirewall
          from tara_mvp.core.layers import ONIStack
          from tara_mvp._brand import TARA, ONI
          print('tara_mvp imports: OK')
          " || { echo "::error::tara_mvp import failed"; exit 1; }
          echo "- tara_mvp: All core imports OK" >> $GITHUB_STEP_SUMMARY

          # ONI Academy imports
          python -c "
          from oni_academy import list_modules, get_course
          from oni_academy._brand import ONI, TARA
          print('oni_academy imports: OK')
          " || { echo "::error::oni_academy import failed"; exit 1; }
          echo "- oni_academy: All core imports OK" >> $GITHUB_STEP_SUMMARY

  formula-consistency:
    name: Formula Consistency Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check Coherence formula consistency
        run: |
          echo "## Formula Consistency Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # The authoritative formula: Cₛ = e^(−(σ²φ + σ²τ + σ²γ))
          # Check for legacy/incorrect formulas

          echo "### Coherence Formula (Cₛ)" >> $GITHUB_STEP_SUMMARY

          # Check for legacy Coherence formula notation (Cₛ with weighted sum)
          # Note: Pₛ (Privacy Score) legitimately uses weighted sums, so we only check for Cₛ
          LEGACY=$(grep -rn "Cₛ.*=.*Σ" --include="*.md" --include="*.py" MAIN/legacy-core/ 2>/dev/null | grep -v "TRANSPARENCY.md" | grep -v "Legacy" || true)
          if [ -n "$LEGACY" ]; then
            echo "::warning::Found potential legacy Coherence formula notation:"
            echo "$LEGACY"
            echo "- Potential legacy Cₛ notation found (review needed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- No legacy Cₛ weighted sum notation found" >> $GITHUB_STEP_SUMMARY
          fi

          # Verify exponential form exists in key files
          if grep -q "e\^.*σ²" MAIN/legacy-core/oni-framework/README.md 2>/dev/null || grep -q "exp.*variance" MAIN/legacy-core/oni-framework/oni/coherence.py 2>/dev/null; then
            echo "- Exponential form verified in source" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scale-Frequency Invariant (f × S ≈ k)" >> $GITHUB_STEP_SUMMARY

          # Check scale-frequency formula exists
          if grep -rq "f × S" --include="*.md" MAIN/legacy-core/ 2>/dev/null; then
            echo "- Scale-frequency formula found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Scale-frequency formula not found in docs" >> $GITHUB_STEP_SUMMARY
          fi

  link-validation:
    name: Documentation Link Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for broken internal links
        run: |
          echo "## Link Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BROKEN=0

          # Check markdown links in key files
          for file in MAIN/legacy-core/INDEX.md MAIN/legacy-core/oni-framework/README.md MAIN/legacy-core/tara-nsec-platform/README.md; do
            if [ -f "$file" ]; then
              # Extract relative links and check if files exist
              LINKS=$(grep -oE '\[.*?\]\(([^)]+)\)' "$file" | grep -oE '\(([^)]+)\)' | tr -d '()' | grep -v '^http' | grep -v '^#' || true)
              DIR=$(dirname "$file")

              for link in $LINKS; do
                TARGET="$DIR/$link"
                if [ ! -e "$TARGET" ] && [ ! -e "$link" ]; then
                  echo "::warning::Broken link in $file: $link"
                  BROKEN=$((BROKEN + 1))
                fi
              done
            fi
          done

          if [ $BROKEN -gt 0 ]; then
            echo "- Found $BROKEN potentially broken links (see warnings)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- No broken links detected in key files" >> $GITHUB_STEP_SUMMARY
          fi

  html-validation:
    name: HTML/JS Validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate HTML files
        run: |
          echo "## HTML Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check docs/index.html exists and has required elements
          if [ -f "docs/index.html" ]; then
            # Check for CSP
            if grep -q "Content-Security-Policy" docs/index.html; then
              echo "- CSP header: present" >> $GITHUB_STEP_SUMMARY
            else
              echo "::warning::Missing CSP in docs/index.html"
              echo "- CSP header: MISSING" >> $GITHUB_STEP_SUMMARY
            fi

            # Check for SRI on external scripts
            EXTERNAL=$(grep -c 'script src="https://' docs/index.html 2>/dev/null || echo "0")
            SRI=$(grep -c 'integrity="sha' docs/index.html 2>/dev/null || echo "0")
            echo "- External scripts: $EXTERNAL, with SRI: $SRI" >> $GITHUB_STEP_SUMMARY

            # Check brand.json fetch URL
            if grep -q "raw.githubusercontent.com.*brand.json" docs/index.html; then
              echo "- Dynamic brand loading: configured" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "::warning::docs/index.html not found"
          fi

  metadata-validation:
    name: Metadata Validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Validate repo-metadata.json
        run: python3 MAIN/shared/validate_metadata.py

  qa-summary:
    name: QA Summary
    needs: [brand-consistency, import-validation, formula-consistency, link-validation, html-validation, metadata-validation]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## QA Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Brand Consistency | ${{ needs.brand-consistency.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Import Validation | ${{ needs.import-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Formula Consistency | ${{ needs.formula-consistency.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Link Validation | ${{ needs.link-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HTML Validation | ${{ needs.html-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Metadata Validation | ${{ needs.metadata-validation.result }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any critical check failed
          if [ "${{ needs.brand-consistency.result }}" == "failure" ] || \
             [ "${{ needs.import-validation.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::error::Critical QA checks failed"
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All critical checks passed!" >> $GITHUB_STEP_SUMMARY
