#!/bin/bash
#
# Security Audit Pipeline - Pre-commit Hook
#
# This hook runs before each commit to scan staged files for:
# - Secrets and API keys
# - Credentials and passwords
# - PII (personally identifiable information)
# - Private keys and certificates
#
# Installation:
#   ./.github/security-audit/install.sh
#
# To bypass (use sparingly):
#   git commit --no-verify
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[0;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find the repository root
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$REPO_ROOT" ]; then
    echo -e "${RED}Error: Not a git repository${NC}"
    exit 1
fi

# Path to audit script
AUDIT_SCRIPT="$REPO_ROOT/.github/security-audit/scripts/audit.py"
CONFIG_FILE="$REPO_ROOT/.github/security-audit/patterns/secrets.json"

# Check if audit script exists
if [ ! -f "$AUDIT_SCRIPT" ]; then
    echo -e "${YELLOW}Warning: Security audit script not found at $AUDIT_SCRIPT${NC}"
    echo -e "${YELLOW}Skipping security scan...${NC}"
    exit 0
fi

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    echo -e "${YELLOW}Warning: Python 3 not found. Skipping security scan.${NC}"
    exit 0
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    # No staged files, nothing to scan
    exit 0
fi

echo -e "${BLUE}Running security audit on staged files...${NC}"
echo ""

# Run the audit
OUTPUT=$(python3 "$AUDIT_SCRIPT" --staged --config "$CONFIG_FILE" --fail-on high 2>&1) || EXIT_CODE=$?

# Display output
echo "$OUTPUT"

# Check exit code
if [ "${EXIT_CODE:-0}" -ne 0 ]; then
    echo ""
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}  COMMIT BLOCKED: Security issues found${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  1. Fix the issues above and try again"
    echo "  2. Add false positives to allowlist in:"
    echo "     $CONFIG_FILE"
    echo "  3. Bypass this check (not recommended):"
    echo "     git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}Security audit passed.${NC}"
exit 0
