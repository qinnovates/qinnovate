<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QIF v6.0 ‚Äî Interactive Hourglass Architecture</title>
<style>
/* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #faf9f6;
  --bg-surface: #f0eee9;
  --bg-overlay: #e8e6e1;
  --border: rgba(0, 0, 0, 0.1);
  --text: #4b5563;
  --text-dim: #6b7280;
  --text-bright: #1f2937;
  --green: #16a34a;
  --red: #dc2626;
  --blue: #2563eb;
  --orange: #d97706;
  --yellow: #ca8a04;
  --purple: #7c3aed;
  --cyan: #0891b2;
  --severity-lethal: #dc2626;
  --severity-critical: #ea580c;
  --severity-high: #d97706;
  --severity-severe: #ca8a04;
  --severity-synthetic: #2563eb;
  --severity-interface: #7c3aed;
  --font-mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', 'Cascadia Code', Consolas, monospace;
  --font-sans: "Inter", -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  --font-heading: "Inter", system-ui, sans-serif;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

html { font-size: 14px; }
body {
  font-family: var(--font-sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
#app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

header {
  padding: 1rem 2rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
}

header h1 {
  font-family: var(--font-heading);
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-bright);
  letter-spacing: 0.02em;
}

header h1 span.version {
  color: var(--text-dim);
  font-weight: 400;
  font-size: 0.85rem;
}

.toolbar {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
}

.toolbar-group {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.3rem 0.5rem;
}

.toolbar-group-label {
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-dim);
  margin-right: 0.25rem;
  white-space: nowrap;
}

.toolbar-btn {
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.45rem 0.85rem;
  border-radius: 6px;
  font-family: var(--font-sans);
  font-size: 0.8rem;
  cursor: pointer;
  transition: var(--transition);
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.toolbar-btn .btn-icon { font-size: 1rem; }
.toolbar-btn:hover { border-color: var(--text-dim); background: rgba(0,0,0,0.04); }
.toolbar-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(37,99,235,0.08); }

.toolbar-select {
  background: var(--bg-overlay);
  border: 1px solid var(--blue);
  color: var(--text);
  padding: 0.45rem 0.6rem;
  border-radius: 6px;
  font-family: var(--font-sans);
  font-size: 0.8rem;
  cursor: pointer;
  min-width: 220px;
  box-shadow: 0 0 0 1px rgba(88,166,255,0.15);
}

.toolbar-select:focus { box-shadow: 0 0 0 2px rgba(88,166,255,0.3); outline: none; }
.toolbar-select option { background: var(--bg-surface); }

/* ‚îÄ‚îÄ Walkthrough ‚îÄ‚îÄ */
.walkthrough-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(4px);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
}

.walkthrough-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 2rem 2.5rem;
  max-width: 520px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
}

.walkthrough-card h2 {
  font-family: var(--font-heading);
  font-size: 1.3rem;
  color: var(--text-bright);
  margin-bottom: 1.25rem;
  font-weight: 600;
}

.walkthrough-steps {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.walkthrough-step {
  display: flex;
  gap: 0.75rem;
  align-items: flex-start;
}

.walkthrough-step-num {
  width: 1.6rem;
  height: 1.6rem;
  border-radius: 50%;
  background: rgba(37,99,235,0.1);
  color: var(--blue);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  flex-shrink: 0;
  margin-top: 0.1rem;
}

.walkthrough-step-text {
  font-size: 0.85rem;
  color: var(--text);
  line-height: 1.5;
  font-family: var(--font-sans);
}

.walkthrough-step-text strong { color: var(--text-bright); }
.walkthrough-step-text .key {
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.1rem 0.4rem;
  font-size: 0.75rem;
  font-family: var(--font-mono);
  color: var(--text-dim);
}

.walkthrough-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.walkthrough-dismiss {
  background: var(--blue);
  color: #fff;
  border: none;
  padding: 0.5rem 1.5rem;
  border-radius: 6px;
  font-family: var(--font-sans);
  font-size: 0.85rem;
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
}

.walkthrough-dismiss:hover { filter: brightness(1.15); }

.walkthrough-skip {
  color: var(--text-dim);
  font-size: 0.75rem;
  font-family: var(--font-sans);
  cursor: pointer;
  background: none;
  border: none;
  text-decoration: underline;
  text-underline-offset: 2px;
}

.walkthrough-skip:hover { color: var(--text); }

/* ‚îÄ‚îÄ Main Content Area ‚îÄ‚îÄ */
main {
  flex: 1;
  display: flex;
  position: relative;
  overflow: hidden;
}

#hourglass-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  position: relative;
}

/* ‚îÄ‚îÄ Hourglass SVG ‚îÄ‚îÄ */
.hourglass-wrap {
  display: flex;
  align-items: stretch;
  gap: 1.5rem;
  max-width: 900px;
  width: 100%;
}

.axis-label-left {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 0;
  width: 2rem;
  flex-shrink: 0;
}

.axis-label-left .arrow-up,
.axis-label-left .arrow-down {
  font-size: 1.2rem;
  color: var(--text-dim);
}

.axis-label-left .label-text {
  writing-mode: vertical-rl;
  text-orientation: mixed;
  transform: rotate(180deg);
  font-size: 0.65rem;
  color: var(--text-dim);
  letter-spacing: 0.15em;
  text-transform: uppercase;
}

.hourglass-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0;
}

.band-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.2rem 0;
  cursor: pointer;
  position: relative;
  transition: var(--transition);
}

.band-row:hover { background: rgba(0,0,0,0.03); border-radius: 4px; }
.band-row:hover .band-bar { filter: brightness(1.2); }

.band-id {
  width: 2rem;
  text-align: right;
  font-family: var(--font-mono);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-dim);
  flex-shrink: 0;
}

.band-bar-container {
  flex: 1;
  display: flex;
  justify-content: center;
  position: relative;
  height: 2rem;
}

.band-bar {
  height: 100%;
  border-radius: 3px;
  transition: var(--transition);
  position: relative;
  min-width: 20px;
}

.band-bar.pulse {
  animation: pulse-glow 1.5s ease-in-out infinite;
}

@keyframes pulse-glow {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.6); box-shadow: 0 0 15px currentColor; }
}

.band-name {
  width: 10rem;
  font-size: 0.7rem;
  color: var(--text);
  flex-shrink: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ‚îÄ‚îÄ Zone Separators ‚îÄ‚îÄ */
.zone-separator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.3rem 0;
  margin: 0.15rem 0;
}

.zone-separator .line {
  flex: 1;
  height: 1px;
  background: var(--border);
}

.zone-separator .zone-label {
  font-size: 0.6rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  white-space: nowrap;
}

/* ‚îÄ‚îÄ X-Axis Label ‚îÄ‚îÄ */
.x-axis-label {
  text-align: center;
  padding: 1rem 0 0.5rem;
}

.x-axis-label .primary {
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 0.15em;
  text-transform: uppercase;
}

.x-axis-label .secondary {
  font-size: 0.6rem;
  color: rgba(139,148,158,0.6);
}

/* ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ */
.tooltip {
  position: fixed;
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  font-size: 0.75rem;
  max-width: 300px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.tooltip.visible { opacity: 1; }

.tooltip .tt-header {
  font-weight: 600;
  color: var(--text-bright);
  margin-bottom: 0.4rem;
  font-size: 0.85rem;
}

.tooltip .tt-row {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  padding: 0.15rem 0;
}

.tooltip .tt-label { color: var(--text-dim); }
.tooltip .tt-value { color: var(--text); text-align: right; }
.tooltip .tt-hint { color: var(--text-dim); font-style: italic; margin-top: 0.4rem; font-size: 0.7rem; }

/* ‚îÄ‚îÄ Severity Badge ‚îÄ‚îÄ */
.severity-badge {
  display: inline-block;
  padding: 0.15rem 0.5rem;
  border-radius: 99px;
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.severity-badge.lethal { background: rgba(220,38,38,0.08); color: var(--severity-lethal); border: 1px solid rgba(220,38,38,0.2); }
.severity-badge.critical { background: rgba(234,88,12,0.08); color: var(--severity-critical); border: 1px solid rgba(234,88,12,0.2); }
.severity-badge.high { background: rgba(217,119,6,0.08); color: var(--severity-high); border: 1px solid rgba(217,119,6,0.2); }
.severity-badge.severe { background: rgba(202,138,4,0.08); color: var(--severity-severe); border: 1px solid rgba(202,138,4,0.2); }
.severity-badge.synthetic { background: rgba(37,99,235,0.06); color: var(--severity-synthetic); border: 1px solid rgba(37,99,235,0.15); }
.severity-badge.interface { background: rgba(124,58,237,0.06); color: var(--severity-interface); border: 1px solid rgba(124,58,237,0.15); }

/* ‚îÄ‚îÄ Detail Tabs ‚îÄ‚îÄ */
.detail-tabs {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  border-bottom: 2px solid var(--border);
  margin: 0 auto;
  padding: 0.75rem 2rem 0;
  max-width: 1000px;
}

.detail-tab {
  padding: 0.75rem 2rem;
  font-family: var(--font-sans);
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-dim);
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-bottom: 3px solid transparent;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  letter-spacing: 0.02em;
}

.detail-tab:hover { color: var(--text); background: var(--bg-overlay); border-color: var(--text-dim); border-bottom-color: transparent; }
.detail-tab.active { color: var(--text-bright); background: var(--bg); border-bottom-color: var(--blue); border-color: var(--blue); }
.detail-tab.active-green { color: var(--green); background: rgba(22,163,74,0.05); border-bottom-color: var(--green); border-color: var(--green); }
.detail-tab.active-amber { color: var(--orange); background: rgba(217,119,6,0.05); border-bottom-color: var(--orange); border-color: var(--orange); }

.detail-tab .tab-count {
  font-size: 0.75rem;
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  padding: 0.15rem 0.55rem;
  border-radius: 99px;
  color: var(--text-dim);
  font-weight: 700;
}

.detail-tab-panel { display: none; }
.detail-tab-panel.active {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  padding: 2rem;
  max-width: 1000px;
  margin: 0 auto;
}

/* ‚îÄ‚îÄ Therapeutic Section (green accent) ‚îÄ‚îÄ */
.detail-therapeutic h3 { color: var(--green); border-bottom-color: rgba(22,163,74,0.2); }

.therapeutic-tag {
  display: inline-block;
  background: rgba(22,163,74,0.06);
  border: 1px solid rgba(22,163,74,0.2);
  color: var(--green);
  padding: 0.15rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
  margin: 0.15rem;
}

.therapeutic-tag.fda-approved { background: rgba(22,163,74,0.1); border-color: rgba(22,163,74,0.3); font-weight: 600; }
.therapeutic-tag.fda-cleared { background: rgba(37,99,235,0.06); border-color: rgba(37,99,235,0.2); color: var(--blue); }
.therapeutic-tag.fda-investigational { background: rgba(217,119,6,0.06); border-color: rgba(217,119,6,0.2); color: var(--orange); }
.therapeutic-tag.fda-none { background: var(--bg-overlay); border-color: var(--border); color: var(--text-dim); }

.therapeutic-tag.evidence { font-style: italic; background: var(--bg-overlay); border-color: var(--border); color: var(--text-dim); }

.therapeutic-card {
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 0.6rem;
  background: var(--bg-overlay);
}

.therapeutic-card .tc-name { font-weight: 600; color: var(--text-bright); font-size: 0.85rem; margin-bottom: 0.4rem; }
.therapeutic-card .tc-attack { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.3rem; }
.therapeutic-card .tc-params { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.3rem; font-style: italic; }

/* ‚îÄ‚îÄ DSM-5 Section (amber accent) ‚îÄ‚îÄ */
.detail-dsm5 h3 { color: var(--orange); border-bottom-color: rgba(217,119,6,0.2); }

.dsm-code-badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  border-radius: 99px;
  font-size: 0.7rem;
  font-weight: 600;
  margin: 0.15rem;
  background: rgba(217,119,6,0.06);
  border: 1px solid rgba(217,119,6,0.2);
  color: var(--orange);
}

.dsm-code-badge.secondary {
  background: var(--bg-overlay);
  border-color: var(--border);
  color: var(--text-dim);
  font-weight: 400;
}

.dsm-cluster-badge {
  display: inline-block;
  padding: 0.2rem 0.6rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
  margin: 0.15rem;
}

.dsm-pathway {
  font-size: 0.75rem;
  color: var(--text);
  padding: 0.4rem 0;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  flex-wrap: wrap;
}

.dsm-pathway .arrow { color: var(--text-dim); }

.niss-bridge-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
}

.niss-bridge-table th {
  text-align: left;
  padding: 0.4rem 0.6rem;
  color: var(--text-dim);
  font-weight: 500;
  border-bottom: 1px solid var(--border);
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.niss-bridge-table td {
  padding: 0.4rem 0.6rem;
  border-bottom: 1px solid rgba(48,54,61,0.5);
  color: var(--text);
}

.niss-bridge-table tr:last-child td { border-bottom: none; }

.dsm-technique-row {
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
}

.dsm-technique-row:last-child { border-bottom: none; }
.dsm-technique-row .dt-name { font-weight: 600; color: var(--text-bright); font-size: 0.8rem; }
.dsm-technique-row .dt-meta { color: var(--text-dim); font-size: 0.7rem; margin-top: 0.2rem; }

/* ‚îÄ‚îÄ Band Detail View (Full Screen Overlay) ‚îÄ‚îÄ */
#band-detail {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 100;
  overflow-y: auto;
  display: none;
  opacity: 0;
  transition: opacity var(--transition);
}

#band-detail.visible { display: block; opacity: 1; }

.detail-header {
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 1rem;
}

.back-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.4rem 0.75rem;
  border-radius: 6px;
  font-family: var(--font-sans);
  font-size: 0.8rem;
  cursor: pointer;
  transition: var(--transition);
}

.back-btn:hover { border-color: var(--text-dim); background: var(--bg-surface); }

.detail-title {
  font-family: var(--font-heading);
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--text-bright);
}

.detail-subtitle {
  font-size: 0.85rem;
  color: var(--text-dim);
}

.detail-body {
  padding: 2rem;
  max-width: 1000px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

.detail-section {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1.25rem;
}

.detail-section.full-width { grid-column: 1 / -1; }

.detail-section h3 {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
}

.detail-section ul {
  list-style: none;
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
}

.detail-section ul li {
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  padding: 0.25rem 0.6rem;
  border-radius: 4px;
  font-size: 0.75rem;
}

.detail-kv {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 0.3rem 1rem;
  font-size: 0.8rem;
}

.detail-kv dt { color: var(--text-dim); }
.detail-kv dd { color: var(--text); }

.detail-attack-row {
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
}

.detail-attack-row:last-child { border-bottom: none; }

.detail-attack-name { font-weight: 600; color: var(--text-bright); }
.detail-attack-meta { color: var(--text-dim); font-size: 0.7rem; margin-top: 0.2rem; }

/* ‚îÄ‚îÄ Frequency Spectrum Panel ‚îÄ‚îÄ */
#freq-panel {
  width: 0;
  overflow: hidden;
  border-left: 1px solid var(--border);
  background: var(--bg-surface);
  transition: width var(--transition);
  flex-shrink: 0;
}

#freq-panel.open { width: 280px; }

.freq-panel-inner {
  width: 280px;
  padding: 1rem;
  height: 100%;
  overflow-y: auto;
}

.freq-panel-inner h3 {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 1rem;
}

.freq-ruler {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.freq-entry {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.35rem 0.5rem;
  border-left: 3px solid transparent;
  font-size: 0.7rem;
  transition: var(--transition);
}

.freq-entry.neural { border-left-color: var(--green); }
.freq-entry.synthetic { border-left-color: var(--blue); }
.freq-entry.attack { border-left-color: var(--red); background: rgba(220,38,38,0.04); }
.freq-entry.restricted { opacity: 0.7; }

.freq-entry .freq-name { flex: 1; color: var(--text); }
.freq-entry .freq-range { color: var(--text-dim); font-size: 0.65rem; }

.freq-section-title {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  padding: 0.5rem 0 0.25rem;
  margin-top: 0.5rem;
}

/* ‚îÄ‚îÄ Quantum Toggle ‚îÄ‚îÄ */
.quantum-switch {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
}

.quantum-switch label { color: var(--text-dim); cursor: pointer; }
.quantum-switch label.active-label { color: var(--purple); }

.toggle-track {
  width: 36px;
  height: 20px;
  background: var(--border);
  border-radius: 10px;
  position: relative;
  cursor: pointer;
  transition: var(--transition);
}

.toggle-track.on { background: var(--purple); }

.toggle-thumb {
  width: 16px;
  height: 16px;
  background: var(--text-bright);
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: var(--transition);
}

.toggle-track.on .toggle-thumb { left: 18px; }

/* ‚îÄ‚îÄ Quantum Callout ‚îÄ‚îÄ */
.instruction-hint {
  text-align: center;
  color: var(--text-dim);
  font-size: 0.85rem;
  font-family: var(--font-sans);
  padding: 0.6rem 1rem;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(to right, var(--bg-surface), rgba(37,99,235,0.03), var(--bg-surface));
  transition: opacity 0.3s, max-height 0.3s;
  max-height: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
}
.instruction-hint .hint-item { display: flex; align-items: center; gap: 0.35rem; }
.instruction-hint .hint-icon { font-size: 1rem; }
.instruction-hint.hidden { opacity: 0; pointer-events: none; max-height: 0; padding: 0; overflow: hidden; }

.quantum-callout {
  display: none;
  background: rgba(124,58,237,0.05);
  border: 1px solid rgba(124,58,237,0.15);
  border-radius: 6px;
  padding: 0.6rem 1rem;
  font-size: 0.7rem;
  color: var(--purple);
  margin: 0 2rem;
}

.quantum-callout.visible { display: block; }

/* ‚îÄ‚îÄ Attack Simulator ‚îÄ‚îÄ */
.attack-list {
  position: absolute;
  top: 0;
  right: 0;
  width: 320px;
  max-height: 100%;
  overflow-y: auto;
  background: var(--bg-surface);
  border-left: 1px solid var(--border);
  padding: 1rem;
  z-index: 10;
  display: none;
}

.attack-list.open { display: block; }

.attack-list h3 {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 0.75rem;
}

.attack-item {
  padding: 0.5rem;
  border: 1px solid transparent;
  border-radius: 6px;
  margin-bottom: 0.3rem;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.75rem;
}

.attack-item:hover { background: var(--bg-overlay); border-color: var(--border); }
.attack-item.selected { background: rgba(220,38,38,0.06); border-color: rgba(220,38,38,0.2); }

.attack-item .attack-name { font-weight: 600; color: var(--text); }
.attack-item .attack-bands { color: var(--text-dim); font-size: 0.65rem; margin-top: 0.15rem; }
.attack-item .attack-coupling { color: var(--red); font-size: 0.6rem; }

/* ‚îÄ‚îÄ Device Info Panel ‚îÄ‚îÄ */
.device-info {
  position: absolute;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.75rem 1.25rem;
  font-size: 0.75rem;
  display: none;
  z-index: 10;
  max-width: 500px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.device-info.visible { display: block; }

.device-info .di-name { font-weight: 600; color: var(--text-bright); margin-bottom: 0.3rem; }
.device-info .di-row { display: flex; gap: 1.5rem; color: var(--text-dim); flex-wrap: wrap; }
.device-info .di-row span { white-space: nowrap; }

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .detail-body { grid-template-columns: 1fr; }
  .detail-tab-panel.active { grid-template-columns: 1fr; }
  .band-name { width: 6rem; }
  header { padding: 0.75rem 1rem; }
  #hourglass-container { padding: 1rem; }
  #freq-panel.open { width: 220px; }
  .attack-list { width: 260px; }
  .detail-tabs { margin: 0 1rem; overflow-x: auto; }
}
</style>
</head>
<body>

<div id="app">
  <header>
    <h1>QIF <span class="version">v6.0</span> Hourglass Architecture <span class="version">7-1-3</span></h1>
    <div class="toolbar" id="toolbar"></div>
  </header>

  <div class="instruction-hint" id="instruction-hint">
    <span class="hint-item"><span class="hint-icon">üëÜ</span> Click any band to explore</span>
    <span class="hint-item"><span class="hint-icon">üì°</span> Select a BCI device to see its attack surface</span>
    <span class="hint-item"><span class="hint-icon">‚öîÔ∏è</span> Simulate attacks across bands</span>
  </div>

  <div class="quantum-callout" id="quantum-callout">
    Quantum Proven Mode ‚Äî Determinacy levels shifted. N7 upgraded to Quantum Indeterminate (Level 7).
    N6 upgraded to Quantum Uncertain (Level 6). No-cloning theorem confirmed at I0.
    QI score provably richer than any classical-only metric for implanted BCIs.
  </div>

  <main>
    <div id="hourglass-container"></div>
    <div id="freq-panel">
      <div class="freq-panel-inner" id="freq-panel-inner"></div>
    </div>
  </main>
</div>

<div id="band-detail"></div>
<div class="tooltip" id="tooltip"></div>

<div class="walkthrough-overlay" id="walkthrough" style="display:none">
  <div class="walkthrough-card">
    <h2>QIF Interactive Hourglass</h2>
    <div class="walkthrough-steps">
      <div class="walkthrough-step">
        <div class="walkthrough-step-num">1</div>
        <div class="walkthrough-step-text"><strong>Click any band</strong> to see its threat profile, brain regions, attack techniques, and severity rating.</div>
      </div>
      <div class="walkthrough-step">
        <div class="walkthrough-step-num">2</div>
        <div class="walkthrough-step-text"><strong>Select a BCI device</strong> from the dropdown to highlight which bands it touches ‚Äî revealing its unique attack surface.</div>
      </div>
      <div class="walkthrough-step">
        <div class="walkthrough-step-num">3</div>
        <div class="walkthrough-step-text"><strong>Attack Simulator</strong> ‚Äî pick a known attack to see which bands it crosses and its coupling mechanism.</div>
      </div>
      <div class="walkthrough-step">
        <div class="walkthrough-step-num">4</div>
        <div class="walkthrough-step-text"><strong>Frequency Spectrum</strong> ‚Äî view neural and synthetic operating frequencies, including restricted/military bands.</div>
      </div>
    </div>
    <div class="walkthrough-actions">
      <button class="walkthrough-skip" id="walkthrough-skip">Don't show again</button>
      <button class="walkthrough-dismiss" id="walkthrough-dismiss">Got it, let's explore</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QIF DATA ‚Äî Inlined from qif-architecture-v4.json + config.py
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const QIF_DATA = {
  bands: [
    {id:"N7",name:"Neocortex",zone:"neural",description:"PFC, M1, S1, V1, A1, Broca, Wernicke, association cortex \u2014 executive function, language, movement, perception",brain_regions:["PFC","ACC","Broca","Wernicke","M1","S1_cortex","V1","A1","PMC","SMA","PPC"],dominant_freq_hz:"13-100 (Beta 13-30, Gamma 30-100)",L_m:[0.04,0.3],determinacy:"Quantum Uncertain",severity:"High",severity_description:"Cognitive impairment, motor paralysis, sensory loss, language disruption",qi_range:[0.3,0.5],hourglass_width:1.0,bci_devices:["Neuralink N1","Blackrock Utah Array","Precision Layer 7","ECoG grids","cortical DBS"]},
    {id:"N6",name:"Limbic System",zone:"neural",description:"Hippocampus, amygdala, insula, ACC, cingulate \u2014 emotion, memory, interoception",brain_regions:["HIPP","BLA","insula","ACC","CeA","cingulate"],dominant_freq_hz:"4-13 (Theta 4-8, Alpha 8-13)",L_m:[0.3,1.0],determinacy:"Chaotic \u2192 Quantum Uncertain",severity:"High",severity_description:"Memory erasure, emotional dysregulation, PTSD trigger, addiction manipulation",qi_range:[0.2,0.4],hourglass_width:0.85,bci_devices:["NeuroPace RNS (depth)","DBS (ANT target)","depth electrodes"]},
    {id:"N5",name:"Basal Ganglia",zone:"neural",description:"Striatum, GPi/GPe, STN, substantia nigra \u2014 motor selection, reward, habit",brain_regions:["striatum","GPi","GPe","STN","substantia_nigra"],dominant_freq_hz:"13-30 (Beta \u2014 pathological oscillations in Parkinson's)",L_m:[0.13,0.3],determinacy:"Chaotic",severity:"High",severity_description:"Movement disorders (Parkinson's, dystonia), reward hijacking, compulsive behavior",qi_range:[0.15,0.35],hourglass_width:0.65,bci_devices:["Medtronic Percept (STN)","Abbott Infinity (GPi)","Boston Scientific Vercise"]},
    {id:"N4",name:"Diencephalon",zone:"neural",description:"Thalamus, hypothalamus \u2014 sensory gating, consciousness relay, autonomic regulation",brain_regions:["thalamus","hypothalamus","VIM","ANT","CM-Pf"],dominant_freq_hz:"4-13 (Alpha spindles, Theta)",L_m:[0.3,1.0],determinacy:"Stochastic \u2192 Chaotic",severity:"CRITICAL",severity_description:"Consciousness disruption, sensory blackout, sleep-wake cycle attack, thermal regulation failure",qi_range:[0.1,0.3],hourglass_width:0.5,bci_devices:["DBS (VIM for tremor)","thalamic depth electrodes","ANT stimulation for epilepsy"]},
    {id:"N3",name:"Cerebellum",zone:"neural",description:"Cerebellar cortex, deep nuclei, vermis \u2014 motor coordination, timing, learning",brain_regions:["cerebellar_cortex","dentate_nucleus","fastigial_nucleus","vermis"],dominant_freq_hz:"50-100 (Purkinje cell complex spikes)",L_m:[0.04,0.08],determinacy:"Stochastic",severity:"High",severity_description:"Ataxia, coordination loss, speech disruption (dysarthria), motor learning impairment",qi_range:[0.1,0.25],hourglass_width:0.45,bci_devices:["Experimental cerebellar stimulation"]},
    {id:"N2",name:"Brainstem",zone:"neural",description:"Medulla, pons, midbrain, cranial nerve nuclei \u2014 vital functions, arousal, reflexes",brain_regions:["medulla","pons","midbrain","reticular_formation","cranial_nuclei"],dominant_freq_hz:"0.5-4 (Delta, low-frequency rhythmic)",L_m:[1.0,null],determinacy:"Stochastic",severity:"LETHAL",severity_description:"Respiratory arrest, cardiac failure, loss of consciousness, cranial nerve paralysis",qi_range:[0.05,0.15],hourglass_width:0.3,bci_devices:["Vagus nerve stimulators","auditory brainstem implants","DBS (PPN for gait)"]},
    {id:"N1",name:"Spinal Cord",zone:"neural",description:"Cervical, thoracic, lumbar, sacral, cauda equina \u2014 reflexes, peripheral motor/sensory relay",brain_regions:["cervical_cord","thoracic_cord","lumbar_cord","sacral_cord","cauda_equina"],dominant_freq_hz:"Reflex arcs (ms-scale, not oscillatory)",L_m:null,determinacy:"Stochastic",severity:"Severe",severity_description:"Paralysis (quadri/para), bladder/bowel dysfunction, chronic pain, autonomic dysreflexia",qi_range:[0.02,0.1],hourglass_width:0.25,bci_devices:["Spinal cord stimulators (SCS)","InterStim (sacral)","epidural stimulation","ONWARD ARC-IM"]},
    {id:"I0",name:"Neural Interface",zone:"interface",description:"Electrode-tissue boundary, measurement/collapse, quasi-quantum zone",brain_regions:[],dominant_freq_hz:"N/A (boundary)",L_m:null,determinacy:"Quasi-quantum (\u0393D \u2208 (0,1))",severity:"Depends on adjacent N band",severity_description:"Interface degradation, impedance failure, tissue damage, signal corruption",qi_range:[0.01,0.1],hourglass_width:0.2,bci_devices:["All implanted/semi-invasive BCIs"]},
    {id:"S1",name:"Analog / Near-Field",zone:"synthetic",description:"Amplification, filtering, ADC/DAC, near-field EM (0 Hz \u2013 10 kHz)",brain_regions:[],dominant_freq_hz:"0-10 kHz",L_m:[3e4,null],determinacy:"Stochastic (analog noise)",severity:"N/A (synthetic)",severity_description:"Signal corruption, ADC saturation, impedance artifact",qi_range:[0.001,0.01],hourglass_width:0.35,bci_devices:["All BCIs (analog front-end)"]},
    {id:"S2",name:"Digital / Telemetry",zone:"synthetic",description:"Decoding, classification, telemetry, MICS (10 kHz \u2013 1 GHz)",brain_regions:[],dominant_freq_hz:"10 kHz - 1 GHz",L_m:[0.3,3e4],determinacy:"Deterministic",severity:"N/A (synthetic)",severity_description:"Data corruption, BLE exploit, MICS intermodulation, firmware compromise",qi_range:[0.0,0.0],hourglass_width:0.7,bci_devices:["All wireless BCIs (BLE, WiFi, MICS)"]},
    {id:"S3",name:"Radio / Wireless / DE",zone:"synthetic",description:"RF, wireless links, directed energy, application layer (1 GHz+)",brain_regions:[],dominant_freq_hz:"1 GHz+",L_m:[3e-5,0.3],determinacy:"Deterministic",severity:"N/A (synthetic)",severity_description:"RF hijack, directed energy, cloud compromise, supply chain attack",qi_range:[0.0,0.0],hourglass_width:1.0,bci_devices:["BLE/WiFi consumer, satellite links, DE weapons"]},
  ],

  threat_model: [
    // ‚îÄ‚îÄ Classical attacks (v3.1 core) ‚îÄ‚îÄ
    {attack:"Signal injection",bands_str:"I0\u2013N1",band_ids:["I0","N1"],coupling:null,access:null,classical:"Yes",quantum:"Enhanced (coherence metric)",notes:"Inject false signals at electrode-tissue boundary. Classical detection via impedance anomaly. QI coherence metric flags phase/timing inconsistency."},
    {attack:"Neural ransomware",bands_str:"N3",band_ids:["N3","N7","N6"],coupling:null,access:null,classical:"Partial",quantum:"Yes (QI score drop)",notes:"Disrupt or lock neural function via stimulation manipulation. Closed-loop devices (RNS, DBS) most vulnerable. QI detects anomalous coherence collapse."},
    {attack:"Eavesdropping",bands_str:"I0\u2013N1",band_ids:["I0","N1"],coupling:null,access:null,classical:"No",quantum:"Yes (Heisenberg disturbance)",notes:"Passive interception of neural signals at I0. Classically undetectable. Quantum: measurement disturbs state \u2014 detectable via QI anomaly."},
    {attack:"Man-in-the-middle",bands_str:"I0",band_ids:["I0"],coupling:null,access:null,classical:"Partial",quantum:"Yes (no-cloning + Bell test)",notes:"Intercept and modify signals at I0 boundary. No-cloning theorem prevents perfect copy of quantum neural states. Bell test detects entanglement disruption."},
    {attack:"Quantum tunneling exploit",bands_str:"I0\u2013N1",band_ids:["I0","N1"],coupling:null,access:null,classical:"No",quantum:"Yes (tunneling profile anomaly)",notes:"Exploit ion channel quantum tunneling to inject false synaptic events. Detectable via Q_tunnel term anomaly in QI equation."},
    {attack:"Davydov soliton attack",bands_str:"I0\u2013N1",band_ids:["I0","N1"],coupling:null,access:null,classical:"No",quantum:"Yes (tunneling term Q_tunnel)",notes:"Use THz stimulation to trigger Davydov solitons in SNARE protein complexes, causing false neurotransmitter release at I0."},
    {attack:"Identity spoofing",bands_str:"N3\u2013N7",band_ids:["N3","N7","N6"],coupling:null,access:null,classical:"Partial",quantum:"Yes (quantum biometric)",notes:"Replicate user's neural signature to bypass authentication. Classical biometrics partially spoofable. Quantum neural signatures (if proven) are physically unclonable."},
    // ‚îÄ‚îÄ Synthetic / cyber attacks (v3.1 additions) ‚îÄ‚îÄ
    {attack:"BLE/RF side-channel",bands_str:"S1\u2013S2",band_ids:["S1","S2"],coupling:null,access:"PUBLIC",classical:"Yes",quantum:"Enhanced (signal correlation)",notes:"Extract neural data from BLE/RF emissions via timing, power, or EM side-channels. All wireless BCIs vulnerable. Consumer devices (Muse, EMOTIV) transmit unencrypted. QI cross-band correlation detects exfiltration patterns."},
    {attack:"Supply chain compromise",bands_str:"S2\u2013S3",band_ids:["S2","S3"],coupling:null,access:null,classical:"Yes",quantum:"Enhanced (firmware attestation)",notes:"Tamper with BCI hardware/firmware during manufacturing or distribution. Firmware rootkits persist across updates. Affects all device classes. QI-enhanced firmware attestation detects unauthorized modifications."},
    {attack:"Cloud infrastructure attack",bands_str:"S3",band_ids:["S3"],coupling:null,access:"PUBLIC",classical:"Yes",quantum:"Enhanced (QKD for data-in-transit)",notes:"Compromise cloud services processing neural data (EMOTIV Cortex API, Neuralink cloud). Data exfiltration, model poisoning, API manipulation. PQC/QKD protects data in transit."},
    {attack:"Neural data privacy breach",bands_str:"N1\u2013S3",band_ids:["N1","S1","S2","S3"],coupling:null,access:null,classical:"Yes",quantum:"Enhanced (cross-band encryption)",notes:"Unauthorized access to recorded neural data across any band. Harvest raw EEG from consumer devices, decode intent/emotion. GDPR Article 9 (special category data). NSP end-to-end encryption from I0 to cloud."},
    {attack:"Harvest-now-decrypt-later",bands_str:"S3",band_ids:["S3"],coupling:null,access:null,classical:"No",quantum:"Prevented (QKD/PQC)",notes:"Record encrypted BCI traffic now, decrypt when quantum computers arrive (2030-2035). Neural data is permanently sensitive \u2014 can't change your brain like a password. PQC (ML-KEM/Kyber) prevents. 10-20 year implant lifetime > quantum arrival."},
    // ‚îÄ‚îÄ Frequency-domain attacks (v3.2 Entry 28) ‚îÄ‚îÄ
    {attack:"ELF neural entrainment",bands_str:"S1\u2192N4\u2013N7",band_ids:["S1","N4","N5","N6","N7"],coupling:"DIRECT",access:"RESTRICTED",classical:"Yes",quantum:"Enhanced (Dsf anomaly detection)",notes:"3-76 Hz government-restricted. IS neural frequency. Penetrates globally. Direct gamma/alpha/theta cortical entrainment. US Navy operated at 76 Hz (Clam Lake) and 45 Hz (Republic). Russia, China maintain capability."},
    {attack:"Intermodulation (BCI weaponized)",bands_str:"S2\u2192N4\u2013N6",band_ids:["S2","N4","N5","N6"],coupling:"INTERMODULATION",access:"RESTRICTED",classical:"Yes",quantum:"Enhanced (coherence + Dsf)",notes:"UHF-Mil (225-400 MHz) + MICS (402 MHz) = neural-range beat frequency. BCI's own telemetry signal becomes part of the attack. 398 MHz mil + 402 MHz BCI = 4 Hz \u2192 theta \u2192 N4 thalamus. Most dangerous coupling mechanism."},
    {attack:"Pulsed microwave (Frey effect)",bands_str:"S3\u2192N2,N7",band_ids:["S3","N2","N7"],coupling:"ENVELOPE",access:"RESTRICTED",classical:"Yes",quantum:"Enhanced (temporal coherence)",notes:"S-band (2-4 GHz) pulsed microwave. Thermoelastic expansion \u2192 cochlea perceives as sound. 'Havana Syndrome' model. PRF selects neural target: 40 Hz \u2192 N7 gamma, 10 Hz \u2192 N6 alpha, 4 Hz \u2192 N4 theta, 1 Hz \u2192 N2 delta."},
    {attack:"Temporal interference (deep targeting)",bands_str:"S2\u2192N4\u2013N6",band_ids:["S2","N4","N5","N6"],coupling:"TEMPORAL_INTERFERENCE",access:"LICENSED",classical:"Yes",quantum:"Enhanced (beat frequency detection)",notes:"Two kHz+ signals create neural-range beat frequency at tissue intersection. Can target deep brain structures non-invasively. Grossman et al. 2017, Cell. Licensed frequencies \u2014 lower barrier than restricted."},
    {attack:"Envelope modulation (stealth carrier)",bands_str:"S1\u2013S2\u2192any N",band_ids:["S1","S2","N1","N2","N3","N4","N5","N6","N7"],coupling:"ENVELOPE",access:"PUBLIC",classical:"Yes",quantum:"Enhanced (demodulation detection)",notes:"Any carrier frequency modulated at neural frequency. Tissue demodulates the envelope. Stealth: carrier looks normal, attack is in the modulation. Lowest barrier to entry \u2014 PUBLIC access. tACS therapeutic principle weaponized."},
    {attack:"Directed energy (thermal I0 damage)",bands_str:"S3\u2192I0",band_ids:["S3","I0"],coupling:null,access:"CLASSIFIED",classical:"Yes",quantum:"N/A (physical damage, not signal)",notes:"mm-wave/ADS (95 GHz) directed energy. Excites water molecules in top 0.4mm of skin. For surface implants: electrode heating, tissue damage at I0 boundary. Destroys interface integrity. Nation-state only."},
  ],

  bci_device_classes: {
    CONSUMER:{name:"Consumer",channels:"1-16",sampling_hz:"128-256",wireless:"BLE",qi_terms:3},
    CONSUMER_PRO:{name:"Consumer Pro",channels:"5-32",sampling_hz:"128-256",wireless:"BLE/WiFi/USB",qi_terms:"3-4"},
    RESEARCH:{name:"Research",channels:"8-256",sampling_hz:"250-38400",wireless:"WiFi/USB/wired",qi_terms:4},
    CLINICAL:{name:"Clinical",channels:"32-256",sampling_hz:"1000-30000",wireless:"Wired/MICS",qi_terms:"4-5"},
    IMPLANTED:{name:"Implanted",channels:"96-65536",sampling_hz:"20000-30000",wireless:"BLE/MICS/wired",qi_terms:"All 7+"},
    STIMULATION:{name:"Stimulation",channels:"4-16",sampling_hz:"250-1000",wireless:"BLE/MICS/NFC",qi_terms:"4-5"},
    AUDITORY_PROSTHESIS:{name:"Auditory Prosthesis",channels:"12-60+",sampling_hz:"Varies",wireless:"Proprietary RF/BLE",qi_terms:"3-5"},
    OPTICAL:{name:"Optical (fNIRS)",channels:"8-52",sampling_hz:"10-100",wireless:"BLE/WiFi",qi_terms:"3-4"},
  },

  bci_devices: [
    {manufacturer:"InteraXon",device:"Muse 2",channels:4,sampling_hz:256,wireless:"BLE",device_class:"CONSUMER",bands:["N7","N6"]},
    {manufacturer:"NeuroSky",device:"MindWave Mobile 2",channels:1,sampling_hz:512,wireless:"BLE",device_class:"CONSUMER",bands:["N7"]},
    {manufacturer:"EMOTIV",device:"EPOC X",channels:14,sampling_hz:256,wireless:"BLE/USB",device_class:"CONSUMER_PRO",bands:["N7","N6"]},
    {manufacturer:"EMOTIV",device:"EPOC Flex",channels:32,sampling_hz:256,wireless:"BLE/USB",device_class:"CONSUMER_PRO",bands:["N7","N6","N5"]},
    {manufacturer:"Neurosity",device:"Crown",channels:8,sampling_hz:256,wireless:"WiFi",device_class:"CONSUMER_PRO",bands:["N7"]},
    {manufacturer:"OpenBCI",device:"Cyton",channels:8,sampling_hz:250,wireless:"WiFi/USB",device_class:"RESEARCH",bands:["N7","N6"]},
    {manufacturer:"OpenBCI",device:"Cyton + Daisy",channels:16,sampling_hz:125,wireless:"WiFi/USB",device_class:"RESEARCH",bands:["N7","N6","N5"]},
    {manufacturer:"g.tec",device:"g.Nautilus",channels:64,sampling_hz:500,wireless:"Wireless",device_class:"RESEARCH",bands:["N7","N6","N5"]},
    {manufacturer:"g.tec",device:"g.HIamp",channels:256,sampling_hz:38400,wireless:"Wired",device_class:"RESEARCH",bands:["N7","N6","N5","N4"]},
    {manufacturer:"BioSemi",device:"ActiveTwo",channels:256,sampling_hz:16384,wireless:"USB fiber",device_class:"RESEARCH",bands:["N7","N6","N5"]},
    {manufacturer:"Brain Products",device:"actiCHamp Plus",channels:160,sampling_hz:100000,wireless:"USB",device_class:"RESEARCH",bands:["N7","N6","N5","N4"]},
    {manufacturer:"Natus",device:"Xltek",channels:256,sampling_hz:1024,wireless:"Wired",device_class:"CLINICAL",bands:["N7","N6","N5","N4"]},
    {manufacturer:"Ad-Tech Medical",device:"ECoG Grid/Strip",channels:256,sampling_hz:30000,wireless:"Wired",device_class:"CLINICAL",bands:["N7","N6","N5","N4","N3","I0"]},
    {manufacturer:"Neuralink",device:"N1 (PRIME)",channels:1024,sampling_hz:20000,wireless:"BLE",device_class:"IMPLANTED",bands:["N7","I0","S1","S2","S3"]},
    {manufacturer:"Blackrock Neurotech",device:"Utah Array",channels:128,sampling_hz:30000,wireless:"Wired",device_class:"IMPLANTED",bands:["N7","I0","S1"]},
    {manufacturer:"Synchron",device:"Stentrode",channels:16,sampling_hz:1000,wireless:"BLE",device_class:"IMPLANTED",bands:["N7","I0","S1","S2","S3"]},
    {manufacturer:"Precision Neuroscience",device:"Layer 7",channels:1024,sampling_hz:20000,wireless:"Wired",device_class:"IMPLANTED",bands:["N7","N6","I0","S1"]},
    {manufacturer:"Paradromics",device:"Connexus DBI",channels:65536,sampling_hz:30000,wireless:"Wireless",device_class:"IMPLANTED",bands:["N7","I0","S1","S2","S3"]},
    {manufacturer:"Medtronic",device:"Percept PC (DBS)",channels:4,sampling_hz:250,wireless:"BLE",device_class:"STIMULATION",bands:["N5","N4","I0","S1","S2"]},
    {manufacturer:"NeuroPace",device:"RNS System",channels:4,sampling_hz:250,wireless:"NFC",device_class:"STIMULATION",bands:["N7","N6","I0","S1"]},
    {manufacturer:"Medtronic",device:"InterStim X",channels:4,sampling_hz:null,wireless:"BLE",device_class:"STIMULATION",bands:["N1","I0","S1","S2"]},
    {manufacturer:"Cochlear Ltd",device:"Nucleus CI632",channels:22,sampling_hz:null,wireless:"Proprietary RF",device_class:"AUDITORY_PROSTHESIS",bands:["N2","I0","S1","S2"]},
    {manufacturer:"Kernel",device:"Flow (fNIRS)",channels:52,sampling_hz:100,wireless:"USB-C",device_class:"OPTICAL",bands:["N7","N6"]},
    {manufacturer:"Cognixion",device:"ONE / Axon-R",channels:8,sampling_hz:null,wireless:"4G LTE",device_class:"CONSUMER_PRO",bands:["N7","S2","S3"]},
    {manufacturer:"Elemind",device:"Elemind Headband",channels:3,sampling_hz:null,wireless:"BLE",device_class:"CONSUMER",bands:["N7","N6"]},
    {manufacturer:"NeuroXess",device:"Flexible BCI",channels:256,sampling_hz:null,wireless:"Wireless",device_class:"IMPLANTED",bands:["N7","I0","S1","S2"]},
    {manufacturer:"INBRAIN",device:"BCI-Tx (graphene)",channels:null,sampling_hz:null,wireless:"Wireless",device_class:"IMPLANTED",bands:["N7","N5","I0","S1","S2"]},
    {manufacturer:"Battelle",device:"BrainSTORMS (DARPA N3)",channels:null,sampling_hz:null,wireless:"Helmet",device_class:"IMPLANTED",bands:["N7","N6","I0"]},
  ],

  quantum_proof: {
    current: {N7:"Quantum Uncertain",N6:"Chaotic \u2192 QU"},
    post_proof: {N7:"Quantum Indeterminate",N6:"Quantum Uncertain"},
    bands_affected: {
      N7:"Determinacy upgrades. Quantum terms always active.",
      N6:"Determinacy upgrades. Limbic quantum effects confirmed.",
      I0:"MAJOR \u2014 quantum channel confirmed at electrode-tissue boundary.",
    }
  },

  freq_neural: [
    {band:"High gamma",range:"60-100 Hz",mid:80,L:"0.3-5 mm"},
    {band:"Low gamma",range:"30-60 Hz",mid:45,L:"1-10 mm"},
    {band:"Beta",range:"13-30 Hz",mid:21,L:"1-30 cm"},
    {band:"Alpha",range:"8-12 Hz",mid:10,L:"10-20 cm"},
    {band:"Theta",range:"4-8 Hz",mid:6,L:"4-5 cm"},
    {band:"Delta",range:"0.5-4 Hz",mid:2,L:"15-20 cm"},
  ],

  freq_synthetic: [
    {band:"ELF",range:"3-76 Hz",access:"RESTRICTED",attack:true},
    {band:"SLF",range:"30-300 Hz",access:"RESTRICTED",attack:true},
    {band:"VLF",range:"3-30 kHz",access:"RESTRICTED",attack:true},
    {band:"LF",range:"30-300 kHz",access:"RESTRICTED"},
    {band:"MF (AM)",range:"300 kHz-3 MHz",access:"LICENSED"},
    {band:"HF",range:"3-30 MHz",access:"RESTRICTED"},
    {band:"VHF",range:"30-300 MHz",access:"LICENSED"},
    {band:"UHF-Mil",range:"225-400 MHz",access:"RESTRICTED",attack:true},
    {band:"MICS",range:"402-405 MHz",access:"LICENSED"},
    {band:"BLE/WiFi",range:"2.4 GHz",access:"PUBLIC"},
    {band:"S-Band (Frey)",range:"2-4 GHz",access:"RESTRICTED",attack:true},
    {band:"5G mid",range:"3.5-4.2 GHz",access:"LICENSED"},
    {band:"X-Band radar",range:"8-12 GHz",access:"RESTRICTED"},
    {band:"mm-wave",range:"28-39 GHz",access:"LICENSED"},
    {band:"ADS",range:"95 GHz",access:"CLASSIFIED",attack:true},
  ],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getSeverityClass(sev) {
  if (!sev) return 'synthetic';
  const s = sev.toLowerCase();
  if (s === 'lethal') return 'lethal';
  if (s === 'critical') return 'critical';
  if (s === 'high') return 'high';
  if (s === 'severe') return 'severe';
  if (s.includes('synthetic') || s.includes('n/a')) return 'synthetic';
  if (s.includes('depends')) return 'interface';
  return 'high';
}

function getBandColor(band) {
  const colors = {
    lethal: '#dc2626',
    critical: '#ea580c',
    high: '#d97706',
    severe: '#ca8a04',
    synthetic: '#2563eb',
    interface: '#7c3aed',
  };
  return colors[getSeverityClass(band.severity)] || '#2563eb';
}

function formatL(L_m) {
  if (!L_m) return 'N/A';
  const [lo, hi] = L_m;
  const fmt = (v) => {
    if (v === null) return '\u221e';
    if (v >= 1000) return (v/1000).toFixed(0) + ' km';
    if (v >= 1) return v.toFixed(1) + ' m';
    if (v >= 0.01) return (v*100).toFixed(0) + ' cm';
    if (v >= 0.001) return (v*1000).toFixed(1) + ' mm';
    return (v*1e6).toFixed(0) + ' \u03bcm';
  };
  return fmt(lo) + ' \u2013 ' + fmt(hi);
}

function parseBandRange(str) {
  // Parse "I0-N1" or "S1-S2" style ranges into band IDs
  const allIds = QIF_DATA.bands.map(b => b.id);
  const found = [];
  for (const id of allIds) {
    if (str.includes(id)) found.push(id);
  }
  return found;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT: HourglassView
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class HourglassView {
  constructor(containerEl, data) {
    this.el = containerEl;
    this.data = data;
    this.highlightedBands = new Set();
    this.bandEls = {};
    this.onBandClick = null;
    this.onBandHover = null;
    this.onBandLeave = null;
  }

  render() {
    const wrap = document.createElement('div');
    wrap.className = 'hourglass-wrap';

    // Left axis
    const axis = document.createElement('div');
    axis.className = 'axis-label-left';
    axis.innerHTML = `
      <div class="arrow-up">\u2191</div>
      <div class="label-text">INDETERMINISTIC</div>
      <div class="label-text" style="margin-top:0.5rem">DETERMINISTIC</div>
      <div class="arrow-down">\u2193</div>
    `;
    wrap.appendChild(axis);

    // Main column
    const main = document.createElement('div');
    main.className = 'hourglass-main';

    // Neural (top) ‚Üí I0 (middle) ‚Üí Synthetic (bottom) = brain-down layout
    const bands = [...this.data.bands];
    let prevZone = null;

    for (const band of bands) {
      // Zone separator
      if (band.zone !== prevZone) {
        if (prevZone !== null) {
          const sep = document.createElement('div');
          sep.className = 'zone-separator';
          const zoneName = band.zone === 'interface' ? 'I0 \u2014 Interface Bottleneck' :
                          band.zone === 'synthetic' ? 'Synthetic Domain' : 'Neural Domain';
          sep.innerHTML = `<div class="line"></div><span class="zone-label">${zoneName}</span><div class="line"></div>`;
          main.appendChild(sep);
        } else {
          const sep = document.createElement('div');
          sep.className = 'zone-separator';
          sep.innerHTML = `<div class="line"></div><span class="zone-label">Neural Domain</span><div class="line"></div>`;
          main.appendChild(sep);
        }
        prevZone = band.zone;
      }

      const row = document.createElement('div');
      row.className = 'band-row';
      row.dataset.bandId = band.id;

      const idEl = document.createElement('div');
      idEl.className = 'band-id';
      idEl.textContent = band.id;

      const barContainer = document.createElement('div');
      barContainer.className = 'band-bar-container';

      const bar = document.createElement('div');
      bar.className = 'band-bar';
      bar.style.width = (band.hourglass_width * 100) + '%';
      bar.style.backgroundColor = getBandColor(band);
      bar.style.color = getBandColor(band);
      barContainer.appendChild(bar);

      const nameEl = document.createElement('div');
      nameEl.className = 'band-name';
      nameEl.textContent = band.name;

      row.appendChild(idEl);
      row.appendChild(barContainer);
      row.appendChild(nameEl);

      row.addEventListener('click', () => this.onBandClick?.(band));
      row.addEventListener('mouseenter', (e) => this.onBandHover?.(band, e));
      row.addEventListener('mouseleave', () => this.onBandLeave?.(band));

      this.bandEls[band.id] = { row, bar };
      main.appendChild(row);
    }

    // X-axis label
    const xAxis = document.createElement('div');
    xAxis.className = 'x-axis-label';
    xAxis.innerHTML = `
      <div class="primary">\u2190 ATTACK SURFACE \u2192</div>
      <div class="secondary">(state space)</div>
    `;
    main.appendChild(xAxis);

    wrap.appendChild(main);
    this.el.appendChild(wrap);
  }

  highlightBands(bandIds, color) {
    // Reset all
    for (const id of Object.keys(this.bandEls)) {
      const {bar} = this.bandEls[id];
      bar.classList.remove('pulse');
      bar.style.opacity = bandIds.length > 0 ? '0.25' : '1';
    }
    // Highlight selected
    for (const id of bandIds) {
      if (this.bandEls[id]) {
        const {bar} = this.bandEls[id];
        bar.style.opacity = '1';
        bar.classList.add('pulse');
        if (color) bar.style.backgroundColor = color;
      }
    }
    this.highlightedBands = new Set(bandIds);
  }

  clearHighlights() {
    for (const id of Object.keys(this.bandEls)) {
      const band = this.data.bands.find(b => b.id === id);
      const {bar} = this.bandEls[id];
      bar.classList.remove('pulse');
      bar.style.opacity = '1';
      bar.style.backgroundColor = getBandColor(band);
    }
    this.highlightedBands.clear();
  }

  updateDeterminacy(isQuantumProven) {
    const qp = this.data.quantum_proof;
    for (const band of this.data.bands) {
      // No visual change needed on hourglass itself for now
      // Detail view handles the text changes
    }
  }

  destroy() {
    this.el.innerHTML = '';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT: BandDetailView
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class BandDetailView {
  constructor(containerEl, data) {
    this.el = containerEl;
    this.data = data;
    this.quantumProven = false;
    this.registrar = null;
  }

  show(band) {
    const sevClass = getSeverityClass(band.severity);
    const det = this.quantumProven && this.data.quantum_proof.post_proof[band.id]
      ? this.data.quantum_proof.post_proof[band.id]
      : band.determinacy;

    const attacks = this.data.threat_model.filter(a => a.band_ids.includes(band.id));
    const devices = this.data.bci_devices.filter(d => d.bands.includes(band.id));

    // Registrar-sourced data
    const techniques = this.registrar?.techniques?.filter(t => t.band_ids?.includes(band.id)) || [];
    const therapeutics = techniques.filter(t => t.tara?.clinical?.therapeutic_analog);
    const dsmTechniques = techniques.filter(t => t.tara?.dsm5?.primary?.length > 0);
    const bandProfile = this.registrar?.dsm5_spec?.band_profiles?.[band.id];
    const clusters = this.registrar?.dsm5_spec?.diagnostic_clusters || {};
    const bridge = this.registrar?.dsm5_spec?.niss_dsm_bridge || {};

    // Count unique DSM codes across all techniques for this band
    const allDsmCodes = new Set();
    techniques.forEach(t => {
      (t.tara?.dsm5?.primary || []).forEach(c => allDsmCodes.add(c.code));
      (t.tara?.dsm5?.secondary || []).forEach(c => allDsmCodes.add(c.code));
    });

    const hasTherapeutic = therapeutics.length > 0;
    const hasDsm = allDsmCodes.size > 0 || bandProfile;

    this.el.innerHTML = `
      <div class="detail-header">
        <button class="back-btn" id="detail-back">\u2190 Back</button>
        <div>
          <div class="detail-title">${band.id} \u2014 ${band.name}
            <span class="severity-badge ${sevClass}">${band.severity}</span>
            ${this.quantumProven && this.data.quantum_proof.bands_affected[band.id]
              ? '<span class="severity-badge" style="background:rgba(124,58,237,0.08);color:var(--purple);border:1px solid rgba(124,58,237,0.2);">QUANTUM</span>'
              : ''}
          </div>
          <div class="detail-subtitle">${band.description}</div>
        </div>
      </div>
      <div class="detail-tabs">
        <button class="detail-tab active" data-tab="security">Security <span class="tab-count">${attacks.length}</span></button>
        ${hasTherapeutic ? `<button class="detail-tab" data-tab="therapeutic">Therapeutic <span class="tab-count">${therapeutics.length}</span></button>` : ''}
        ${hasDsm ? `<button class="detail-tab" data-tab="dsm5">DSM-5 <span class="tab-count">${allDsmCodes.size}</span></button>` : ''}
      </div>
      <div class="detail-tab-panel active" data-panel="security">
        <div class="detail-section">
          <h3>Physics</h3>
          <dl class="detail-kv">
            <dt>Frequency</dt><dd>${band.dominant_freq_hz}</dd>
            <dt>Wavelength (L)</dt><dd>${formatL(band.L_m)}</dd>
            <dt>Determinacy</dt><dd>${det}</dd>
            <dt>QI Range</dt><dd>${band.qi_range[0].toFixed(2)} \u2013 ${band.qi_range[1].toFixed(2)}</dd>
            <dt>State Space Width</dt><dd>${(band.hourglass_width * 100).toFixed(0)}%</dd>
          </dl>
          ${this.quantumProven && this.data.quantum_proof.bands_affected[band.id]
            ? `<div style="margin-top:0.75rem;padding:0.5rem;background:rgba(124,58,237,0.05);border:1px solid rgba(124,58,237,0.15);border-radius:4px;font-size:0.75rem;color:var(--purple);">
                Quantum Proof Impact: ${this.data.quantum_proof.bands_affected[band.id]}
               </div>`
            : ''}
        </div>
        <div class="detail-section">
          <h3>Brain Regions (${band.brain_regions.length})</h3>
          ${band.brain_regions.length > 0
            ? `<ul>${band.brain_regions.map(r => `<li>${r}</li>`).join('')}</ul>`
            : `<div style="color:var(--text-dim);font-size:0.8rem;">No brain regions (${band.zone} zone)</div>`}
        </div>
        <div class="detail-section">
          <h3>BCI Devices Targeting This Band (${devices.length})</h3>
          ${devices.length > 0
            ? `<ul>${devices.map(d => `<li>${d.manufacturer} ${d.device}${d.channels ? ' ('+d.channels+'ch)' : ''}</li>`).join('')}</ul>`
            : `<div style="color:var(--text-dim);font-size:0.8rem;">Band-level: ${band.bci_devices.join(', ')}</div>`}
        </div>
        <div class="detail-section">
          <h3>Attack Vectors (${attacks.length})</h3>
          ${attacks.map(a => `
            <div class="detail-attack-row">
              <div class="detail-attack-name">${a.attack}</div>
              <div class="detail-attack-meta">
                Bands: ${a.bands_str}
                ${a.coupling ? ' \u00b7 Coupling: <strong>' + a.coupling + '</strong>' : ''}
                ${a.access ? ' \u00b7 Access: <strong>' + a.access + '</strong>' : ''}
              </div>
              <div class="detail-attack-meta">
                Classical detection: <span style="color:${a.classical === 'Yes' ? 'var(--green)' : a.classical === 'Partial' ? 'var(--orange)' : 'var(--red)'}">${a.classical || 'N/A'}</span>
                \u00b7 Quantum detection: <span style="color:var(--purple)">${a.quantum || 'N/A'}</span>
              </div>
              ${a.notes ? `<div class="detail-attack-meta" style="color:var(--text);margin-top:0.2rem;">${a.notes}</div>` : ''}
            </div>
          `).join('')}
        </div>
        <div class="detail-section full-width">
          <h3>Severity Detail</h3>
          <div style="font-size:0.85rem;color:var(--text);">${band.severity_description}</div>
        </div>
      </div>
      ${hasTherapeutic ? `
      <div class="detail-tab-panel" data-panel="therapeutic">
        <div class="detail-section detail-therapeutic full-width">
          <h3>Therapeutic Analogs (${therapeutics.length})</h3>
          ${therapeutics.map(t => {
            const c = t.tara.clinical;
            const fdaClass = c.fda_status ? 'fda-' + c.fda_status : 'fda-none';
            return `
            <div class="therapeutic-card">
              <div class="tc-name">${c.therapeutic_analog}</div>
              <div class="tc-attack">${t.id}: ${t.attack}</div>
              <div>
                <span class="therapeutic-tag ${fdaClass}">FDA: ${c.fda_status || 'none'}</span>
                <span class="therapeutic-tag evidence">Evidence: ${c.evidence_level || 'N/A'}</span>
              </div>
              <div style="margin-top:0.35rem;">
                ${(c.conditions || []).map(cond => `<span class="therapeutic-tag">${cond}</span>`).join('')}
              </div>
              ${c.safe_parameters ? `<div class="tc-params">${c.safe_parameters}</div>` : ''}
              ${c.sources?.length ? `<div style="margin-top:0.3rem;font-size:0.65rem;color:var(--text-dim);">Sources: ${c.sources.join('; ')}</div>` : ''}
            </div>`;
          }).join('')}
        </div>
      </div>
      ` : ''}
      ${hasDsm ? `
      <div class="detail-tab-panel" data-panel="dsm5">
        ${bandProfile ? `
        <div class="detail-section detail-dsm5">
          <h3>Band Profile \u2014 ${band.id}</h3>
          <div class="dsm-pathway">
            <span>${(bandProfile.structures || []).join(', ')}</span>
            <span class="arrow">\u2192</span>
            <span>${(bandProfile.functions || []).join(', ')}</span>
          </div>
          <div style="margin-top:0.5rem;">
            <div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:0.3rem;">PRIMARY CODES</div>
            ${(bandProfile.primary_codes || []).map(c => `<span class="dsm-code-badge">${c}</span>`).join('')}
          </div>
          ${bandProfile.secondary_codes?.length ? `
          <div style="margin-top:0.4rem;">
            <div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:0.3rem;">SECONDARY CODES</div>
            ${bandProfile.secondary_codes.map(c => `<span class="dsm-code-badge secondary">${c}</span>`).join('')}
          </div>` : ''}
        </div>
        ` : `
        <div class="detail-section detail-dsm5">
          <h3>Band Profile \u2014 ${band.id}</h3>
          <div style="color:var(--text-dim);font-size:0.8rem;">No DSM-5 band profile for ${band.zone} zone bands</div>
        </div>
        `}
        <div class="detail-section detail-dsm5">
          <h3>Diagnostic Clusters</h3>
          ${Object.entries(clusters).map(([key, cl]) => {
            const bandHasCluster = dsmTechniques.some(t => t.tara?.dsm5?.cluster === key);
            if (!bandHasCluster && !bandProfile) return '';
            return `<span class="dsm-cluster-badge" style="background:${cl.color}22;color:${cl.color};border:1px solid ${cl.color}44;">${cl.label}</span>`;
          }).join('')}
          ${!dsmTechniques.length && !bandProfile ? '<div style="color:var(--text-dim);font-size:0.8rem;">No cluster assignments</div>' : ''}
        </div>
        ${dsmTechniques.length > 0 ? `
        <div class="detail-section detail-dsm5 full-width">
          <h3>Technique DSM-5 Mappings (${dsmTechniques.length})</h3>
          ${dsmTechniques.map(t => {
            const d5 = t.tara.dsm5;
            const cl = clusters[d5.cluster];
            return `
            <div class="dsm-technique-row">
              <div class="dt-name">${t.id}: ${t.attack}</div>
              <div class="dt-meta">
                Risk: <strong>${d5.risk_class || 'N/A'}</strong>
                ${cl ? ` \u00b7 Cluster: <span style="color:${cl.color}">${cl.label}</span>` : ''}
                ${d5.niss_correlation ? ` \u00b7 NISS: ${d5.niss_correlation}` : ''}
              </div>
              <div style="margin-top:0.25rem;">
                ${(d5.primary || []).map(c => `<span class="dsm-code-badge" title="${c.name}">${c.code}</span>`).join('')}
                ${(d5.secondary || []).map(c => `<span class="dsm-code-badge secondary" title="${c.name}">${c.code}</span>`).join('')}
              </div>
              ${d5.pathway ? `<div class="dt-meta" style="margin-top:0.2rem;">${d5.pathway}</div>` : ''}
            </div>`;
          }).join('')}
        </div>
        ` : ''}
        <div class="detail-section detail-dsm5 full-width">
          <h3>NISS \u2194 DSM-5 Bridge</h3>
          <table class="niss-bridge-table">
            <thead><tr><th>NISS Metric</th><th>Risk Domain</th><th>Primary Clusters</th><th>DSM Chapters</th></tr></thead>
            <tbody>
              ${Object.entries(bridge).map(([metric, b]) => `
                <tr>
                  <td><strong>${metric}</strong></td>
                  <td>${b.risk_domain}</td>
                  <td>${(b.primary_clusters || []).map(c => {
                    const cl = clusters[c];
                    return cl ? `<span style="color:${cl.color}">${cl.label}</span>` : c;
                  }).join(', ')}</td>
                  <td style="font-size:0.7rem;">${(b.dsm_chapters || []).join(', ')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
      ` : ''}
    `;

    this.el.classList.add('visible');
    document.getElementById('detail-back').addEventListener('click', () => this.hide());
    document.addEventListener('keydown', this._escHandler = (e) => {
      if (e.key === 'Escape') this.hide();
    });

    // Tab switching
    this.el.querySelectorAll('.detail-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetPanel = tab.dataset.tab;
        this.el.querySelectorAll('.detail-tab').forEach(t => {
          t.classList.remove('active', 'active-green', 'active-amber');
        });
        this.el.querySelectorAll('.detail-tab-panel').forEach(p => p.classList.remove('active'));
        if (targetPanel === 'therapeutic') tab.classList.add('active-green');
        else if (targetPanel === 'dsm5') tab.classList.add('active-amber');
        else tab.classList.add('active');
        const panel = this.el.querySelector(`[data-panel="${targetPanel}"]`);
        if (panel) panel.classList.add('active');
      });
    });
  }

  hide() {
    this.el.classList.remove('visible');
    setTimeout(() => { this.el.innerHTML = ''; }, 300);
    if (this._escHandler) document.removeEventListener('keydown', this._escHandler);
  }

  destroy() {
    this.hide();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT: AttackSimulator
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class AttackSimulator {
  constructor(containerEl, data) {
    this.el = containerEl;
    this.data = data;
    this.listEl = null;
    this.selectedAttack = null;
    this.onAttackSelect = null;
    this.isOpen = false;
  }

  render() {
    this.listEl = document.createElement('div');
    this.listEl.className = 'attack-list';
    this.listEl.innerHTML = `<h3>Attack Simulator</h3>`;

    for (const atk of this.data.threat_model) {
      const item = document.createElement('div');
      item.className = 'attack-item';
      item.innerHTML = `
        <div class="attack-name">${atk.attack}</div>
        <div class="attack-bands">${atk.bands_str}</div>
        ${atk.coupling ? `<div class="attack-coupling">${atk.coupling}${atk.access ? ' \u00b7 ' + atk.access : ''}</div>` : ''}
      `;
      item.addEventListener('click', () => {
        if (this.selectedAttack === atk) {
          this.selectedAttack = null;
          item.classList.remove('selected');
          this.onAttackSelect?.(null);
        } else {
          this.listEl.querySelectorAll('.attack-item').forEach(i => i.classList.remove('selected'));
          this.selectedAttack = atk;
          item.classList.add('selected');
          this.onAttackSelect?.(atk);
        }
      });
      this.listEl.appendChild(item);
    }

    this.el.appendChild(this.listEl);
  }

  toggle() {
    this.isOpen = !this.isOpen;
    this.listEl.classList.toggle('open', this.isOpen);
    if (!this.isOpen) {
      this.selectedAttack = null;
      this.listEl.querySelectorAll('.attack-item').forEach(i => i.classList.remove('selected'));
      this.onAttackSelect?.(null);
    }
  }

  close() {
    this.isOpen = false;
    this.listEl?.classList.remove('open');
  }

  destroy() {
    this.listEl?.remove();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT: DeviceOverlay
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class DeviceOverlay {
  constructor(data) {
    this.data = data;
    this.selectedDevice = null;
    this.onDeviceSelect = null;
    this.infoEl = null;
  }

  createSelect() {
    const sel = document.createElement('select');
    sel.className = 'toolbar-select';
    sel.innerHTML = '<option value="">Select BCI Device...</option>';

    // Group by class
    const groups = {};
    for (const d of this.data.bci_devices) {
      const cls = d.device_class;
      if (!groups[cls]) groups[cls] = [];
      groups[cls].push(d);
    }

    for (const [cls, devices] of Object.entries(groups)) {
      const group = document.createElement('optgroup');
      group.label = this.data.bci_device_classes[cls]?.name || cls;
      for (const d of devices) {
        const opt = document.createElement('option');
        opt.value = d.device;
        opt.textContent = `${d.manufacturer} ${d.device}`;
        group.appendChild(opt);
      }
      sel.appendChild(group);
    }

    sel.addEventListener('change', () => {
      const dev = this.data.bci_devices.find(d => d.device === sel.value);
      this.selectedDevice = dev || null;
      this.onDeviceSelect?.(dev);
      this.showInfo(dev);
    });

    return sel;
  }

  showInfo(device) {
    if (!this.infoEl) {
      this.infoEl = document.createElement('div');
      this.infoEl.className = 'device-info';
      document.getElementById('hourglass-container').appendChild(this.infoEl);
    }

    if (!device) {
      this.infoEl.classList.remove('visible');
      return;
    }

    const cls = this.data.bci_device_classes[device.device_class];
    this.infoEl.innerHTML = `
      <div class="di-name">${device.manufacturer} ${device.device}</div>
      <div class="di-row">
        <span>${device.channels ? device.channels + ' ch' : 'N/A ch'}</span>
        <span>${device.sampling_hz ? device.sampling_hz + ' Hz' : ''}</span>
        <span>${device.wireless || ''}</span>
        <span>${cls?.name || device.device_class}</span>
        <span>QI terms: ${cls?.qi_terms || '?'}</span>
      </div>
    `;
    this.infoEl.classList.add('visible');
  }

  destroy() {
    this.infoEl?.remove();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT: QuantumToggle
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class QuantumToggle {
  constructor() {
    this.isProven = false;
    this.onChange = null;
  }

  createEl() {
    const wrap = document.createElement('div');
    wrap.className = 'quantum-switch';

    const labelCurrent = document.createElement('label');
    labelCurrent.textContent = 'v4.0';
    labelCurrent.className = 'active-label';

    const track = document.createElement('div');
    track.className = 'toggle-track';
    const thumb = document.createElement('div');
    thumb.className = 'toggle-thumb';
    track.appendChild(thumb);

    const labelQ = document.createElement('label');
    labelQ.textContent = 'Quantum';

    track.addEventListener('click', () => {
      this.isProven = !this.isProven;
      track.classList.toggle('on', this.isProven);
      labelCurrent.className = this.isProven ? '' : 'active-label';
      labelQ.className = this.isProven ? 'active-label' : '';
      this.onChange?.(this.isProven);
    });

    wrap.appendChild(labelCurrent);
    wrap.appendChild(track);
    wrap.appendChild(labelQ);
    return wrap;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT: FrequencySpectrum
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class FrequencySpectrum {
  constructor(containerEl, data) {
    this.el = containerEl;
    this.data = data;
    this.isOpen = false;
  }

  render() {
    let html = '<h3>Frequency Spectrum</h3>';

    html += '<div class="freq-section-title">Neural Oscillations</div>';
    html += '<div class="freq-ruler">';
    for (const f of this.data.freq_neural) {
      html += `<div class="freq-entry neural">
        <span class="freq-name">${f.band}</span>
        <span class="freq-range">${f.range}</span>
      </div>`;
    }
    html += '</div>';

    html += '<div class="freq-section-title">Synthetic / RF Allocations</div>';
    html += '<div class="freq-ruler">';
    for (const f of this.data.freq_synthetic) {
      const cls = ['freq-entry', 'synthetic'];
      if (f.attack) cls.push('attack');
      if (f.access === 'RESTRICTED' || f.access === 'CLASSIFIED') cls.push('restricted');
      html += `<div class="${cls.join(' ')}">
        <span class="freq-name">${f.band}${f.attack ? ' \u26a0' : ''}${f.access === 'RESTRICTED' ? ' \ud83d\udd12' : ''}${f.access === 'CLASSIFIED' ? ' \u2588' : ''}</span>
        <span class="freq-range">${f.range}</span>
      </div>`;
    }
    html += '</div>';

    html += `<div style="margin-top:1rem;font-size:0.6rem;color:var(--text-dim);">
      <span style="color:var(--red);">\u26a0</span> Attack vector &nbsp;
      <span>\ud83d\udd12</span> Restricted &nbsp;
      <span>\u2588</span> Classified
    </div>`;

    this.el.innerHTML = html;
  }

  toggle() {
    this.isOpen = !this.isOpen;
    document.getElementById('freq-panel').classList.toggle('open', this.isOpen);
  }

  close() {
    this.isOpen = false;
    document.getElementById('freq-panel').classList.remove('open');
  }

  destroy() {
    this.el.innerHTML = '';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOOLTIP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class Tooltip {
  constructor() {
    this.el = document.getElementById('tooltip');
  }

  show(band, event, registrar) {
    const det = band.determinacy;
    const freq = band.dominant_freq_hz;
    const L = formatL(band.L_m);

    // Count therapeutic analogs and DSM codes from registrar
    let taraHint = '';
    if (registrar) {
      const techs = registrar.techniques?.filter(t => t.band_ids?.includes(band.id)) || [];
      const therapeuticCount = techs.filter(t => t.tara?.clinical?.therapeutic_analog).length;
      const dsmCodes = new Set();
      techs.forEach(t => {
        (t.tara?.dsm5?.primary || []).forEach(c => dsmCodes.add(c.code));
        (t.tara?.dsm5?.secondary || []).forEach(c => dsmCodes.add(c.code));
      });
      if (therapeuticCount > 0 || dsmCodes.size > 0) {
        const parts = [];
        if (therapeuticCount > 0) parts.push(therapeuticCount + ' therapeutic analog' + (therapeuticCount !== 1 ? 's' : ''));
        if (dsmCodes.size > 0) parts.push(dsmCodes.size + ' DSM-5 code' + (dsmCodes.size !== 1 ? 's' : ''));
        taraHint = `<div class="tt-row"><span class="tt-label">TARA</span><span class="tt-value">${parts.join(' | ')}</span></div>`;
      }
    }

    this.el.innerHTML = `
      <div class="tt-header">${band.id} \u2014 ${band.name}</div>
      <div class="tt-row"><span class="tt-label">f</span><span class="tt-value">${freq}</span></div>
      <div class="tt-row"><span class="tt-label">L</span><span class="tt-value">${L}</span></div>
      <div class="tt-row"><span class="tt-label">Severity</span><span class="tt-value">${band.severity}</span></div>
      <div class="tt-row"><span class="tt-label">Determinacy</span><span class="tt-value">${det}</span></div>
      ${taraHint}
      <div class="tt-hint">\u25b8 Click for full detail</div>
    `;

    const x = event.clientX + 15;
    const y = event.clientY - 10;
    this.el.style.left = Math.min(x, window.innerWidth - 320) + 'px';
    this.el.style.top = Math.min(y, window.innerHeight - 200) + 'px';
    this.el.classList.add('visible');
  }

  hide() {
    this.el.classList.remove('visible');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP ‚Äî Wire everything together
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

(function init() {
  const container = document.getElementById('hourglass-container');
  const toolbar = document.getElementById('toolbar');
  const detailEl = document.getElementById('band-detail');
  const freqPanelInner = document.getElementById('freq-panel-inner');
  const calloutEl = document.getElementById('quantum-callout');

  // Fetch TARA registrar for therapeutic/DSM-5 data
  let registrarData = null;
  fetch('/data/qtara-registrar.json')
    .then(r => r.json())
    .then(d => { registrarData = d; })
    .catch(() => {}); // Graceful fallback ‚Äî security view still works

  // Instantiate components
  const hourglass = new HourglassView(container, QIF_DATA);
  const detail = new BandDetailView(detailEl, QIF_DATA);
  const attackSim = new AttackSimulator(container, QIF_DATA);
  const deviceOverlay = new DeviceOverlay(QIF_DATA);
  const quantumToggle = new QuantumToggle();
  const freqSpectrum = new FrequencySpectrum(freqPanelInner, QIF_DATA);
  const tooltip = new Tooltip();

  // Render main view
  hourglass.render();
  attackSim.render();
  freqSpectrum.render();

  // ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ

  // ‚îÄ‚îÄ Device group (most prominent) ‚îÄ‚îÄ
  const deviceGroup = document.createElement('div');
  deviceGroup.className = 'toolbar-group';
  const deviceLabel = document.createElement('span');
  deviceLabel.className = 'toolbar-group-label';
  deviceLabel.textContent = 'Device';
  const deviceSelect = deviceOverlay.createSelect();
  deviceGroup.appendChild(deviceLabel);
  deviceGroup.appendChild(deviceSelect);

  // ‚îÄ‚îÄ Tools group ‚îÄ‚îÄ
  const attackBtn = document.createElement('button');
  attackBtn.className = 'toolbar-btn';
  attackBtn.innerHTML = '<span class="btn-icon">‚öîÔ∏è</span> Attacks';
  attackBtn.title = 'Simulate attack paths across QIF bands';
  attackBtn.addEventListener('click', () => {
    attackSim.toggle();
    attackBtn.classList.toggle('active', attackSim.isOpen);
    if (!attackSim.isOpen) hourglass.clearHighlights();
  });

  const freqBtn = document.createElement('button');
  freqBtn.className = 'toolbar-btn';
  freqBtn.innerHTML = '<span class="btn-icon">üìä</span> Spectrum';
  freqBtn.title = 'View operating frequencies for each QIF band';
  freqBtn.addEventListener('click', () => {
    freqSpectrum.toggle();
    freqBtn.classList.toggle('active', freqSpectrum.isOpen);
  });

  const qToggleEl = quantumToggle.createEl();

  // ‚îÄ‚îÄ Help button ‚îÄ‚îÄ
  const helpBtn = document.createElement('button');
  helpBtn.className = 'toolbar-btn';
  helpBtn.innerHTML = '<span class="btn-icon">?</span>';
  helpBtn.title = 'Show walkthrough';
  helpBtn.style.padding = '0.45rem 0.6rem';
  helpBtn.addEventListener('click', () => showWalkthrough());

  toolbar.appendChild(deviceGroup);
  toolbar.appendChild(attackBtn);
  toolbar.appendChild(freqBtn);
  toolbar.appendChild(qToggleEl);
  toolbar.appendChild(helpBtn);

  // ‚îÄ‚îÄ Event wiring ‚îÄ‚îÄ

  const hint = document.getElementById('instruction-hint');

  // Device select ‚Üí hide hint
  deviceSelect.addEventListener('change', () => hint?.classList.add('hidden'));

  // Band click ‚Üí detail view
  hourglass.onBandClick = (band) => {
    hint?.classList.add('hidden');
    detail.quantumProven = quantumToggle.isProven;
    detail.registrar = registrarData;
    detail.show(band);
    tooltip.hide();
  };

  // Band hover ‚Üí tooltip
  hourglass.onBandHover = (band, e) => {
    tooltip.show(band, e, registrarData);
  };

  hourglass.onBandLeave = () => {
    tooltip.hide();
  };

  // Track mouse for tooltip repositioning
  document.addEventListener('mousemove', (e) => {
    if (tooltip.el.classList.contains('visible')) {
      const x = e.clientX + 15;
      const y = e.clientY - 10;
      tooltip.el.style.left = Math.min(x, window.innerWidth - 320) + 'px';
      tooltip.el.style.top = Math.min(y, window.innerHeight - 200) + 'px';
    }
  });

  // Attack select ‚Üí highlight bands
  attackSim.onAttackSelect = (atk) => {
    if (atk) {
      hourglass.highlightBands(atk.band_ids, '#ff4444');
    } else {
      hourglass.clearHighlights();
    }
  };

  // Device select ‚Üí highlight bands
  deviceOverlay.onDeviceSelect = (dev) => {
    if (dev) {
      hourglass.highlightBands(dev.bands, '#58a6ff');
    } else {
      hourglass.clearHighlights();
    }
  };

  // Quantum toggle
  quantumToggle.onChange = (isProven) => {
    calloutEl.classList.toggle('visible', isProven);
    detail.quantumProven = isProven;
  };

  // ‚îÄ‚îÄ Walkthrough ‚îÄ‚îÄ
  function showWalkthrough() {
    document.getElementById('walkthrough').style.display = 'flex';
  }

  function hideWalkthrough(remember) {
    document.getElementById('walkthrough').style.display = 'none';
    if (remember) {
      try { localStorage.setItem('qif-walkthrough-dismissed', '1'); } catch(e) {}
    }
  }

  document.getElementById('walkthrough-dismiss').addEventListener('click', () => hideWalkthrough(false));
  document.getElementById('walkthrough-skip').addEventListener('click', () => hideWalkthrough(true));
  document.getElementById('walkthrough').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) hideWalkthrough(false);
  });

  // ‚îÄ‚îÄ Hash navigation ‚Äî open band from URL hash (e.g. #N7) ‚îÄ‚îÄ
  function handleHash() {
    const hash = window.location.hash.replace('#', '');
    if (!hash) return false;
    const band = QIF_DATA.bands.find(b => b.id === hash);
    if (band) {
      hint?.classList.add('hidden');
      detail.quantumProven = quantumToggle.isProven;
      detail.registrar = registrarData;
      // Small delay to let registrar data load
      setTimeout(() => {
        detail.registrar = registrarData;
        detail.show(band);
      }, 300);
      return true;
    }
    return false;
  }

  window.addEventListener('hashchange', handleHash);

  // On load: if hash present, open that band; otherwise show walkthrough
  const hashHandled = handleHash();
  if (!hashHandled) {
    try {
      if (!localStorage.getItem('qif-walkthrough-dismissed')) {
        showWalkthrough();
      }
    } catch(e) { showWalkthrough(); }
  }
})();
</script>
</body>
</html>
