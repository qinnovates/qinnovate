---
import { getTaraStats } from '../../lib/threat-data';

const tara = getTaraStats();
const total = tara.total;
const circumference = 2 * Math.PI * 70; // ≈ 439.82

const segments = [
  { label: 'Confirmed', count: tara.dualUse.confirmed, color: '#10b981' },
  { label: 'Probable', count: tara.dualUse.probable, color: '#06b6d4' },
  { label: 'Possible', count: tara.dualUse.possible, color: '#8b5cf6' },
  { label: 'Silicon Only', count: tara.dualUse.silicon_only, color: '#94a3b8' },
];

// Calculate dasharray lengths and cumulative offsets
let cumulativeOffset = 0;
const arcs = segments.map((seg) => {
  const length = (seg.count / total) * circumference;
  const offset = cumulativeOffset;
  cumulativeOffset += length;
  return { ...seg, length, offset };
});

const therapeuticCount = tara.dualUse.confirmed + tara.dualUse.probable + tara.dualUse.possible;
const therapeuticPct = ((therapeuticCount / total) * 100).toFixed(1);
---

<div class="glass rounded-xl p-6">
  <h3 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-1 text-[var(--color-text-primary)]">
    Dual-Use Classification
  </h3>
  <p class="text-xs text-[var(--color-text-faint)] mb-5">
    Every technique that can harm a brain can also heal one
  </p>

  {/* Donut chart */}
  <div class="flex justify-center">
    <svg viewBox="0 0 200 200" class="w-48 h-48" role="img" aria-label={`Dual-use donut chart showing ${therapeuticCount} of ${total} techniques have therapeutic potential`}>
      {/* Background track */}
      <circle
        cx="100" cy="100" r="70"
        fill="none"
        stroke="var(--color-border)"
        stroke-width="22"
        opacity="0.3"
      />
      {/* Segments — each rotated -90deg so arcs start from 12 o'clock */}
      {arcs.map((arc) => (
        <circle
          cx="100" cy="100" r="70"
          fill="none"
          stroke={arc.color}
          stroke-width="22"
          stroke-dasharray={`${arc.length} ${circumference}`}
          stroke-dashoffset={`${-arc.offset}`}
          stroke-linecap="butt"
          transform="rotate(-90 100 100)"
        />
      ))}
      {/* Center text */}
      <text
        x="100" y="92"
        text-anchor="middle"
        font-size="28"
        font-weight="700"
        fill="var(--color-text-primary)"
      >
        {therapeuticCount}
      </text>
      <text
        x="100" y="108"
        text-anchor="middle"
        font-size="10"
        fill="var(--color-text-faint)"
      >
        of {total}
      </text>
      <text
        x="100" y="121"
        text-anchor="middle"
        font-size="9"
        fill="var(--color-text-faint)"
      >
        therapeutic
      </text>
    </svg>
  </div>

  {/* Legend */}
  <div class="mt-5 grid grid-cols-2 gap-3">
    {segments.map((seg) => (
      <div class="flex items-center gap-2">
        <span
          class="w-3 h-3 rounded-full shrink-0"
          style={`background-color: ${seg.color};`}
        />
        <div class="min-w-0">
          <span class="text-sm font-medium text-[var(--color-text-primary)]">
            {seg.label}
          </span>
          <span class="ml-1 text-sm text-[var(--color-text-muted)]">
            ({seg.count})
          </span>
        </div>
      </div>
    ))}
  </div>

  <p class="mt-4 pt-3 border-t border-[var(--color-border)] text-xs text-[var(--color-text-muted)] text-center leading-relaxed">
    <span class="font-semibold text-[var(--color-text-primary)]">{therapeuticPct}%</span> of catalogued techniques have confirmed or probable therapeutic applications
  </p>
</div>
