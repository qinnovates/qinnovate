---
import Search from 'astro-pagefind/components/Search';

const currentPath = Astro.url.pathname;

const techLinks = [
  { href: '/framework/', label: 'QIF Framework', desc: 'The 11-band hourglass governance architecture' },
  { href: '/nsp/', label: 'NSP Protocol', desc: 'Secure communication protocol for patient safety and privacy' },
  { href: '/runemate/', label: 'Runemate', desc: 'Compiler enabling on-device security for neural implants' },
  { href: '/TARA/', label: 'TARA', desc: 'Risk taxonomy — attacks, ethical risks, and therapeutic applications' },
  { href: '/whitepaper/', label: 'Whitepaper', desc: 'Full QIF specification document' },
];

const resourceLinks = [
  { href: '/news/', label: 'News', desc: 'Latest publications and updates' },
  { href: '/explore/', label: 'Explore', desc: 'Interactive visualizations and tools' },
  { href: '/glossary/', label: 'Glossary', desc: 'QIF terminology reference' },
];

const engageLinks = [
  { href: '/adopt/', label: 'Adopt the Standard', desc: 'Integrate QIF into your organization or research' },
  { href: '/advisory/', label: 'Advisory Services', desc: 'Hands-on guidance for BCI security implementation' },
  { href: 'https://github.com/qinnovates/qinnovate', label: 'Get Involved', desc: 'Contribute on GitHub — issues, PRs, discussions', external: true },
];

const isTechActive = ['/framework/', '/nsp/', '/runemate/', '/TARA/', '/whitepaper/'].some(p => currentPath.startsWith(p));
const isResourceActive = ['/news/', '/explore/', '/glossary/', '/publications/'].some(p => currentPath.startsWith(p));
const isEngageActive = ['/adopt/', '/advisory/'].some(p => currentPath.startsWith(p));

const govLinks = [
  { href: '/governance/#core', label: 'Core Standards', desc: 'Code of Conduct, Transparency, Data Policy, Accessibility' },
  { href: '/governance/#ethics', label: 'Ethics & Rights', desc: 'Neuroethics, Informed Consent, Pediatric, Post-Deployment' },
  { href: '/governance/#compliance', label: 'Compliance', desc: 'Regulatory, UNESCO Alignment, QIF Neuroethics' },
];

const isGovActive = currentPath.startsWith('/governance/');
---

<nav class="glass fixed top-0 left-0 right-0 z-50 border-b border-[var(--color-border)]" id="main-nav" transition:persist>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
        <span class="text-2xl font-bold font-[family-name:var(--font-heading)] bg-gradient-to-r from-[var(--color-accent-primary)] via-[var(--color-accent-secondary)] to-[var(--color-accent-tertiary)] bg-clip-text text-transparent">Q</span>
        <span class="text-sm font-medium tracking-wider uppercase hidden sm:inline text-[var(--color-text-primary)]">innovate</span>
      </a>

      <!-- Desktop links -->
      <div class="hidden md:flex items-center gap-1">
        <!-- About (flat link) -->
        <a
          href="/about/"
          class:list={[
            "px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            currentPath.startsWith('/about/')
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          About
        </a>

        <!-- Technology dropdown -->
        <div class="relative" data-dropdown="tech">
          <button
            class:list={[
              "flex items-center gap-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              isTechActive
                ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
            ]}
          >
            Technology
            <svg class="w-3.5 h-3.5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          <div class="dropdown-menu absolute left-0 top-full pt-2 hidden">
            <div class="glass rounded-xl border border-[var(--color-border)] shadow-xl w-72 overflow-hidden">
              <div class="p-2">
                {techLinks.map((link) => (
                  <a
                    href={link.href}
                    class:list={[
                      "block px-3 py-2.5 rounded-lg transition-colors",
                      currentPath.startsWith(link.href)
                        ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                        : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
                    ]}
                  >
                    <span class="text-sm font-medium block leading-snug">{link.label}</span>
                    <span class="text-xs text-[var(--color-text-faint)] block mt-0.5 leading-snug">{link.desc}</span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>

        <!-- Resources dropdown -->
        <div class="relative" data-dropdown="resources">
          <button
            class:list={[
              "flex items-center gap-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              isResourceActive
                ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
            ]}
          >
            Resources
            <svg class="w-3.5 h-3.5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          <div class="dropdown-menu absolute left-0 top-full pt-2 hidden">
            <div class="glass rounded-xl border border-[var(--color-border)] shadow-xl w-64 overflow-hidden">
              <div class="p-2">
                {resourceLinks.map((link) => (
                  <a
                    href={link.href}
                    class:list={[
                      "block px-3 py-2.5 rounded-lg transition-colors",
                      currentPath.startsWith(link.href) || (link.href === '/news/' && currentPath.startsWith('/publications/'))
                        ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                        : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
                    ]}
                  >
                    <span class="text-sm font-medium block leading-snug">{link.label}</span>
                    <span class="text-xs text-[var(--color-text-faint)] block mt-0.5 leading-snug">{link.desc}</span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>

        <!-- Engage dropdown -->
        <div class="relative" data-dropdown="engage">
          <button
            class:list={[
              "flex items-center gap-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              isEngageActive
                ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
            ]}
          >
            Engage
            <svg class="w-3.5 h-3.5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          <div class="dropdown-menu absolute left-0 top-full pt-2 hidden">
            <div class="glass rounded-xl border border-[var(--color-border)] shadow-xl w-72 overflow-hidden">
              <div class="p-2">
                {engageLinks.map((link) => (
                  <a
                    href={link.href}
                    target={link.external ? '_blank' : undefined}
                    rel={link.external ? 'noopener noreferrer' : undefined}
                    class:list={[
                      "block px-3 py-2.5 rounded-lg transition-colors",
                      !link.external && currentPath.startsWith(link.href)
                        ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                        : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
                    ]}
                  >
                    <span class="text-sm font-medium block leading-snug">{link.label}</span>
                    <span class="text-xs text-[var(--color-text-faint)] block mt-0.5 leading-snug">{link.desc}</span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>

        <!-- Governance dropdown -->
        <div class="relative" data-dropdown="gov">
          <a
            href="/governance/"
            class:list={[
              "flex items-center gap-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              isGovActive
                ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
            ]}
          >
            Governance
            <svg class="w-3.5 h-3.5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </a>
          <div class="dropdown-menu absolute right-0 top-full pt-2 hidden">
            <div class="glass rounded-xl border border-[var(--color-border)] shadow-xl w-72 overflow-hidden">
              <div class="p-2">
                {govLinks.map((link) => (
                  <a
                    href={link.href}
                    class:list={[
                      "block px-3 py-2.5 rounded-lg transition-colors",
                      "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
                    ]}
                  >
                    <span class="text-sm font-medium block leading-snug">{link.label}</span>
                    <span class="text-xs text-[var(--color-text-faint)] block mt-0.5 leading-snug">{link.desc}</span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right side -->
      <div class="flex items-center gap-3">
        <!-- GitHub link -->
        <a
          href="https://github.com/qinnovates/qinnovate"
          target="_blank"
          rel="noopener noreferrer"
          class="p-2 rounded-lg text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5 transition-colors"
          aria-label="GitHub"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>

        <!-- Search button -->
        <button
          id="search-btn"
          class="p-2 rounded-lg text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5 transition-colors"
          aria-label="Search"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
          </svg>
        </button>

        <!-- Mobile menu button -->
        <button
          id="mobile-menu-btn"
          class="md:hidden p-2 rounded-lg text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5 transition-colors"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="md:hidden hidden border-t border-[var(--color-border)]">
    <div class="px-4 py-3 space-y-1">
      <!-- About (flat) -->
      <a
        href="/about/"
        class:list={[
          "block px-3 py-2 rounded-lg text-sm font-medium transition-colors",
          currentPath.startsWith('/about/')
            ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
            : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
        ]}
      >
        About
      </a>

      <!-- Mobile Technology section -->
      <div>
        <button
          data-mobile-toggle="tech"
          class:list={[
            "flex items-center justify-between w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isTechActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Technology
          <svg class="w-3.5 h-3.5 opacity-60 transition-transform" data-chevron="tech" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div data-mobile-list="tech" class="hidden pl-3 space-y-0.5 mt-1">
          {techLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                "block px-3 py-1.5 rounded-lg text-sm transition-colors",
                currentPath.startsWith(link.href)
                  ? "text-[var(--color-accent-primary)]"
                  : "text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)]"
              ]}
            >
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <!-- Mobile Resources section -->
      <div>
        <button
          data-mobile-toggle="resources"
          class:list={[
            "flex items-center justify-between w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isResourceActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Resources
          <svg class="w-3.5 h-3.5 opacity-60 transition-transform" data-chevron="resources" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div data-mobile-list="resources" class="hidden pl-3 space-y-0.5 mt-1">
          {resourceLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                "block px-3 py-1.5 rounded-lg text-sm transition-colors",
                currentPath.startsWith(link.href) || (link.href === '/news/' && currentPath.startsWith('/publications/'))
                  ? "text-[var(--color-accent-primary)]"
                  : "text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)]"
              ]}
            >
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <!-- Mobile Engage section -->
      <div>
        <button
          data-mobile-toggle="engage"
          class:list={[
            "flex items-center justify-between w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isEngageActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Engage
          <svg class="w-3.5 h-3.5 opacity-60 transition-transform" data-chevron="engage" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div data-mobile-list="engage" class="hidden pl-3 space-y-0.5 mt-1">
          {engageLinks.map((link) => (
            <a
              href={link.href}
              target={link.external ? '_blank' : undefined}
              rel={link.external ? 'noopener noreferrer' : undefined}
              class:list={[
                "block px-3 py-1.5 rounded-lg text-sm transition-colors",
                !link.external && currentPath.startsWith(link.href)
                  ? "text-[var(--color-accent-primary)]"
                  : "text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)]"
              ]}
            >
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <!-- Mobile Governance section -->
      <div class="pt-2 border-t border-[var(--color-border)] mt-2">
        <button
          data-mobile-toggle="gov"
          class:list={[
            "flex items-center justify-between w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isGovActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Governance
          <svg class="w-3.5 h-3.5 opacity-60 transition-transform" data-chevron="gov" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div data-mobile-list="gov" class="hidden pl-3 space-y-0.5 mt-1">
          {govLinks.map((link) => (
            <a
              href={link.href}
              class="block px-3 py-1.5 rounded-lg text-sm transition-colors text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)]"
            >
              {link.label}
            </a>
          ))}
        </div>
      </div>

    </div>
  </div>
</nav>

<!-- Search modal -->
<div id="search-modal" class="fixed inset-0 z-[100] hidden">
  <div id="search-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="relative max-w-2xl mx-auto mt-20 px-4">
    <div class="glass rounded-xl p-4 shadow-2xl" id="search-container">
      <Search id="search" className="pagefind-ui" uiOptions={{ showImages: false, showSubResults: true }} />
    </div>
  </div>
</div>

<script>
  function initNav() {
    // Mobile menu
    const menuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');

    menuBtn?.addEventListener('click', () => {
      const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
      menuBtn.setAttribute('aria-expanded', String(!expanded));
      mobileMenu?.classList.toggle('hidden');
    });

    document.addEventListener('astro:before-swap', () => {
      mobileMenu?.classList.add('hidden');
      menuBtn?.setAttribute('aria-expanded', 'false');
    });

    // Desktop dropdowns (hover + focus)
    document.querySelectorAll<HTMLElement>('[data-dropdown]').forEach((dropdown) => {
      const menu = dropdown.querySelector<HTMLElement>('.dropdown-menu');
      let timeout: ReturnType<typeof setTimeout>;

      function show() {
        // Close any other open dropdowns first
        document.querySelectorAll<HTMLElement>('.dropdown-menu').forEach(m => {
          if (m !== menu) m.classList.add('hidden');
        });
        clearTimeout(timeout);
        menu?.classList.remove('hidden');
      }

      function hide() {
        timeout = setTimeout(() => {
          menu?.classList.add('hidden');
        }, 150);
      }

      dropdown.addEventListener('mouseenter', show);
      dropdown.addEventListener('mouseleave', hide);
      dropdown.addEventListener('focusin', show);
      dropdown.addEventListener('focusout', (e) => {
        if (!dropdown.contains((e as FocusEvent).relatedTarget as Node)) {
          hide();
        }
      });
    });

    // Mobile accordion toggles
    document.querySelectorAll<HTMLElement>('[data-mobile-toggle]').forEach((btn) => {
      const key = btn.getAttribute('data-mobile-toggle');
      const list = document.querySelector<HTMLElement>(`[data-mobile-list="${key}"]`);
      const chevron = document.querySelector<HTMLElement>(`[data-chevron="${key}"]`);

      btn.addEventListener('click', () => {
        list?.classList.toggle('hidden');
        chevron?.classList.toggle('rotate-180');
      });
    });

    // Search modal
    const searchBtn = document.getElementById('search-btn');
    const searchModal = document.getElementById('search-modal');
    const searchBackdrop = document.getElementById('search-backdrop');

    function openSearch() {
      searchModal?.classList.remove('hidden');
      setTimeout(() => {
        const input = searchModal?.querySelector<HTMLInputElement>('.pagefind-ui__search-input');
        input?.focus();
      }, 50);
    }

    function closeSearch() {
      searchModal?.classList.add('hidden');
    }

    searchBtn?.addEventListener('click', openSearch);
    searchBackdrop?.addEventListener('click', closeSearch);

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (searchModal?.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
      if (e.key === 'Escape') {
        closeSearch();
      }
    });

    document.addEventListener('astro:before-swap', closeSearch);
  }

  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>
