---
import Search from 'astro-pagefind/components/Search';

const currentPath = Astro.url.pathname;

const aboutLinks = [
  { href: '/about/', label: 'About', desc: 'The researcher and the mission' },
  { href: '/about/milestones/', label: 'Milestones', desc: 'The derivation timeline' },
  { href: '/roadmap/', label: 'Roadmap', desc: 'Framework version history' },
];

const researchLinks = [
  { href: '/whitepaper/', label: 'Whitepaper', desc: 'Full QIF specification and research paper' },
  { href: '/TARA/', label: 'TARA Atlas', desc: '102 BCI attack techniques, scored and mapped' },
  { href: '/security/', label: 'Security', desc: 'Signal coherence, frequency-band defense, and scoring' },
  { href: '/therapeutics/', label: 'Therapeutics', desc: '77 dual-use therapeutic analogs' },
  { href: '/neurogovernance/', label: 'Neurogovernance', desc: 'Neurorights mapped to brain regions and threats' },
  { href: '/scoring/', label: 'NISS Scoring', desc: 'Neural Impact Scoring System' },
  { href: '/case-studies/t0079-anc-fingerprint/', label: 'Case Studies', desc: 'Real-world hardware security validation' },
  { href: '/glossary/', label: 'Glossary', desc: 'QIF terminology reference' },
];

const toolsLinks = [
  { href: '/nsp/', label: 'NSP Protocol', desc: 'Secure communication for neural implants' },
  { href: '/runemate/', label: 'Runemate', desc: 'On-device security compiler' },
  { href: '/explore/', label: 'Interactive Tools', desc: 'Visualizations and explorers' },
];

const isAboutActive = currentPath.startsWith('/about/') || currentPath.startsWith('/roadmap/');
const isResearchActive = ['/whitepaper/', '/TARA/', '/scoring/', '/case-studies/', '/glossary/', '/neurogovernance/', '/therapeutics/', '/security/'].some(p => currentPath.startsWith(p));
const isFrameworkActive = currentPath.startsWith('/framework/');
const isToolsActive = ['/nsp/', '/runemate/', '/explore/', '/explorer/'].some(p => currentPath.startsWith(p));
const isGovActive = currentPath.startsWith('/governance/');
const isBlogActive = currentPath.startsWith('/news/') || currentPath.startsWith('/publications/');
---

<nav class="glass fixed top-0 left-0 right-0 z-50 border-b border-[var(--color-border)]" id="main-nav" transition:persist>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
        <span class="text-2xl font-bold font-[family-name:var(--font-heading)] bg-gradient-to-r from-[var(--color-accent-primary)] via-[var(--color-accent-secondary)] to-[var(--color-accent-tertiary)] bg-clip-text text-transparent">Q</span>
        <span class="text-sm font-medium tracking-wider uppercase hidden sm:inline text-[var(--color-text-primary)]">innovate</span>
        <span class="text-xs text-[var(--color-text-faint)] hidden sm:inline ml-1">|</span>
        <span class="text-xs font-medium tracking-wide hidden sm:inline text-[var(--color-text-muted)]">Open Neural Atlas</span>
      </a>

      <!-- Desktop links -->
      <div class="hidden md:flex items-center gap-1">
        <!-- About (link + dropdown) -->
        <div class="relative" data-dropdown="about">
          <a
            href="/about/"
            class:list={[
              "flex items-center gap-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              isAboutActive
                ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
            ]}
          >
            About
            <svg class="w-3.5 h-3.5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </a>
          <div class="dropdown-menu absolute left-0 top-full pt-2 hidden">
            <div class="glass nav-dropdown rounded-xl border border-[var(--color-border)] shadow-xl w-64 overflow-hidden">
              <div class="p-2">
                {aboutLinks.map((link) => (
                  <a
                    href={link.href}
                    class:list={[
                      "block px-3 py-2.5 rounded-lg transition-colors",
                      (link.href === '/about/' ? (currentPath === '/about/' || currentPath === '/about') : currentPath.startsWith(link.href))
                        ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                        : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
                    ]}
                  >
                    <span class="text-sm font-medium block leading-snug">{link.label}</span>
                    <span class="text-xs text-[var(--color-text-faint)] block mt-0.5 leading-snug">{link.desc}</span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>

        <!-- Research (link to whitepaper + dropdown) -->
        <div class="relative" data-dropdown="research">
          <a
            href="/whitepaper/"
            class:list={[
              "flex items-center gap-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              isResearchActive
                ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
            ]}
          >
            Research
            <svg class="w-3.5 h-3.5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </a>
          <div class="dropdown-menu absolute left-0 top-full pt-2 hidden">
            <div class="glass nav-dropdown rounded-xl border border-[var(--color-border)] shadow-xl w-72 overflow-hidden">
              <div class="p-2">
                {researchLinks.map((link) => (
                  <a
                    href={link.href}
                    class:list={[
                      "block px-3 py-2.5 rounded-lg transition-colors",
                      currentPath.startsWith(link.href)
                        ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                        : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
                    ]}
                  >
                    <span class="text-sm font-medium block leading-snug">{link.label}</span>
                    <span class="text-xs text-[var(--color-text-faint)] block mt-0.5 leading-snug">{link.desc}</span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>

        <!-- Framework (direct link) -->
        <a
          href="/framework/"
          class:list={[
            "px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isFrameworkActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Framework
        </a>

        <!-- Tools dropdown -->
        <div class="relative" data-dropdown="tools">
          <button
            class:list={[
              "flex items-center gap-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              isToolsActive
                ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
            ]}
          >
            Tools
            <svg class="w-3.5 h-3.5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          <div class="dropdown-menu absolute left-0 top-full pt-2 hidden">
            <div class="glass nav-dropdown rounded-xl border border-[var(--color-border)] shadow-xl w-72 overflow-hidden">
              <div class="p-2">
                {toolsLinks.map((link) => (
                  <a
                    href={link.href}
                    class:list={[
                      "block px-3 py-2.5 rounded-lg transition-colors",
                      currentPath.startsWith(link.href)
                        ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
                        : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
                    ]}
                  >
                    <span class="text-sm font-medium block leading-snug">{link.label}</span>
                    <span class="text-xs text-[var(--color-text-faint)] block mt-0.5 leading-snug">{link.desc}</span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>

        <!-- Governance (direct link) -->
        <a
          href="/governance/"
          class:list={[
            "px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isGovActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Governance
        </a>

        <!-- News (direct link) -->
        <a
          href="/news/"
          class:list={[
            "px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isBlogActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          News
        </a>

      </div>

      <!-- Right side -->
      <div class="flex items-center gap-3">
        <!-- GitHub link -->
        <a
          href="https://github.com/qinnovates/qinnovate"
          target="_blank"
          rel="noopener noreferrer"
          class="p-2 rounded-lg text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5 transition-colors"
          aria-label="GitHub"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>

        <!-- Search button -->
        <button
          id="search-btn"
          class="p-2 rounded-lg text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5 transition-colors"
          aria-label="Search"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
          </svg>
        </button>

        <!-- Mobile menu button -->
        <button
          id="mobile-menu-btn"
          class="md:hidden p-2 rounded-lg text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5 transition-colors"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="md:hidden hidden border-t border-[var(--color-border)]">
    <div class="px-4 py-3 space-y-1">
      <!-- Mobile About section -->
      <div>
        <button
          data-mobile-toggle="about"
          class:list={[
            "flex items-center justify-between w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isAboutActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          About
          <svg class="w-3.5 h-3.5 opacity-60 transition-transform" data-chevron="about" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div data-mobile-list="about" class="hidden pl-3 space-y-0.5 mt-1">
          {aboutLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                "block px-3 py-1.5 rounded-lg text-sm transition-colors",
                (link.href === '/about/' ? (currentPath === '/about/' || currentPath === '/about') : currentPath.startsWith(link.href))
                  ? "text-[var(--color-accent-primary)]"
                  : "text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)]"
              ]}
            >
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <!-- Mobile Research section -->
      <div>
        <button
          data-mobile-toggle="research"
          class:list={[
            "flex items-center justify-between w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isResearchActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Research
          <svg class="w-3.5 h-3.5 opacity-60 transition-transform" data-chevron="research" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div data-mobile-list="research" class="hidden pl-3 space-y-0.5 mt-1">
          {researchLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                "block px-3 py-1.5 rounded-lg text-sm transition-colors",
                currentPath.startsWith(link.href)
                  ? "text-[var(--color-accent-primary)]"
                  : "text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)]"
              ]}
            >
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <!-- Framework (direct link) -->
      <a
        href="/framework/"
        class:list={[
          "block px-3 py-2 rounded-lg text-sm font-medium transition-colors",
          isFrameworkActive
            ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
            : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
        ]}
      >
        Framework
      </a>

      <!-- Mobile Tools section -->
      <div>
        <button
          data-mobile-toggle="tools"
          class:list={[
            "flex items-center justify-between w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isToolsActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          Tools
          <svg class="w-3.5 h-3.5 opacity-60 transition-transform" data-chevron="tools" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div data-mobile-list="tools" class="hidden pl-3 space-y-0.5 mt-1">
          {toolsLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                "block px-3 py-1.5 rounded-lg text-sm transition-colors",
                currentPath.startsWith(link.href)
                  ? "text-[var(--color-accent-primary)]"
                  : "text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)]"
              ]}
            >
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <!-- Governance (direct link) -->
      <a
        href="/governance/"
        class:list={[
          "block px-3 py-2 rounded-lg text-sm font-medium transition-colors",
          isGovActive
            ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
            : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
        ]}
      >
        Governance
      </a>

      <!-- News (direct link) -->
      <div class="pt-2 border-t border-[var(--color-border)] mt-2">
        <a
          href="/news/"
          class:list={[
            "block px-3 py-2 rounded-lg text-sm font-medium transition-colors",
            isBlogActive
              ? "text-[var(--color-accent-primary)] bg-[var(--color-accent-primary)]/10"
              : "text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] hover:bg-black/5"
          ]}
        >
          News
        </a>
      </div>

    </div>
  </div>
</nav>

<!-- Search modal -->
<div id="search-modal" class="fixed inset-0 z-[100] hidden">
  <div id="search-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="relative max-w-2xl mx-auto mt-20 px-4">
    <div class="glass rounded-xl p-4 shadow-2xl" id="search-container">
      <Search id="search" className="pagefind-ui" uiOptions={{ showImages: false, showSubResults: true }} />
    </div>
  </div>
</div>

<script>
  function initNav() {
    // Mobile menu
    const menuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');

    menuBtn?.addEventListener('click', () => {
      const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
      menuBtn.setAttribute('aria-expanded', String(!expanded));
      mobileMenu?.classList.toggle('hidden');
    });

    document.addEventListener('astro:before-swap', () => {
      mobileMenu?.classList.add('hidden');
      menuBtn?.setAttribute('aria-expanded', 'false');
    });

    // Desktop dropdowns (hover + focus)
    document.querySelectorAll<HTMLElement>('[data-dropdown]').forEach((dropdown) => {
      const menu = dropdown.querySelector<HTMLElement>('.dropdown-menu');
      let timeout: ReturnType<typeof setTimeout>;

      function show() {
        // Close any other open dropdowns first
        document.querySelectorAll<HTMLElement>('.dropdown-menu').forEach(m => {
          if (m !== menu) m.classList.add('hidden');
        });
        clearTimeout(timeout);
        menu?.classList.remove('hidden');
      }

      function hide() {
        timeout = setTimeout(() => {
          menu?.classList.add('hidden');
        }, 150);
      }

      dropdown.addEventListener('mouseenter', show);
      dropdown.addEventListener('mouseleave', hide);
      dropdown.addEventListener('focusin', show);
      dropdown.addEventListener('focusout', (e) => {
        if (!dropdown.contains((e as FocusEvent).relatedTarget as Node)) {
          hide();
        }
      });
    });

    // Mobile accordion toggles
    document.querySelectorAll<HTMLElement>('[data-mobile-toggle]').forEach((btn) => {
      const key = btn.getAttribute('data-mobile-toggle');
      const list = document.querySelector<HTMLElement>(`[data-mobile-list="${key}"]`);
      const chevron = document.querySelector<HTMLElement>(`[data-chevron="${key}"]`);

      btn.addEventListener('click', () => {
        list?.classList.toggle('hidden');
        chevron?.classList.toggle('rotate-180');
      });
    });

    // Search modal
    const searchBtn = document.getElementById('search-btn');
    const searchModal = document.getElementById('search-modal');
    const searchBackdrop = document.getElementById('search-backdrop');

    function openSearch() {
      searchModal?.classList.remove('hidden');
      setTimeout(() => {
        const input = searchModal?.querySelector<HTMLInputElement>('.pagefind-ui__search-input');
        input?.focus();
      }, 50);
    }

    function closeSearch() {
      searchModal?.classList.add('hidden');
    }

    searchBtn?.addEventListener('click', openSearch);
    searchBackdrop?.addEventListener('click', closeSearch);

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (searchModal?.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
      if (e.key === 'Escape') {
        closeSearch();
      }
    });

    document.addEventListener('astro:before-swap', closeSearch);
  }

  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>
