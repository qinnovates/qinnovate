---
import PageLayout from '../layouts/PageLayout.astro';
import {
  getClinicalTechniques,
  getTechniquesByFdaStatus,
  THREAT_VECTORS,
  FDA_STATUS_COLORS,
  DUAL_USE_COLORS,
} from '../lib/threat-data';
import type { ThreatVector, FdaStatus, DualUse, EvidenceLevel } from '../lib/threat-data';
import ClinicalDomainCards from '../components/therapeutics/ClinicalDomainCards';
import type { ClinicalDomainInfo, DomainTechnique } from '../components/therapeutics/ClinicalDomainCards';

const clinical = getClinicalTechniques();
const totalTechniques = THREAT_VECTORS.length;

// FDA status breakdown
const fdaGroups: { status: FdaStatus; label: string; count: number }[] = [
  { status: 'approved', label: 'FDA Approved', count: getTechniquesByFdaStatus('approved').length },
  { status: 'cleared', label: 'FDA Cleared', count: getTechniquesByFdaStatus('cleared').length },
  { status: 'breakthrough', label: 'Breakthrough', count: getTechniquesByFdaStatus('breakthrough').length },
  { status: 'investigational', label: 'Investigational', count: getTechniquesByFdaStatus('investigational').length },
  { status: 'none', label: 'No FDA Status', count: getTechniquesByFdaStatus('none').length },
];

// Evidence level breakdown
const evidenceLevels: { level: EvidenceLevel; label: string; count: number }[] = [
  { level: 'meta_analysis', label: 'Meta-analysis', count: clinical.filter(t => t.tara?.clinical?.evidence_level === 'meta_analysis').length },
  { level: 'RCT', label: 'Randomized Controlled Trial', count: clinical.filter(t => t.tara?.clinical?.evidence_level === 'RCT').length },
  { level: 'cohort', label: 'Cohort Study', count: clinical.filter(t => t.tara?.clinical?.evidence_level === 'cohort').length },
  { level: 'case_series', label: 'Case Series', count: clinical.filter(t => t.tara?.clinical?.evidence_level === 'case_series').length },
  { level: 'preclinical', label: 'Preclinical', count: clinical.filter(t => t.tara?.clinical?.evidence_level === 'preclinical').length },
  { level: 'theoretical', label: 'Theoretical', count: clinical.filter(t => t.tara?.clinical?.evidence_level === 'theoretical').length },
];

// Dual-use breakdown
const dualUseGroups: { key: DualUse; label: string; count: number }[] = [
  { key: 'confirmed', label: 'Confirmed Dual-Use', count: THREAT_VECTORS.filter(t => t.tara?.dual_use === 'confirmed').length },
  { key: 'probable', label: 'Probable Dual-Use', count: THREAT_VECTORS.filter(t => t.tara?.dual_use === 'probable').length },
  { key: 'possible', label: 'Possible Dual-Use', count: THREAT_VECTORS.filter(t => t.tara?.dual_use === 'possible').length },
  { key: 'silicon_only', label: 'Silicon Only', count: THREAT_VECTORS.filter(t => t.tara?.dual_use === 'silicon_only').length },
];

// Collect all unique conditions and count techniques per condition
const conditionMap = new Map<string, ThreatVector[]>();
for (const t of clinical) {
  for (const c of t.tara?.clinical?.conditions ?? []) {
    const existing = conditionMap.get(c) ?? [];
    existing.push(t);
    conditionMap.set(c, existing);
  }
}
const conditionEntries = [...conditionMap.entries()]
  .sort((a, b) => b[1].length - a[1].length);
const uniqueConditions = conditionEntries.length;

// ═══ CLINICAL MATRIX: MITRE-style grid ═══

// Rows = Clinical Domain (matched on conditions[])
const MATRIX_ROWS = [
  { id: 'movement',  label: 'Movement & Motor',            keywords: ['parkinson', 'tremor', 'dystonia', 'motor', 'paralysis', 'spinal cord', 'stroke', 'gait', 'spasticity', 'tetraplegia', 'limb prosth', 'multiple sclerosis motor', 'balance', 'movement disorder', 'FES'] },
  { id: 'seizure',   label: 'Seizure & Epilepsy',          keywords: ['epilepsy', 'seizure', 'excitab', 'status epilepticus'] },
  { id: 'mood',      label: 'Mood & Affective',            keywords: ['depress', 'anxiety', 'PTSD', 'OCD', 'bipolar', 'substance', 'mood', 'suicidal', 'addiction', 'stress', 'dissociative', 'depersonalization', 'body dysmorphia', 'catatonia', 'psychedelic'] },
  { id: 'cognitive', label: 'Cognitive & Neurodevelopmental', keywords: ['ADHD', 'attention', 'dementia', 'alzheimer', 'autism', 'cognitive', 'memory', 'learning', 'schizophren', 'concussion', 'traumatic brain', 'working memory', 'MCI', 'meditation', 'fatigue', 'brain tumor', 'connectome', 'presurgical', 'intraoperative', 'anesthesia'] },
  { id: 'pain',      label: 'Pain & Somatosensory',        keywords: ['pain', 'phantom', 'tinnitus', 'neuropath', 'somatosens', 'migraine'] },
  { id: 'sleep',     label: 'Sleep & Circadian',           keywords: ['sleep', 'insomnia', 'narcolepsy', 'circadian'] },
  { id: 'comms',     label: 'Communication & Rehab',       keywords: ['locked-in', 'aphasia', 'dysarthria', 'communication', 'ALS', 'speech', 'laryngectomy'] },
] as const;

// Columns = Therapeutic Modality (matched on therapeutic_analog)
const MATRIX_COLS = [
  { id: 'elec',      label: 'Electrical Stim.',   keywords: ['DBS', 'tDCS', 'tACS', 'FES', 'stimulat', 'ablation', 'ECT', 'electroconvulsive', 'microwave', 'titration', 'modulation', 'impedance spectroscopy'] },
  { id: 'mag',       label: 'Magnetic Stim.',     keywords: ['TMS', 'rTMS', 'magnetic', 'quantum sensing'] },
  { id: 'feedback',  label: 'Neurofeedback',      keywords: ['neurofeedback', 'closed-loop', 'adaptive', 'biofeedback', 'coherence-based', 'entrainment', 'stochastic resonance', 'brain-state dependent', 'motor learning', 'memory retrieval', 'memory consolidation', 'excitability modulation'] },
  { id: 'dx',        label: 'Signal Dx & Recording', keywords: ['EEG', 'ECoG', 'ERP', 'diagnostic', 'recording', 'sensing', 'monitor', 'brain mapping', 'brain network', 'fNIRS', 'NIRS', 'spectroscopy', 'imaging', 'PPG', 'laser doppler', 'thermal', 'gait analysis', 'eye tracking', 'impedance', 'vital sign', 'audiometry', 'ABR', 'ASSR', 'otoacoustic', 'photoplethysmography', 'sensor fusion', 'fingerprint', 'assessment', 'priming'] },
  { id: 'prosth',    label: 'Sensory Prosthetics', keywords: ['cochlear', 'retinal', 'haptic', 'prosth', 'sensory'] },
  { id: 'bci',       label: 'BCI & Interfaces',   keywords: ['BCI', 'brain-computer', 'P300', 'neural interface', 'command', 'speech neuroprosth', 'neuroprosth'] },
] as const;

// Match a technique to a single column (first match wins)
function matchCol(analog: string): string | null {
  const lc = analog.toLowerCase();
  for (const col of MATRIX_COLS) {
    if (col.keywords.some(kw => lc.includes(kw.toLowerCase()))) return col.id;
  }
  return null;
}

// Match a technique to rows (can appear in multiple rows)
function matchRows(conditions: string[]): string[] {
  const joined = conditions.join(' ').toLowerCase();
  const matched: string[] = [];
  for (const row of MATRIX_ROWS) {
    if (row.keywords.some(kw => joined.includes(kw.toLowerCase()))) {
      matched.push(row.id);
    }
  }
  return matched;
}

// Evidence tier for dot color
function evidenceTier(t: ThreatVector): 1 | 2 | 3 {
  const fda = t.tara?.clinical?.fda_status;
  const ev = t.tara?.clinical?.evidence_level;
  const fdaApproved = fda === 'approved' || fda === 'cleared';
  const highEvidence = ev === 'meta_analysis' || ev === 'RCT';
  if (fdaApproved && highEvidence) return 1;
  const midFda = fda === 'breakthrough' || fda === 'investigational';
  const midEvidence = ev === 'cohort' || ev === 'case_series';
  if (midFda || midEvidence || (fdaApproved && !highEvidence) || (!fdaApproved && highEvidence)) return 2;
  return 3;
}

// Build matrix: matrix[rowId][colId] = ThreatVector[]
type MatrixData = Record<string, Record<string, ThreatVector[]>>;
const matrix: MatrixData = {};
const uncategorized: ThreatVector[] = [];

for (const row of MATRIX_ROWS) {
  matrix[row.id] = {};
  for (const col of MATRIX_COLS) {
    matrix[row.id][col.id] = [];
  }
}

for (const t of clinical) {
  const col = matchCol(t.tara!.clinical!.therapeutic_analog);
  const rows = matchRows(t.tara!.clinical!.conditions);

  if (!col || rows.length === 0) {
    uncategorized.push(t);
    continue;
  }

  for (const rowId of rows) {
    if (!matrix[rowId][col].some(existing => existing.id === t.id)) {
      matrix[rowId][col].push(t);
    }
  }
}

// Tier dot colors
const tierColors = {
  1: { dot: '#22c55e', label: 'Tier 1 — FDA + RCT/meta' },
  2: { dot: '#f59e0b', label: 'Tier 2 — Investigational + cohort' },
  3: { dot: '#94a3b8', label: 'Tier 3 — Preclinical/theoretical' },
} as const;

// FDA color helper
const fdaColor = (status: string) => {
  const c = FDA_STATUS_COLORS[status as FdaStatus];
  return c ?? FDA_STATUS_COLORS.none;
};

// Evidence level color helper
const evidenceColor = (level: string) => {
  switch (level) {
    case 'meta_analysis': return { bg: 'rgba(16, 185, 129, 0.12)', text: '#10b981' };
    case 'RCT': return { bg: 'rgba(34, 197, 94, 0.12)', text: '#22c55e' };
    case 'cohort': return { bg: 'rgba(6, 182, 212, 0.12)', text: '#06b6d4' };
    case 'case_series': return { bg: 'rgba(245, 158, 11, 0.12)', text: '#f59e0b' };
    case 'preclinical': return { bg: 'rgba(168, 85, 247, 0.12)', text: '#a855f7' };
    case 'theoretical': return { bg: 'rgba(148, 163, 184, 0.12)', text: '#94a3b8' };
    default: return { bg: 'rgba(148, 163, 184, 0.12)', text: '#94a3b8' };
  }
};

// ═══ CLINICAL DOMAIN CARDS DATA ═══
const DOMAIN_META: Record<string, { color: string; description: string }> = {
  movement:  { color: '#22c55e', description: "Parkinson's, tremor, stroke, paralysis, gait disorders" },
  seizure:   { color: '#ef4444', description: 'Epilepsy, seizure management, status epilepticus' },
  mood:      { color: '#f59e0b', description: 'Depression, anxiety, PTSD, OCD, addiction' },
  cognitive: { color: '#8b5cf6', description: 'ADHD, dementia, autism, schizophrenia, TBI' },
  pain:      { color: '#06b6d4', description: 'Chronic pain, phantom limb, tinnitus, migraine' },
  sleep:     { color: '#3b82f6', description: 'Insomnia, sleep apnea, narcolepsy' },
  comms:     { color: '#10b981', description: 'Locked-in syndrome, aphasia, ALS, speech' },
};

const COL_SHORT_LABELS: Record<string, string> = {
  elec: 'Elec.', mag: 'Mag.', feedback: 'Feedback', dx: 'Dx', prosth: 'Prosth.', bci: 'BCI',
};

const domainCards: ClinicalDomainInfo[] = MATRIX_ROWS.map(row => {
  // Collect all unique techniques in this domain across all modalities
  const allTechniques = new Map<string, ThreatVector>();
  const modalitySet = new Set<string>();

  for (const col of MATRIX_COLS) {
    const cell = matrix[row.id][col.id];
    if (cell.length > 0) {
      modalitySet.add(COL_SHORT_LABELS[col.id] ?? col.label);
      for (const t of cell) {
        allTechniques.set(t.id, t);
      }
    }
  }

  const techniques = Array.from(allTechniques.values());
  const fdaApprovedCount = techniques.filter(t => {
    const fda = t.tara?.clinical?.fda_status;
    return fda === 'approved' || fda === 'cleared';
  }).length;

  // Top techniques sorted by evidence tier (best first), take top 5
  const topTechniques: DomainTechnique[] = techniques
    .sort((a, b) => evidenceTier(a) - evidenceTier(b))
    .slice(0, 5)
    .map(t => ({
      id: t.id,
      name: t.name,
      therapeuticAnalog: t.tara!.clinical!.therapeutic_analog,
      tier: evidenceTier(t),
      fdaStatus: t.tara!.clinical!.fda_status,
      evidenceLevel: t.tara!.clinical!.evidence_level,
    }));

  const meta = DOMAIN_META[row.id] ?? { color: '#94a3b8', description: '' };

  return {
    id: row.id,
    label: row.label,
    color: meta.color,
    description: meta.description,
    techniqueCount: techniques.length,
    fdaApprovedCount,
    modalities: Array.from(modalitySet),
    topTechniques,
  };
});

const breadcrumbs = [
  { label: 'Therapeutics' },
];
---

<PageLayout
  title="Therapeutic Dual-Use Atlas — Same Mechanism, Two Outcomes"
  description={`${clinical.length} of ${totalTechniques} BCI techniques have therapeutic analogs. Research mappings of dual-use pathways based on known neuroscience, awaiting clinical validation.`}
  breadcrumbs={breadcrumbs}
  wide
>

  <!-- ═══ HERO ═══ -->
  <section class="py-12 md:py-20">
    <div class="text-center max-w-3xl mx-auto mb-12">
      <p class="text-xs font-medium tracking-[0.2em] uppercase mb-4 text-[var(--color-text-faint)]">
        Therapeutic Dual-Use Atlas
      </p>
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold font-[family-name:var(--font-heading)] tracking-tight mb-6 leading-[1.15]">
        <span class="text-[var(--color-text-primary)]">Same Mechanism.</span>
        <br />
        <span class="bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500 bg-clip-text text-transparent">
          Two Outcomes.
        </span>
      </h1>
      <p class="text-base sm:text-lg text-[var(--color-text-muted)] max-w-2xl mx-auto leading-relaxed">
        {clinical.length} of {totalTechniques} BCI attack techniques share their core mechanism with an FDA-recognized
        therapeutic application. The same signal that treats depression can, in adversarial hands, induce it.
        This atlas maps every dual-use pathway we've found.
      </p>
    </div>

    <!-- Stats bar -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 max-w-3xl mx-auto mb-12">
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-emerald-500">
          {clinical.length}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">therapeutic<br/>analogs mapped</p>
      </div>
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-cyan-500">
          {uniqueConditions}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">treatable<br/>conditions</p>
      </div>
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-green-500">
          {fdaGroups[0].count + fdaGroups[1].count}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">FDA approved<br/>or cleared</p>
      </div>
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-amber-500">
          {dualUseGroups[0].count}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">confirmed<br/>dual-use</p>
      </div>
    </div>
  </section>

  <!-- ═══ VALIDATION STATUS ═══ -->
  <div class="max-w-3xl mx-auto mb-8">
    <div class="rounded-xl p-4 sm:p-5 border border-amber-500/20" style="background: rgba(245, 158, 11, 0.06);">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-amber-500 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
        </svg>
        <div>
          <p class="text-sm font-semibold text-amber-500 mb-1">Research Status: Dual-Use Mappings Awaiting Peer Review</p>
          <p class="text-xs text-[var(--color-text-muted)] leading-relaxed">
            The therapeutic analogs listed here reference FDA-recognized applications, but the
            <strong class="text-[var(--color-text-primary)]">dual-use attack-to-therapy mappings have not been validated by clinical neuroscientists.</strong>
            These mappings were developed by a security researcher through literature review and mechanism-first
            reasoning. Clinical validation is needed before these correspondences can inform safety assessments
            or regulatory decisions. See
            <a href="https://doi.org/10.5281/zenodo.18640105" class="text-amber-500 hover:underline">Section 9 of the preprint</a>
            for the full limitations disclosure.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ THE DUAL-USE ARGUMENT ═══ -->
  <section class="py-12 md:py-16" id="dual-use">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Why This Matters
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="glass rounded-2xl p-6 sm:p-8 max-w-3xl mx-auto reveal">
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-4">
        Deep brain stimulation treats Parkinson's. The same electrode, misconfigured, can induce involuntary movement.
        Transcranial direct current stimulation alleviates depression. The same current, weaponized, can suppress cognition.
        EEG monitoring diagnoses epilepsy. The same signals, intercepted, reveal your emotional state to an attacker.
      </p>
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-4">
        This is the dual-use problem in neurotechnology: <strong class="text-[var(--color-text-primary)]">the therapeutic mechanism IS the attack vector.</strong>
        You cannot ban the technology without banning the cure. The only answer is governance — knowing which mechanisms
        exist, what they can do, and building the safety rails before deployment.
      </p>
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
        The TARA registry classifies every technique by its dual-use status, FDA clearance, evidence level, and
        the conditions it can treat. This page presents the therapeutic side of that ledger.
      </p>
    </div>
  </section>

  <!-- ═══ FDA STATUS BREAKDOWN ═══ -->
  <section class="py-12 md:py-16" id="fda">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        FDA Status Breakdown
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 max-w-4xl mx-auto mb-8">
      {fdaGroups.filter(g => g.count > 0).map(g => (
        <div class="glass rounded-lg p-4 text-center">
          <p
            class="text-2xl font-bold font-[family-name:var(--font-heading)]"
            style={`color: ${fdaColor(g.status).text};`}
          >
            {g.count}
          </p>
          <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">{g.label}</p>
        </div>
      ))}
    </div>

    <!-- Evidence level bar -->
    <div class="max-w-3xl mx-auto">
      <p class="text-xs font-medium text-[var(--color-text-faint)] mb-3 text-center">Evidence Quality</p>
      <div class="flex gap-1 h-6 rounded-full overflow-hidden">
        {evidenceLevels.filter(e => e.count > 0).map(e => (
          <div
            class="flex items-center justify-center text-[9px] font-medium transition-all"
            style={`flex: ${e.count}; background: ${evidenceColor(e.level).bg}; color: ${evidenceColor(e.level).text};`}
            title={`${e.label}: ${e.count} techniques`}
          >
            {e.count > 3 && e.label.split(' ')[0]}
          </div>
        ))}
      </div>
      <div class="flex flex-wrap justify-center gap-x-4 gap-y-1 mt-3">
        {evidenceLevels.filter(e => e.count > 0).map(e => (
          <span class="flex items-center gap-1.5 text-[10px] text-[var(--color-text-faint)]">
            <span
              class="w-2 h-2 rounded-sm"
              style={`background: ${evidenceColor(e.level).text};`}
            ></span>
            {e.label} ({e.count})
          </span>
        ))}
      </div>
    </div>
  </section>

  <!-- ═══ DUAL-USE CLASSIFICATION ═══ -->
  <section class="py-12 md:py-16" id="classification">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Dual-Use Classification
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 max-w-3xl mx-auto mb-6">
      {dualUseGroups.map(g => (
        <div
          class="rounded-lg p-4 text-center"
          style={`background: ${DUAL_USE_COLORS[g.key].bg}; border: 1px solid ${DUAL_USE_COLORS[g.key].border};`}
        >
          <p
            class="text-2xl font-bold font-[family-name:var(--font-heading)]"
            style={`color: ${DUAL_USE_COLORS[g.key].text};`}
          >
            {g.count}
          </p>
          <p class="text-[10px] sm:text-xs mt-1 leading-tight" style={`color: ${DUAL_USE_COLORS[g.key].text}; opacity: 0.8;`}>
            {g.label}
          </p>
        </div>
      ))}
    </div>

    <p class="text-xs text-[var(--color-text-faint)] text-center max-w-lg mx-auto">
      <strong>Confirmed:</strong> Published therapeutic use with FDA recognition.
      <strong>Probable:</strong> Strong clinical evidence, not yet FDA-cleared for this pathway.
      <strong>Possible:</strong> Preclinical or theoretical therapeutic potential.
      <strong>Silicon Only:</strong> No known therapeutic analog.
    </p>
  </section>

  <!-- ═══ CLINICAL DOMAIN CARDS ═══ -->
  <section class="py-12 md:py-16" id="domains">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Clinical Domains
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <p class="text-sm text-[var(--color-text-muted)] max-w-2xl mx-auto text-center mb-8">
      {clinical.length} therapeutic techniques organized across 7 clinical specialties.
      Click any domain to see its top techniques ranked by evidence quality.
    </p>

    <div class="max-w-6xl mx-auto">
      <ClinicalDomainCards client:visible domains={domainCards} />
    </div>
  </section>

  <!-- ═══ CONDITION EXPLORER ═══ -->
  <section class="py-12 md:py-16" id="conditions">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Conditions Treated
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <p class="text-sm text-[var(--color-text-muted)] max-w-2xl mx-auto text-center mb-8">
      {uniqueConditions} treatable conditions mapped across {clinical.length} techniques.
      Each condition links to the TARA technique that treats it — and can be weaponized against it.
    </p>

    <div class="max-w-4xl mx-auto space-y-2">
      {conditionEntries.map(([condition, techniques]) => (
        <details class="glass rounded-lg group">
          <summary class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-white/5 transition-colors rounded-lg">
            <span class="text-sm font-medium text-[var(--color-text-primary)]">{condition}</span>
            <span class="flex items-center gap-2">
              <span class="text-xs text-[var(--color-text-faint)]">
                {techniques.length} technique{techniques.length !== 1 ? 's' : ''}
              </span>
              <svg class="w-3.5 h-3.5 text-[var(--color-text-faint)] group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </span>
          </summary>
          <div class="px-4 pb-4 space-y-2">
            {techniques.map(t => {
              const c = t.tara?.clinical!;
              const fda = fdaColor(c.fda_status);
              const ev = evidenceColor(c.evidence_level);
              return (
                <a
                  href={`/TARA/${t.id}/`}
                  class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 p-3 rounded-md hover:bg-white/5 transition-colors border border-transparent hover:border-[var(--color-border)]"
                >
                  <div class="flex-1 min-w-0">
                    <p class="text-xs font-mono text-[var(--color-text-faint)]">{t.id}</p>
                    <p class="text-sm font-medium text-[var(--color-text-primary)] truncate">{c.therapeutic_analog}</p>
                  </div>
                  <div class="flex flex-wrap gap-1.5 shrink-0">
                    <span
                      class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                      style={`background: ${fda.bg}; color: ${fda.text};`}
                    >
                      {c.fda_status}
                    </span>
                    <span
                      class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                      style={`background: ${ev.bg}; color: ${ev.text};`}
                    >
                      {c.evidence_level.replace('_', '-')}
                    </span>
                  </div>
                </a>
              );
            })}
          </div>
        </details>
      ))}
    </div>
  </section>

  <!-- ═══ FULL TECHNIQUE LIST ═══ -->
  <section class="py-12 md:py-16" id="techniques">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        All {clinical.length} Therapeutic Analogs
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="max-w-4xl mx-auto grid gap-3 sm:grid-cols-2">
      {clinical.sort((a, b) => a.id.localeCompare(b.id)).map(t => {
        const c = t.tara?.clinical!;
        const du = t.tara?.dual_use ?? 'silicon_only';
        const duC = DUAL_USE_COLORS[du as DualUse];
        const fda = fdaColor(c.fda_status);
        return (
          <a
            href={`/TARA/${t.id}/`}
            class="glass rounded-lg p-4 hover:ring-1 hover:ring-emerald-500/20 transition-all group"
          >
            <div class="flex items-start justify-between gap-2 mb-2">
              <p class="text-xs font-mono text-[var(--color-text-faint)]">{t.id}</p>
              <span
                class="px-2 py-0.5 rounded-full text-[9px] font-semibold uppercase shrink-0"
                style={`background: ${duC.bg}; color: ${duC.text}; border: 1px solid ${duC.border};`}
              >
                {du.replace('_', ' ')}
              </span>
            </div>
            <p class="text-sm font-medium text-[var(--color-text-primary)] mb-1 group-hover:text-emerald-500 transition-colors">
              {c.therapeutic_analog}
            </p>
            <p class="text-xs text-[var(--color-text-faint)] mb-3 line-clamp-1">
              Attack: {t.name}
            </p>
            <div class="flex flex-wrap gap-1.5 mb-2">
              <span
                class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                style={`background: ${fda.bg}; color: ${fda.text};`}
              >
                {c.fda_status}
              </span>
              {c.conditions.slice(0, 3).map(cond => (
                <span class="px-2 py-0.5 rounded-full text-[10px] font-medium bg-[var(--color-bg-muted)] text-[var(--color-text-faint)]">
                  {cond}
                </span>
              ))}
              {c.conditions.length > 3 && (
                <span class="px-2 py-0.5 rounded-full text-[10px] font-medium bg-[var(--color-bg-muted)] text-[var(--color-text-faint)]">
                  +{c.conditions.length - 3} more
                </span>
              )}
            </div>
          </a>
        );
      })}
    </div>
  </section>

  <!-- ═══ CLINICAL MATRIX ═══ -->
  <section class="py-12 md:py-16" id="matrix">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Explore by Domain &times; Modality
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <p class="text-sm text-[var(--color-text-muted)] max-w-2xl mx-auto text-center mb-4">
      The same {clinical.length} techniques organized as an interactive matrix.
      Click any cell to see what treats that condition with that modality.
    </p>

    <!-- Legend -->
    <div class="flex flex-wrap items-center justify-center gap-x-5 gap-y-2 mb-6">
      {([1, 2, 3] as const).map(tier => (
        <span class="flex items-center gap-1.5 text-[11px] text-[var(--color-text-faint)]">
          <span class="w-2.5 h-2.5 rounded-full" style={`background: ${tierColors[tier].dot};`}></span>
          {tierColors[tier].label}
        </span>
      ))}
    </div>

    <!-- Matrix table with horizontal scroll on mobile -->
    <div class="matrix-scroll max-w-6xl mx-auto">
      <table class="matrix-table w-full border-collapse text-xs">
        <thead>
          <tr>
            <th class="matrix-corner sticky left-0 z-20 px-3 py-2.5 text-left text-[10px] font-semibold uppercase tracking-wider text-[var(--color-text-faint)]">
              Domain
            </th>
            {MATRIX_COLS.map(col => (
              <th class="px-2 py-2.5 text-center text-[10px] font-semibold uppercase tracking-wider text-[var(--color-text-faint)] min-w-[120px]">
                {col.label}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {MATRIX_ROWS.map(row => (
            <tr class="matrix-row">
              <td class="matrix-rowlabel sticky left-0 z-10 px-3 py-2 text-sm font-medium text-[var(--color-text-primary)] whitespace-nowrap">
                {row.label}
              </td>
              {MATRIX_COLS.map(col => {
                const cellTechniques = matrix[row.id][col.id];
                const count = cellTechniques.length;
                if (count === 0) {
                  return (
                    <td class="matrix-cell px-2 py-2 text-center">
                      <span class="text-[var(--color-text-faint)] opacity-30">&mdash;</span>
                    </td>
                  );
                }
                // Count by tier
                const t1 = cellTechniques.filter(t => evidenceTier(t) === 1).length;
                const t2 = cellTechniques.filter(t => evidenceTier(t) === 2).length;
                const t3 = cellTechniques.filter(t => evidenceTier(t) === 3).length;
                return (
                  <td class="matrix-cell px-1 py-1.5">
                    <details class="group">
                      <summary class="matrix-cell-summary flex items-center justify-center gap-1 px-2 py-1.5 rounded-md cursor-pointer transition-colors">
                        <span class="flex items-center gap-0.5">
                          {t1 > 0 && <span class="flex items-center gap-0.5"><span class="w-2 h-2 rounded-full inline-block" style="background: #22c55e;"></span><span class="text-[10px] text-[var(--color-text-muted)]">{t1}</span></span>}
                          {t2 > 0 && <span class="flex items-center gap-0.5 ml-1"><span class="w-2 h-2 rounded-full inline-block" style="background: #f59e0b;"></span><span class="text-[10px] text-[var(--color-text-muted)]">{t2}</span></span>}
                          {t3 > 0 && <span class="flex items-center gap-0.5 ml-1"><span class="w-2 h-2 rounded-full inline-block" style="background: #94a3b8;"></span><span class="text-[10px] text-[var(--color-text-muted)]">{t3}</span></span>}
                        </span>
                        <svg class="w-3 h-3 text-[var(--color-text-faint)] opacity-0 group-hover:opacity-100 group-open:rotate-180 transition-all shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                      </summary>
                      <div class="mt-1.5 space-y-1">
                        {cellTechniques.sort((a, b) => evidenceTier(a) - evidenceTier(b)).map(t => {
                          const c = t.tara?.clinical!;
                          const tier = evidenceTier(t);
                          return (
                            <a
                              href={`/TARA/${t.id}/`}
                              class="flex items-start gap-2 px-2 py-1.5 rounded hover:bg-white/5 transition-colors border border-transparent hover:border-[var(--color-border)]"
                            >
                              <span class="w-2 h-2 rounded-full mt-1 shrink-0" style={`background: ${tierColors[tier].dot};`}></span>
                              <span class="min-w-0">
                                <span class="text-[11px] font-medium text-[var(--color-text-primary)] leading-tight block truncate">{c.therapeutic_analog}</span>
                                <span class="text-[9px] text-[var(--color-text-faint)] font-mono">{t.id}</span>
                              </span>
                            </a>
                          );
                        })}
                      </div>
                    </details>
                  </td>
                );
              })}
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    {uncategorized.length > 0 && (
      <div class="max-w-4xl mx-auto mt-6">
        <details class="glass rounded-lg group">
          <summary class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-white/5 transition-colors rounded-lg">
            <span class="text-xs font-medium text-[var(--color-text-faint)]">
              {uncategorized.length} technique{uncategorized.length !== 1 ? 's' : ''} not categorized in the matrix
            </span>
            <svg class="w-3.5 h-3.5 text-[var(--color-text-faint)] group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <div class="px-4 pb-4 space-y-1.5 mt-2">
            {uncategorized.map(t => {
              const c = t.tara?.clinical!;
              return (
                <a
                  href={`/TARA/${t.id}/`}
                  class="flex items-center gap-3 p-2 rounded hover:bg-white/5 transition-colors"
                >
                  <span class="text-xs font-mono text-[var(--color-text-faint)] shrink-0">{t.id}</span>
                  <span class="text-xs text-[var(--color-text-primary)] truncate">{c.therapeutic_analog}</span>
                </a>
              );
            })}
          </div>
        </details>
      </div>
    )}
  </section>

  <!-- ═══ PIVOT TO TARA ═══ -->
  <section class="py-12 md:py-16" id="tara-pivot">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        See the Full Picture
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="glass rounded-2xl p-6 sm:p-8 max-w-3xl mx-auto reveal">
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-4">
        This page shows the therapeutic side. To see the full dual-use picture — the attack vector, NISS severity score,
        affected hourglass bands, and DSM-5 psychiatric outcomes for each technique — open it in the TARA Atlas.
      </p>
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-6">
        Every technique card above links directly to its TARA entry. From there you can trace the complete
        Neural Impact Chain: from the physical mechanism, through the neural structure it affects, to the
        clinical outcome it produces.
      </p>

      <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
        <a
          href="/TARA/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium text-white transition-colors"
          style="background: var(--color-accent-primary);"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
          </svg>
          Open TARA Atlas
        </a>
        <span class="text-xs text-[var(--color-text-faint)]">
          View all {totalTechniques} techniques with full scoring and projections
        </span>
      </div>
    </div>
  </section>

  <!-- ═══ CALL TO ACTION ═══ -->
  <section class="py-12 md:py-20" id="cta">
    <div class="glass rounded-2xl p-8 sm:p-12 max-w-3xl mx-auto text-center reveal">
      <h2 class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] mb-4 text-[var(--color-text-primary)]">
        The same tools that heal can harm.
      </h2>
      <p class="text-sm text-[var(--color-text-muted)] mb-8 max-w-lg mx-auto leading-relaxed">
        This is why neurogovernance exists. Every therapeutic mechanism in this atlas has a corresponding
        attack pathway in the TARA registry. Explore both sides.
      </p>

      <div class="flex flex-wrap items-center justify-center gap-3">
        <a
          href="/TARA/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium text-white transition-colors"
          style="background: var(--color-accent-primary);"
        >
          TARA Registry
        </a>
        <a
          href="/neurogovernance/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors"
          style="background: rgba(0,0,0,0.05); color: var(--color-text-primary);"
        >
          Neurogovernance
        </a>
        <a
          href="/whitepaper/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors"
          style="background: rgba(0,0,0,0.05); color: var(--color-text-primary);"
        >
          Read the Whitepaper
        </a>
      </div>
    </div>
  </section>

</PageLayout>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  details[open] > summary {
    border-bottom: 1px solid var(--color-border);
    border-radius: 0.5rem 0.5rem 0 0;
  }

  /* Matrix styles */
  .matrix-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .matrix-table {
    border-spacing: 0;
  }

  .matrix-table th,
  .matrix-table td {
    border-bottom: 1px solid var(--color-border);
  }

  .matrix-table thead th {
    border-bottom: 2px solid var(--color-border);
  }

  .matrix-corner,
  .matrix-rowlabel {
    background: var(--color-bg-primary, #0a0a0f);
  }

  .matrix-cell-summary:hover {
    background: rgba(255, 255, 255, 0.04);
  }

  .matrix-cell details[open] > .matrix-cell-summary {
    background: rgba(255, 255, 255, 0.04);
    border-bottom: none;
    border-radius: 0.375rem 0.375rem 0 0;
  }

  .matrix-cell details[open] {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 0.375rem;
    border: 1px solid var(--color-border);
  }

  .matrix-row:last-child td {
    border-bottom: none;
  }
</style>
