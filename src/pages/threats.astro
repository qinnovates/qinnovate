---
import PageLayout from '../layouts/PageLayout.astro';
import { HOURGLASS_BANDS } from '../lib/qif-constants';
import { THREAT_CATEGORIES, THREAT_VECTORS, SEVERITY_COLORS, STATUS_COLORS, ZONE_COLORS, getThreatStats, getStatusStats } from '../lib/threat-data';

const stats = getThreatStats();
const statusStats = getStatusStats();
const bands = [...HOURGLASS_BANDS];
const allThreatsJson = JSON.stringify(THREAT_VECTORS);
---

<PageLayout
  title="QIF Threat Registry"
  description="Interactive attack matrix mapping 60 MITRE-compatible BCI techniques across 11 hourglass bands, 8 attack categories, and 4 evidence levels."
  breadcrumbs={[{ label: 'Explore', href: '/explore/' }, { label: 'Threat Registry' }]}
  maxWidth="wide"
>
  <div class="mb-8">
    <h1 class="text-3xl sm:text-4xl font-bold font-[family-name:var(--font-heading)] mb-2">QIF Threat Registry</h1>
    <p class="text-base text-[var(--color-text-muted)] max-w-3xl mb-6">
      60 MITRE-compatible techniques across 11 tactics and 11 hourglass bands
    </p>

    <!-- Status breakdown -->
    <div class="flex flex-wrap gap-3 mb-4">
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-[#ef4444]"></span>
        <span class="text-[var(--color-text-faint)]">Confirmed</span>
        <span class="font-bold">{statusStats.CONFIRMED}</span>
      </div>
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-[#f59e0b]"></span>
        <span class="text-[var(--color-text-faint)]">Demonstrated</span>
        <span class="font-bold">{statusStats.DEMONSTRATED}</span>
      </div>
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-[#94a3b8]"></span>
        <span class="text-[var(--color-text-faint)]">Theoretical</span>
        <span class="font-bold">{statusStats.THEORETICAL}</span>
      </div>
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-[#8b5cf6]"></span>
        <span class="text-[var(--color-text-faint)]">Emerging</span>
        <span class="font-bold">{statusStats.EMERGING}</span>
      </div>
    </div>

    <!-- Severity stats bar -->
    <div class="flex flex-wrap gap-3 mb-6">
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
        <span class="text-[var(--color-text-faint)]">Total</span>
        <span class="font-bold ml-2">{stats.total}</span>
      </div>
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
        <span class="severity-dot severity-dot--critical"></span>
        <span class="text-[var(--color-text-faint)]">Critical</span>
        <span class="font-bold ml-1">{stats.critical}</span>
      </div>
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
        <span class="severity-dot severity-dot--high"></span>
        <span class="text-[var(--color-text-faint)]">High</span>
        <span class="font-bold ml-1">{stats.high}</span>
      </div>
      <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
        <span class="severity-dot severity-dot--medium"></span>
        <span class="text-[var(--color-text-faint)]">Medium</span>
        <span class="font-bold ml-1">{stats.medium}</span>
      </div>
      {stats.low > 0 && (
        <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
          <span class="severity-dot severity-dot--low"></span>
          <span class="text-[var(--color-text-faint)]">Low</span>
          <span class="font-bold ml-1">{stats.low}</span>
        </div>
      )}
    </div>

    <!-- How to read this -->
    <details class="glass-subtle rounded-lg mb-6">
      <summary class="px-4 py-3 text-sm font-medium cursor-pointer text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] select-none">
        How to read this grid
      </summary>
      <div class="px-4 pb-4 text-sm text-[var(--color-text-muted)] space-y-3 border-t border-[var(--color-border)] pt-3">
        <div>
          <strong class="text-[var(--color-text-primary)]">Grid axes</strong> &mdash; Rows are hourglass bands (Neural N7&ndash;N1, Interface I0, Synthetic S1&ndash;S3). Columns are attack categories (Signal Injection, Eavesdropping, Data Manipulation, etc.).
        </div>
        <div>
          <strong class="text-[var(--color-text-primary)]">Severity colors</strong> &mdash; Damage potential if the attack succeeds.
          <span class="sev-badge sev-badge--critical ml-1">critical</span>
          <span class="sev-badge sev-badge--high ml-1">high</span>
          <span class="sev-badge sev-badge--medium ml-1">medium</span>
          <span class="sev-badge sev-badge--low ml-1">low</span>
        </div>
        <div>
          <strong class="text-[var(--color-text-primary)]">Status badges</strong> &mdash; Evidence level.
          <span class="status-badge status-badge--CONFIRMED ml-1">confirmed</span> = real-world documented.
          <span class="status-badge status-badge--DEMONSTRATED ml-1">demonstrated</span> = lab-proven.
          <span class="status-badge status-badge--THEORETICAL ml-1">theoretical</span> = plausible from physics/neuroscience.
          <span class="status-badge status-badge--EMERGING ml-1">emerging</span> = newly identified.
        </div>
        <div>
          <strong class="text-[var(--color-text-primary)]">MITRE IDs</strong> &mdash; T2001&ndash;T2899 for BCI techniques (avoids collision with MITRE ATT&CK T1001&ndash;T1659). TA#### for tactics.
        </div>
      </div>
    </details>

    <!-- Filter toolbar -->
    <div class="flex flex-wrap gap-3 items-center" id="filter-toolbar">
      <input
        type="text"
        id="search-input"
        placeholder="Search threats..."
        class="glass-subtle rounded-lg px-3 py-2 text-sm w-48 focus:outline-none focus:border-[var(--color-accent-primary)] border border-transparent"
      />
      <div class="flex gap-2 items-center text-sm">
        <span class="text-[var(--color-text-faint)]">Severity:</span>
        <label class="filter-chip active" data-severity="critical">
          <input type="checkbox" checked class="hidden" /> Critical
        </label>
        <label class="filter-chip active" data-severity="high">
          <input type="checkbox" checked class="hidden" /> High
        </label>
        <label class="filter-chip active" data-severity="medium">
          <input type="checkbox" checked class="hidden" /> Medium
        </label>
        <label class="filter-chip active" data-severity="low">
          <input type="checkbox" checked class="hidden" /> Low
        </label>
      </div>
      <div class="flex gap-2 items-center text-sm">
        <span class="text-[var(--color-text-faint)]">Status:</span>
        <label class="filter-chip active" data-status="CONFIRMED">
          <input type="checkbox" checked class="hidden" /> Confirmed
        </label>
        <label class="filter-chip active" data-status="DEMONSTRATED">
          <input type="checkbox" checked class="hidden" /> Demonstrated
        </label>
        <label class="filter-chip active" data-status="THEORETICAL">
          <input type="checkbox" checked class="hidden" /> Theoretical
        </label>
        <label class="filter-chip active" data-status="EMERGING">
          <input type="checkbox" checked class="hidden" /> Emerging
        </label>
      </div>
      <div class="flex gap-2 items-center text-sm">
        <span class="text-[var(--color-text-faint)]">Zone:</span>
        <label class="filter-chip active" data-zone="neural">
          <input type="checkbox" checked class="hidden" /> Neural
        </label>
        <label class="filter-chip active" data-zone="interface">
          <input type="checkbox" checked class="hidden" /> Interface
        </label>
        <label class="filter-chip active" data-zone="synthetic">
          <input type="checkbox" checked class="hidden" /> Synthetic
        </label>
      </div>
    </div>
  </div>

  <!-- Threat Map Grid -->
  <div class="threat-map-scroll">
    <div class="threat-map" id="threat-map">
      <!-- Header row -->
      <div class="map-header-corner">
        <span class="text-xs text-[var(--color-text-faint)]">Band &darr; &ensp; Category &rarr;</span>
      </div>
      {THREAT_CATEGORIES.map((cat) => (
        <div class="map-header-cell" title={cat.description}>
          <div class="text-xs font-bold font-[family-name:var(--font-mono)] text-[var(--color-accent-secondary)]">{cat.id}</div>
          <div class="text-[10px] text-[var(--color-text-faint)] leading-tight mt-0.5">{cat.name}</div>
        </div>
      ))}

      <!-- Band rows -->
      {bands.map((band, i) => {
        const prevBand = i > 0 ? bands[i - 1] : null;
        const showSeparator = prevBand && prevBand.zone !== band.zone;
        const zoneName = band.zone === 'interface' ? 'I\u2080 Interface' : band.zone === 'synthetic' ? 'Synthetic Domain' : 'Neural Domain';

        return (
          <>
            {showSeparator && (
              <div class="map-zone-separator" style={`grid-column: 1 / -1;`}>
                <div class="zone-line"></div>
                <span class="zone-label-text">{zoneName}</span>
                <div class="zone-line"></div>
              </div>
            )}
            {i === 0 && (
              <div class="map-zone-separator" style="grid-column: 1 / -1;">
                <div class="zone-line"></div>
                <span class="zone-label-text">Neural Domain</span>
                <div class="zone-line"></div>
              </div>
            )}
            <div
              class:list={[
                "map-row-header",
                band.zone === 'interface' && "map-row-header--interface",
              ]}
              data-band-id={band.id}
              data-zone={band.zone}
            >
              <span class="font-[family-name:var(--font-mono)] text-xs font-bold" style={`color: ${band.color}`}>{band.id}</span>
              <span class="text-xs text-[var(--color-text-muted)] ml-2 truncate">{band.name}</span>
            </div>
            {THREAT_CATEGORIES.map((cat) => {
              const cellThreats = THREAT_VECTORS.filter(t =>
                t.bands.includes(band.id as any) && t.category === cat.id
              );
              const maxSev = cellThreats.length > 0
                ? (['critical', 'high', 'medium', 'low'] as const).find(s => cellThreats.some(t => t.severity === s)) || null
                : null;

              return (
                <div
                  class:list={[
                    "map-cell",
                    maxSev && `map-cell--${maxSev}`,
                    band.zone === 'interface' && "map-cell--interface",
                    cellThreats.length === 0 && "map-cell--empty",
                  ]}
                  data-band={band.id}
                  data-category={cat.id}
                  data-zone={band.zone}
                  data-threats={JSON.stringify(cellThreats.map(t => t.id))}
                  data-severity={maxSev || ''}
                >
                  {cellThreats.length > 0 && (
                    <div class="cell-inner">
                      <span class="cell-count">{cellThreats.length}</span>
                      <span class="cell-sev-dot" data-sev={maxSev}></span>
                    </div>
                  )}
                </div>
              );
            })}
          </>
        );
      })}
    </div>
  </div>

  <!-- Detail Panel (side drawer) -->
  <div class="detail-drawer" id="detail-drawer">
    <div class="detail-drawer-inner" id="detail-drawer-inner">
      <button class="detail-close" id="detail-close" aria-label="Close">&times;</button>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- Hover Tooltip -->
  <div class="map-tooltip" id="map-tooltip"></div>
</PageLayout>

<style>
  /* ═══ Threat Map Grid ═══ */
  .threat-map-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2rem;
  }

  .threat-map {
    display: grid;
    grid-template-columns: 160px repeat(8, minmax(100px, 1fr));
    gap: 1px;
    min-width: 960px;
  }

  /* Header */
  .map-header-corner {
    position: sticky;
    left: 0;
    z-index: 3;
    background: var(--color-bg-deep);
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: flex-end;
  }

  .map-header-cell {
    background: var(--color-bg-surface);
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--color-border);
    text-align: center;
    cursor: help;
  }

  /* Zone separator */
  .map-zone-separator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.4rem 0.75rem;
    background: var(--color-bg-deep);
  }

  .zone-line {
    flex: 1;
    height: 1px;
    background: var(--color-border);
  }

  .zone-label-text {
    font-size: 0.65rem;
    color: var(--color-text-faint);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
  }

  /* Row headers */
  .map-row-header {
    position: sticky;
    left: 0;
    z-index: 2;
    background: var(--color-bg-deep);
    padding: 0.5rem 0.75rem;
    display: flex;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    min-height: 44px;
  }

  .map-row-header--interface {
    background: rgba(245, 158, 11, 0.05);
    border-top: 1px solid rgba(245, 158, 11, 0.15);
    border-bottom: 1px solid rgba(245, 158, 11, 0.15);
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.08);
  }

  /* Grid cells */
  .map-cell {
    background: var(--color-bg-surface);
    padding: 0.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .map-cell--empty {
    cursor: default;
    opacity: 0.4;
  }

  .map-cell:not(.map-cell--empty):hover {
    transform: scale(1.05);
    z-index: 1;
    box-shadow: 0 0 12px rgba(0,0,0,0.5);
  }

  .map-cell--interface {
    background: rgba(245, 158, 11, 0.05);
  }

  /* Severity heat colors */
  .map-cell--critical { background: rgba(239, 68, 68, 0.12); }
  .map-cell--critical:hover { background: rgba(239, 68, 68, 0.22); }
  .map-cell--high { background: rgba(245, 158, 11, 0.10); }
  .map-cell--high:hover { background: rgba(245, 158, 11, 0.20); }
  .map-cell--medium { background: rgba(234, 179, 8, 0.08); }
  .map-cell--medium:hover { background: rgba(234, 179, 8, 0.18); }
  .map-cell--low { background: rgba(148, 163, 184, 0.06); }
  .map-cell--low:hover { background: rgba(148, 163, 184, 0.14); }

  .cell-inner {
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .cell-count {
    font-size: 0.85rem;
    font-weight: 700;
    font-family: var(--font-mono);
    color: var(--color-text-primary);
  }

  .cell-sev-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  .cell-sev-dot[data-sev="critical"] { background: #ef4444; box-shadow: 0 0 4px #ef4444; }
  .cell-sev-dot[data-sev="high"] { background: #f59e0b; box-shadow: 0 0 4px #f59e0b; }
  .cell-sev-dot[data-sev="medium"] { background: #eab308; box-shadow: 0 0 4px #eab308; }
  .cell-sev-dot[data-sev="low"] { background: #94a3b8; box-shadow: 0 0 4px #94a3b8; }

  /* Severity dots in stats bar */
  .severity-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }
  .severity-dot--critical { background: #ef4444; }
  .severity-dot--high { background: #f59e0b; }
  .severity-dot--medium { background: #eab308; }
  .severity-dot--low { background: #94a3b8; }

  /* Filter chips */
  .filter-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.6rem;
    border-radius: 99px;
    border: 1px solid var(--color-border);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--color-text-faint);
    user-select: none;
  }

  .filter-chip.active {
    border-color: var(--color-accent-secondary);
    color: var(--color-accent-secondary);
    background: rgba(6, 182, 212, 0.1);
  }

  .filter-chip:hover {
    border-color: var(--color-text-muted);
  }

  /* Detail drawer */
  .detail-drawer {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 460px;
    max-width: 90vw;
    z-index: 60;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .detail-drawer.open {
    transform: translateX(0);
    pointer-events: auto;
  }

  .detail-drawer-inner {
    height: 100%;
    overflow-y: auto;
    background: var(--color-bg-surface);
    border-left: 1px solid var(--color-border);
    padding: 1.5rem;
    position: relative;
  }

  .detail-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: 1px solid var(--color-border);
    color: var(--color-text-muted);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .detail-close:hover {
    border-color: var(--color-text-primary);
    color: var(--color-text-primary);
    background: var(--color-bg-elevated);
  }

  /* Detail content */
  .detail-threat {
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .detail-threat:last-child { border-bottom: none; }

  .detail-threat-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text-primary);
    margin-bottom: 0.25rem;
  }

  .detail-threat-id {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-text-faint);
    margin-bottom: 0.5rem;
  }

  .detail-meta {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.25rem 0.75rem;
    font-size: 0.8rem;
    margin: 0.5rem 0;
  }

  .detail-meta dt { color: var(--color-text-faint); }
  .detail-meta dd { color: var(--color-text-primary); }

  .detail-description {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.5;
    margin-top: 0.5rem;
  }

  .detail-sources {
    font-size: 0.7rem;
    color: var(--color-text-faint);
    margin-top: 0.4rem;
    font-style: italic;
  }

  .detail-mitre {
    font-size: 0.7rem;
    color: var(--color-text-faint);
    margin-top: 0.3rem;
    font-family: var(--font-mono);
  }

  .sev-badge {
    display: inline-block;
    padding: 0.1rem 0.5rem;
    border-radius: 99px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .sev-badge--critical { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
  .sev-badge--high { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
  .sev-badge--medium { background: rgba(234,179,8,0.15); color: #eab308; border: 1px solid rgba(234,179,8,0.3); }
  .sev-badge--low { background: rgba(148,163,184,0.15); color: #94a3b8; border: 1px solid rgba(148,163,184,0.3); }

  .status-badge {
    display: inline-block;
    padding: 0.1rem 0.5rem;
    border-radius: 99px;
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .status-badge--CONFIRMED { background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.2); }
  .status-badge--DEMONSTRATED { background: rgba(245,158,11,0.12); color: #f59e0b; border: 1px solid rgba(245,158,11,0.2); }
  .status-badge--THEORETICAL { background: rgba(148,163,184,0.12); color: #94a3b8; border: 1px solid rgba(148,163,184,0.2); }
  .status-badge--EMERGING { background: rgba(139,92,246,0.12); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.2); }

  /* Hover tooltip */
  .map-tooltip {
    position: fixed;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 0.6rem 0.8rem;
    font-size: 0.75rem;
    max-width: 300px;
    pointer-events: none;
    opacity: 0;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    transition: opacity 0.15s;
  }

  .map-tooltip.visible { opacity: 1; }

  .map-tooltip .tt-name {
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 0.2rem;
  }

  .map-tooltip .tt-meta {
    color: var(--color-text-faint);
    font-size: 0.7rem;
  }

  /* Hidden by filter */
  .map-cell.filtered-out {
    opacity: 0.08 !important;
    pointer-events: none;
  }

  .map-row-header.filtered-out {
    opacity: 0.3;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .threat-map {
      grid-template-columns: 120px repeat(8, 90px);
    }
    .detail-drawer { width: 100%; max-width: 100vw; }
  }
</style>

<script define:vars={{ allThreatsJson }}>
  // ── Threat data from server ──
  const ALL_THREATS = JSON.parse(allThreatsJson);

  const THREATS = {};
  for (const t of ALL_THREATS) {
    THREATS[t.id] = t;
  }

  // ── Tooltip ──
  const tooltip = document.getElementById('map-tooltip');

  function showTooltip(cell, e) {
    const threatIds = JSON.parse(cell.dataset.threats || '[]');
    if (threatIds.length === 0) return;

    const threats = threatIds.map(id => THREATS[id]).filter(Boolean);
    let html = '';
    for (const t of threats) {
      html += '<div class="tt-name">' + t.id + ' — ' + t.name + '</div>';
      html += '<div class="tt-meta">' + t.severity.toUpperCase() + ' · ' + t.status + ' · ' + t.bandsStr + (t.coupling ? ' · ' + t.coupling : '') + '</div>';
    }

    tooltip.innerHTML = html;
    positionTooltip(e);
    tooltip.classList.add('visible');
  }

  function positionTooltip(e) {
    const x = Math.min(e.clientX + 12, window.innerWidth - 320);
    const y = Math.min(e.clientY - 8, window.innerHeight - 150);
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
  }

  function hideTooltip() {
    tooltip.classList.remove('visible');
  }

  // ── Detail drawer ──
  const drawer = document.getElementById('detail-drawer');
  const drawerContent = document.getElementById('detail-content');
  const drawerClose = document.getElementById('detail-close');

  const STATUS_BADGE_COLORS = {
    CONFIRMED: { bg: 'rgba(239,68,68,0.12)', color: '#ef4444', border: 'rgba(239,68,68,0.2)' },
    DEMONSTRATED: { bg: 'rgba(245,158,11,0.12)', color: '#f59e0b', border: 'rgba(245,158,11,0.2)' },
    THEORETICAL: { bg: 'rgba(148,163,184,0.12)', color: '#94a3b8', border: 'rgba(148,163,184,0.2)' },
    EMERGING: { bg: 'rgba(139,92,246,0.12)', color: '#8b5cf6', border: 'rgba(139,92,246,0.2)' },
  };

  function openDrawer(cell) {
    const threatIds = JSON.parse(cell.dataset.threats || '[]');
    const band = cell.dataset.band;
    const category = cell.dataset.category;

    if (threatIds.length === 0) return;

    const threats = threatIds.map(id => THREATS[id]).filter(Boolean);
    let html = '<div style="margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid var(--color-border);">' +
      '<div style="font-size:0.7rem;color:var(--color-text-faint);font-family:var(--font-mono);">' + band + ' \u00d7 ' + category + '</div>' +
      '<div style="font-size:1.1rem;font-weight:600;margin-top:0.25rem;">' + threats.length + ' Threat' + (threats.length !== 1 ? 's' : '') + '</div>' +
    '</div>';

    for (const t of threats) {
      const sc = STATUS_BADGE_COLORS[t.status] || STATUS_BADGE_COLORS.THEORETICAL;
      const statusBadge = '<span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:99px;font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;background:' + sc.bg + ';color:' + sc.color + ';border:1px solid ' + sc.border + ';">' + t.status + '</span>';

      html += '<div class="detail-threat">' +
        '<div class="detail-threat-name">' + t.name + ' <span class="sev-badge sev-badge--' + t.severity + '">' + t.severity + '</span> ' + statusBadge + '</div>' +
        '<div class="detail-threat-id">' + t.id + '</div>' +
        '<dl class="detail-meta">' +
          '<dt>Bands</dt><dd>' + t.bandsStr + '</dd>' +
          (t.coupling ? '<dt>Coupling</dt><dd>' + t.coupling + '</dd>' : '') +
          (t.access ? '<dt>Access</dt><dd>' + t.access + '</dd>' : '') +
          '<dt>Classical</dt><dd style="color:' + (t.classicalDetection === 'Yes' ? '#10b981' : t.classicalDetection === 'Partial' ? '#f59e0b' : '#ef4444') + '">' + t.classicalDetection + '</dd>' +
          '<dt>Quantum</dt><dd style="color:#8b5cf6">' + t.quantumDetection + '</dd>' +
        '</dl>' +
        '<div class="detail-description">' + t.description + '</div>';

      // MITRE cross-reference
      if (t.mitre && (t.mitre.tactics.length > 0 || t.mitre.techniques.length > 0)) {
        html += '<div class="detail-mitre">';
        if (t.mitre.tactics.length > 0) {
          html += t.mitre.tactics.join(', ');
        }
        if (t.mitre.techniques.length > 0) {
          html += ' \u00b7 ' + t.mitre.techniques.join(', ');
        }
        html += '</div>';
      }

      // Sources
      if (t.sources && t.sources.length > 0) {
        html += '<div class="detail-sources">Sources: ' + t.sources.join('; ') + '</div>';
      }

      html += '</div>';
    }

    drawerContent.innerHTML = html;
    drawer.classList.add('open');
  }

  function closeDrawer() {
    drawer.classList.remove('open');
  }

  drawerClose.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeDrawer();
  });

  // ── Cell interactions ──
  document.querySelectorAll('.map-cell:not(.map-cell--empty)').forEach(function(cell) {
    cell.addEventListener('mouseenter', function(e) { showTooltip(cell, e); });
    cell.addEventListener('mousemove', function(e) { positionTooltip(e); });
    cell.addEventListener('mouseleave', hideTooltip);
    cell.addEventListener('click', function() {
      hideTooltip();
      openDrawer(cell);
    });
  });

  // ── Filters ──
  const searchInput = document.getElementById('search-input');
  const severityFilters = document.querySelectorAll('.filter-chip[data-severity]');
  const statusFilters = document.querySelectorAll('.filter-chip[data-status]');
  const zoneFilters = document.querySelectorAll('.filter-chip[data-zone]');

  function getActiveSet(chips, attr) {
    const active = new Set();
    chips.forEach(function(f) {
      if (f.classList.contains('active')) active.add(f.dataset[attr]);
    });
    return active;
  }

  function applyFilters() {
    const query = searchInput.value.toLowerCase().trim();
    const activeSeverities = getActiveSet(severityFilters, 'severity');
    const activeStatuses = getActiveSet(statusFilters, 'status');
    const activeZones = getActiveSet(zoneFilters, 'zone');

    document.querySelectorAll('.map-cell').forEach(function(cell) {
      const zone = cell.dataset.zone || '';
      const threatIds = JSON.parse(cell.dataset.threats || '[]');

      // Zone filter
      if (!activeZones.has(zone)) {
        cell.classList.add('filtered-out');
        return;
      }

      // Empty cells
      if (threatIds.length === 0) {
        cell.classList.remove('filtered-out');
        return;
      }

      // Get matching threats
      const threats = threatIds.map(function(id) { return THREATS[id]; }).filter(Boolean);

      // Severity + status filter — at least one threat must match both
      const hasMatch = threats.some(function(t) {
        return activeSeverities.has(t.severity) && activeStatuses.has(t.status);
      });
      if (!hasMatch) {
        cell.classList.add('filtered-out');
        return;
      }

      // Search filter
      if (query) {
        const matchesSearch = threats.some(function(t) {
          return t.name.toLowerCase().includes(query) ||
            t.description.toLowerCase().includes(query) ||
            t.id.toLowerCase().includes(query) ||
            (t.coupling && t.coupling.toLowerCase().includes(query)) ||
            (t.tactic && t.tactic.toLowerCase().includes(query));
        });
        if (!matchesSearch) {
          cell.classList.add('filtered-out');
          return;
        }
      }

      cell.classList.remove('filtered-out');
    });

    // Filter row headers by zone
    document.querySelectorAll('.map-row-header').forEach(function(header) {
      const zone = header.dataset.zone || '';
      header.classList.toggle('filtered-out', !activeZones.has(zone));
    });
  }

  // Wire up filter chips
  function wireChips(chips) {
    chips.forEach(function(chip) {
      chip.addEventListener('click', function() {
        chip.classList.toggle('active');
        applyFilters();
      });
    });
  }
  wireChips(severityFilters);
  wireChips(statusFilters);
  wireChips(zoneFilters);

  searchInput.addEventListener('input', applyFilters);
</script>
