---
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import TrustBar from '../components/TrustBar.astro';
import PublicationCard from '../components/PublicationCard.astro';
import { getCollection } from 'astro:content';
import { getPostDate } from '../lib/utils';
import { HOURGLASS_BANDS, HOURGLASS_WIDTHS, STATS, PILLARS, LATEST_WHITEPAPER_HREF } from '../lib/qif-constants';
import HeroParticles from '../components/HeroParticles';
import '../styles/global.css';
import registry from '@shared/qtara-registrar.json';

const posts = (await getCollection('blog'))
  .sort((a, b) => new Date(getPostDate(b.data)).getTime() - new Date(getPostDate(a.data)).getTime())
  .slice(0, 6);

// Compute hero metrics from registrar (build-time)
const techniques = (registry as any).techniques ?? [];
const totalThreats = techniques.length;
const therapeuticCount = techniques.filter((t: any) => t?.tara?.clinical?.therapeutic_analog).length;
const dsm5Count = techniques.filter((t: any) => t?.tara?.dsm5?.primary?.length > 0).length;
const neurorightsSet = new Set<string>();
techniques.forEach((t: any) => (t?.neurorights?.affected ?? []).forEach((r: string) => neurorightsSet.add(r)));
const neurorightsCount = neurorightsSet.size;

// Curated essential reading slugs (strongest posts for neuroethics audience)
const essentialSlugs = [
  '2026-02-13-the-neural-impact-chain-when-niss-scores-predict-psychiatric-diagnoses',
  '2026-02-16-your-brain-has-rights-we-counted-them',
  '2026-02-11-how-malicious-apps-derive-your-personal-biometrics',
  '2026-02-17-your-smart-glasses-are-one-sensor-away-from-hearing-your-thoughts',
  '2026-02-09-tara-when-a-threat-registry-became-a-map-for-healing',
  '2026-02-11-taras-first-cve-a-9-year-old-vulnerability-hiding-in-every-pc-speaker',
];

const allPosts = await getCollection('blog');
const essentialPosts = essentialSlugs
  .map(slug => allPosts.find(p => p.id === slug))
  .filter(Boolean) as typeof allPosts;

---

<BaseLayout title="Qinnovate — Neural Security Atlas" description="Brain-computer interfaces can be hacked. No one had mapped what that means for patients. Qinnovate's Neural Atlas is an open framework tracing 102 BCI attack techniques to the psychiatric diagnoses they cause and the neurorights they violate.">
  <Nav />

  <!-- ═══ HERO ═══ -->
  <section class="relative min-h-screen flex flex-col items-center justify-center px-4 overflow-hidden">
    <!-- Gradient background -->
    <div class="absolute inset-0 bg-[var(--color-bg-deep)]">
      <div class="absolute inset-0 opacity-30" style="background: radial-gradient(ellipse at 50% 30%, rgba(59,130,246,0.15) 0%, transparent 60%), radial-gradient(ellipse at 30% 70%, rgba(6,182,212,0.1) 0%, transparent 50%), radial-gradient(ellipse at 70% 60%, rgba(139,92,246,0.08) 0%, transparent 50%);"></div>
    </div>

    <HeroParticles client:idle />

    <div class="relative z-10 text-center max-w-4xl mx-auto pt-24">
      <p class="text-xs font-medium tracking-[0.2em] uppercase mb-6 text-[var(--color-text-faint)]">
        An independent research project by Kevin L. Qi
      </p>

      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold font-[family-name:var(--font-heading)] tracking-tight mb-6 leading-[1.15]">
        <span class="text-[var(--color-text-primary)]">Brain-computer interfaces can be hacked.</span>
        <br />
        <span class="bg-gradient-to-r from-[var(--color-accent-primary)] via-[var(--color-accent-secondary)] to-[var(--color-accent-tertiary)] bg-clip-text text-transparent">
          No one had mapped what that means for patients.
        </span>
      </h1>

      <p class="text-base sm:text-lg text-[var(--color-text-muted)] mb-10 max-w-2xl mx-auto leading-relaxed">
        Qinnovate's Neural Atlas is an open neuroethics and security framework that traces {totalThreats} BCI attack techniques to the psychiatric diagnoses they can cause and the neurorights they violate. Built from first principles. Published openly. Ready for peer review.
      </p>

      <!-- Metrics with ethical framing -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 max-w-3xl mx-auto mb-10">
        <div class="glass rounded-lg p-4 text-center">
          <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-primary)]">{totalThreats}</p>
          <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">BCI attack techniques<br/>catalogued and scored</p>
        </div>
        <div class="glass rounded-lg p-4 text-center">
          <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-secondary)]">{therapeuticCount}</p>
          <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">therapeutic uses found<br/>in the same mechanisms</p>
        </div>
        <div class="glass rounded-lg p-4 text-center">
          <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-tertiary)]">{dsm5Count}</p>
          <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">psychiatric diagnoses<br/>linked to attack pathways</p>
        </div>
        <div class="glass rounded-lg p-4 text-center">
          <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-emerald-400">{neurorightsCount}</p>
          <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">neurorights<br/>operationalized</p>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
        <a
          href="/whitepaper/"
          class="px-6 py-3 rounded-lg bg-[var(--color-accent-secondary)] text-white font-medium hover:bg-[var(--color-accent-secondary)]/90 transition-colors"
        >
          Read the Research
        </a>
        <a
          href="/about/"
          class="px-6 py-3 rounded-lg glass text-[var(--color-text-primary)] font-medium hover:bg-white/10 transition-colors"
        >
          About This Project
        </a>
      </div>

      <TrustBar />
    </div>

    <!-- Scroll indicator -->
    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 animate-bounce">
      <svg class="w-5 h-5 text-[var(--color-text-faint)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
      </svg>
    </div>
  </section>

  <!-- ═══ WHY THIS MATTERS ═══ -->
  <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
    <div class="reveal">
      <h2 class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] mb-8 text-center">Why This Matters</h2>
      <div class="space-y-6 text-[var(--color-text-muted)] leading-relaxed">
        <p>
          Neuralink has implanted chips in human patients. Synchron's Stentrode is in FDA trials. Consumer EEG headsets sit on store shelves. These devices are tested for safety and efficacy — but <strong class="text-[var(--color-text-primary)]">no public framework exists to audit what they can do to a mind.</strong> Not to the data. To the mind itself.
        </p>
        <p>
          When I catalogued every known way to attack a brain-computer interface, I discovered something unexpected: <strong class="text-[var(--color-text-primary)]">{therapeuticCount} of {totalThreats} attack techniques have direct therapeutic counterparts.</strong> The same neural mechanism that can disrupt cognition can also treat a neurological condition. The technology that helps a Parkinson's patient can, if misconfigured or exploited, cause real psychiatric harm — {dsm5Count} techniques map to specific DSM-5-TR diagnoses through documented neural pathways.
        </p>
        <p>
          This dual-use reality means BCI security is not an engineering problem. <strong class="text-[var(--color-text-primary)]">It is a patient rights problem.</strong> Every proposed neurorights framework — cognitive liberty, mental privacy, psychological continuity — can be violated through technical pathways that already exist. The question is whether we build the governance to prevent it.
        </p>
      </div>
    </div>
  </section>

  <!-- ═══ THREE PILLARS ═══ -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-10 reveal">
      <h2 class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] mb-3">The Framework</h2>
      <p class="text-[var(--color-text-muted)] max-w-2xl mx-auto">Three interlocking systems that together map how neurotechnology can be secured, evaluated, and governed.</p>
    </div>
    <div class="grid md:grid-cols-3 gap-4 max-w-4xl mx-auto reveal">
      {PILLARS.map((pillar) => (
        <a href={pillar.href} class="glass rounded-xl p-5 card-hover group text-left">
          <div class="flex items-center gap-2 mb-3">
            <div class="text-xl" style={`color: ${pillar.color}`} set:html={pillar.icon} />
            <h3 class="text-base font-semibold font-[family-name:var(--font-heading)] group-hover:text-[var(--color-accent-primary)] transition-colors">
              {pillar.name}
            </h3>
          </div>
          <p class="text-xs text-[var(--color-text-faint)] mb-1.5 font-medium">{pillar.tagline}</p>
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
            {pillar.description}
          </p>
        </a>
      ))}
    </div>
  </section>

  <!-- ═══ MILESTONE CALLOUT: Neural Impact Chain ═══ -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="glass rounded-xl p-6 sm:p-8 reveal" style="border-left: 4px solid var(--color-accent-secondary);">
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        <div class="flex-1">
          <p class="text-xs font-semibold tracking-[0.15em] uppercase text-[var(--color-accent-secondary)] mb-2">Key Finding</p>
          <h3 class="text-lg font-bold font-[family-name:var(--font-heading)] mb-2">
            The Neural Impact Chain
          </h3>
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
            A six-stage mapping that traces every BCI attack technique from its physical mechanism through the affected neural structure to its psychiatric outcome. {dsm5Count} techniques produce diagnosable conditions under DSM-5-TR — from acute stress disorder to neurocognitive impairment.
          </p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 shrink-0">
          <a
            href="/TARA/#diagnostic"
            class="px-5 py-2.5 rounded-lg bg-[var(--color-accent-secondary)] text-white font-medium text-sm hover:bg-[var(--color-accent-secondary)]/90 transition-colors text-center"
          >
            Explore Diagnostic View
          </a>
          <a
            href="/publications/2026-02-13-the-neural-impact-chain-when-niss-scores-predict-psychiatric-diagnoses/"
            class="px-5 py-2.5 rounded-lg glass text-[var(--color-text-primary)] font-medium text-sm hover:bg-white/10 transition-colors text-center"
          >
            Read More
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- ═══ CASE STUDY CALLOUT ═══ -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="glass rounded-xl p-6 sm:p-8 reveal" style="border-left: 4px solid var(--color-accent-primary);">
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        <div class="flex-1">
          <p class="text-xs font-semibold tracking-[0.15em] uppercase text-[var(--color-accent-primary)] mb-2">Empirical Validation</p>
          <h3 class="text-lg font-bold font-[family-name:var(--font-heading)] mb-2">
            How Consumer Sensors Become Surveillance Tools
          </h3>
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
            28 consumer sensor exploitation techniques validated with real hardware. ANC earbuds extract ear canal biometrics at &minus;47 dB below music — completely inaudible. No firmware exploit. No elevated privileges. Just physics.
          </p>
        </div>
        <div class="shrink-0">
          <a
            href="/publications/2026-02-11-how-malicious-apps-derive-your-personal-biometrics/"
            class="px-5 py-2.5 rounded-lg bg-[var(--color-accent-primary)] text-white font-medium text-sm hover:bg-[var(--color-accent-primary)]/90 transition-colors text-center"
          >
            View Case Study
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- ═══ HOURGLASS PREVIEW ═══ -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
    <div class="text-center mb-12 reveal">
      <h2 class="text-3xl font-bold font-[family-name:var(--font-heading)] mb-4">The Hourglass Architecture</h2>
      <p class="text-[var(--color-text-muted)] max-w-2xl mx-auto">
        QIF models the full neurotechnology stack as an 11-band hourglass — biology above, silicon below, with the physical neural interface at the critical bottleneck. Every attack technique is mapped to the bands it crosses, making the security implications visible at each layer.
      </p>
    </div>

    <!-- Flat interactive hourglass preview — click any band to explore -->
    <div class="max-w-xl mx-auto reveal" id="hourglass-preview">
      <div class="flex items-stretch gap-4">
        <!-- Y-axis label -->
        <div class="flex flex-col items-center justify-between py-2 shrink-0 w-6">
          <span class="text-[10px] text-[var(--color-text-faint)]">&uarr;</span>
          <span class="text-[10px] text-[var(--color-text-faint)] [writing-mode:vertical-rl] rotate-180 tracking-[0.12em] uppercase">Indeterministic</span>
          <span class="text-[10px] text-[var(--color-text-faint)] [writing-mode:vertical-rl] rotate-180 tracking-[0.12em] uppercase mt-1">Deterministic</span>
          <span class="text-[10px] text-[var(--color-text-faint)]">&darr;</span>
        </div>

        <!-- Bands -->
        <div class="flex-1 flex flex-col gap-0">
          <!-- Neural Domain separator -->
          <div class="flex items-center gap-2 py-1">
            <div class="flex-1 h-px bg-[var(--color-border)]"></div>
            <span class="text-[10px] uppercase tracking-[0.1em] text-[var(--color-text-faint)] whitespace-nowrap">Neural Domain</span>
            <div class="flex-1 h-px bg-[var(--color-border)]"></div>
          </div>

          {HOURGLASS_BANDS.map((band, i) => (
            <>
              {band.id === 'I0' && (
                <div class="flex items-center gap-2 py-1">
                  <div class="flex-1 h-px bg-[var(--color-border)]"></div>
                  <span class="text-[10px] uppercase tracking-[0.1em] text-[var(--color-text-faint)] whitespace-nowrap">I0 — Interface Bottleneck</span>
                  <div class="flex-1 h-px bg-[var(--color-border)]"></div>
                </div>
              )}
              {band.id === 'S1' && (
                <div class="flex items-center gap-2 py-1">
                  <div class="flex-1 h-px bg-[var(--color-border)]"></div>
                  <span class="text-[10px] uppercase tracking-[0.1em] text-[var(--color-text-faint)] whitespace-nowrap">Synthetic Domain</span>
                  <div class="flex-1 h-px bg-[var(--color-border)]"></div>
                </div>
              )}
              <a
                href={`/lab/hourglass.html#${band.id}`}
                class="flex items-center gap-3 py-[3px] group cursor-pointer rounded hover:bg-black/[0.03] transition-all"
                title={band.description}
              >
                <span class="text-xs text-[var(--color-text-faint)] w-7 text-right font-mono shrink-0">{band.id}</span>
                <div class="flex-1 flex justify-center">
                  <div
                    class="h-7 rounded-[3px] transition-all group-hover:scale-[1.03] group-hover:brightness-110"
                    style={`width: ${HOURGLASS_WIDTHS[i]}%; background: ${band.color}30; border: 1px solid ${band.color}50;`}
                  ></div>
                </div>
                <span class="text-xs text-[var(--color-text-muted)] w-28 shrink-0 truncate group-hover:text-[var(--color-text-primary)] transition-colors">{band.name}</span>
              </a>
            </>
          ))}

          <!-- X-axis label -->
          <div class="text-center pt-3 pb-1">
            <div class="text-[10px] uppercase tracking-[0.15em] text-[var(--color-text-faint)]">&larr; Spatial Scale &rarr;</div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-8">
      <a href="/lab/hourglass.html" class="text-sm text-[var(--color-accent-primary)] hover:text-[var(--color-accent-secondary)] transition-colors">
        Explore the full interactive model &rarr;
      </a>
    </div>
  </section>

  <!-- ═══ PROJECT RUNEMATE ═══ -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <a href="/runemate/" class="block glass rounded-2xl p-8 sm:p-10 card-hover group relative overflow-hidden reveal" style="border: 1px solid rgba(139,92,246,0.2); background: linear-gradient(135deg, rgba(139,92,246,0.05) 0%, rgba(59,130,246,0.05) 100%);">
      <div class="absolute top-0 right-0 w-64 h-64 opacity-[0.03] pointer-events-none" style="background: radial-gradient(circle, var(--color-accent-tertiary), transparent 70%);"></div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-6">
        <div class="flex-1">
          <p class="text-xs font-semibold tracking-[0.15em] uppercase text-[var(--color-accent-tertiary)] mb-2">Applied Research</p>
          <h2 class="text-xl sm:text-2xl font-bold font-[family-name:var(--font-heading)] mb-3 group-hover:text-[var(--color-accent-tertiary)] transition-colors">
            Project Runemate
          </h2>
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed max-w-2xl">
            A bytecode compiler that compresses BCI data 65-90%, making post-quantum encryption viable on low-power implantable devices. Protecting patients from unauthorized neural access requires encryption that fits within the power constraints of a brain implant. Runemate demonstrates this is feasible. Written in Rust. 200 KB on-chip.
          </p>
        </div>
        <div class="text-[var(--color-accent-tertiary)] opacity-60 group-hover:opacity-100 transition-opacity shrink-0">
          <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
          </svg>
        </div>
      </div>
    </a>
  </section>

  <!-- ═══ ESSENTIAL READING ═══ -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
    <div class="flex items-center justify-between mb-8 reveal">
      <div>
        <h2 class="text-3xl font-bold font-[family-name:var(--font-heading)]">Essential Reading</h2>
        <p class="text-sm text-[var(--color-text-muted)] mt-1">Start here to understand the research.</p>
      </div>
      <a href="/news/" class="text-sm text-[var(--color-accent-primary)] hover:text-[var(--color-accent-secondary)] transition-colors">
        All posts &rarr;
      </a>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 reveal reveal-stagger">
      {essentialPosts.map((post) => (
        <PublicationCard
          title={post.data.title}
          date={post.data.date_posted || post.data.date || new Date()}
          tags={post.data.tags}
          slug={post.id}
          body={post.body || ''}
          compact
        />
      ))}
    </div>
  </section>

  <!-- ═══ CLOSING CTA ═══ -->
  <section class="border-t border-[var(--color-border)] bg-[var(--color-bg-deep)]">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center reveal">
      <h2 class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] mb-4">
        The research is open. Start anywhere.
      </h2>
      <p class="text-[var(--color-text-muted)] max-w-2xl mx-auto mb-8">
        No login, no paywall. Read the whitepaper, explore the threat atlas, or browse the governance framework. Everything is published for researchers, clinicians, and policymakers to evaluate, critique, and build upon.
      </p>
      <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
        <a
          href="/TARA/"
          class="px-8 py-3.5 rounded-lg bg-[var(--color-accent-primary)] text-white font-medium hover:bg-[var(--color-accent-primary)]/90 transition-colors"
        >
          Explore the Atlas
        </a>
        <a
          href="/governance/"
          class="px-8 py-3.5 rounded-lg glass text-[var(--color-text-primary)] font-medium hover:bg-white/10 transition-colors"
        >
          Read the Governance
        </a>
      </div>
    </div>
  </section>

  <Footer />
</BaseLayout>
