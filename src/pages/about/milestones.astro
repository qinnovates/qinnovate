---
import PageLayout from '../layouts/PageLayout.astro';
import data from '../data/milestones.json';
import { getRegistryStats, getTaraStats, getDsm5Stats } from '../lib/threat-data';

const milestones = data.timeline;

// Dynamic metrics from registry (single source of truth)
const reg = getRegistryStats();
const tara = getTaraStats();
const dsm5 = getDsm5Stats();

// Event-based data from structured arrays
const disclosures = data.disclosures ?? [];
const standards = data.standards ?? [];
const specifications = data.specifications ?? [];

// Computed counts — no hardcoded numbers
const exploitCount = disclosures.reduce((sum, d) => sum + (d.cwes?.length ?? 0), 0);

const metrics = {
  techniques_catalogued: reg.totalTechniques,
  tactics: reg.totalTactics,
  domains: (reg as any).total_domains ?? data.metrics.domains,
  cvss_vectors_mapped: reg.totalTechniques,
  niss_vectors_scored: reg.totalTechniques,
  therapeutic_mappings: tara.clinicalCount,
  dsm5_mapped: dsm5.withDsm5,
  vulnerabilities_found: disclosures.length,
  exploits_demonstrated: exploitCount,
  standards_submitted: standards.length,
  specifications_published: specifications.length,
};

// Sort timeline reverse chronological
const sorted = [...milestones].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Calculate span stats
const dates = milestones.map(m => new Date(m.date).getTime());
const firstDate = new Date(Math.min(...dates));
const lastDate = new Date(Math.max(...dates));
const daySpan = Math.max(1, Math.round((lastDate.getTime() - firstDate.getTime()) / (1000 * 60 * 60 * 24)));

// Category badge colors
const categoryColors: Record<string, { bg: string; text: string; border: string }> = {
  framework:  { bg: 'rgba(37, 99, 235, 0.1)',  text: '#2563eb', border: 'rgba(37, 99, 235, 0.25)' },
  protocol:   { bg: 'rgba(79, 70, 229, 0.1)',   text: '#4f46e5', border: 'rgba(79, 70, 229, 0.25)' },
  research:   { bg: 'rgba(217, 119, 6, 0.1)',    text: '#d97706', border: 'rgba(217, 119, 6, 0.25)' },
  scoring:    { bg: 'rgba(6, 182, 212, 0.1)',    text: '#0891b2', border: 'rgba(6, 182, 212, 0.25)' },
  security:   { bg: 'rgba(239, 68, 68, 0.1)',    text: '#ef4444', border: 'rgba(239, 68, 68, 0.25)' },
  standards:  { bg: 'rgba(16, 185, 129, 0.1)',   text: '#10b981', border: 'rgba(16, 185, 129, 0.25)' },
};

// Status badge styling
const statusColors: Record<string, { bg: string; text: string }> = {
  filed:     { bg: 'rgba(234, 179, 8, 0.15)',   text: '#eab308' },
  disclosed: { bg: 'rgba(249, 115, 22, 0.15)',  text: '#f97316' },
  assigned:  { bg: 'rgba(59, 130, 246, 0.15)',   text: '#3b82f6' },
  patched:   { bg: 'rgba(34, 197, 94, 0.15)',    text: '#22c55e' },
  submitted: { bg: 'rgba(234, 179, 8, 0.15)',   text: '#eab308' },
  accepted:  { bg: 'rgba(34, 197, 94, 0.15)',    text: '#22c55e' },
  published: { bg: 'rgba(34, 197, 94, 0.15)',    text: '#22c55e' },
};

function formatDate(dateStr: string): string {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Dashboard layout — registry metrics link to external pages, event metrics link to #anchors
const dashboardItems = [
  { label: 'Techniques Catalogued', value: metrics.techniques_catalogued, color: '#2563eb', href: '/TARA/' },
  { label: 'CVSS Vectors Mapped', sub: 'Industry severity scores', value: metrics.cvss_vectors_mapped, color: '#0891b2', href: '/scoring/' },
  { label: 'NISS Vectors Scored', sub: 'Neural-specific severity', value: metrics.niss_vectors_scored, color: '#7c3aed', href: '/scoring/' },
  { label: 'Therapeutic Mappings', sub: 'Clinical applications identified', value: metrics.therapeutic_mappings, color: '#d97706', href: '/TARA/#diagnostic' },
  { label: 'DSM-5-TR Mapped', sub: 'Psychiatric diagnosis links', value: metrics.dsm5_mapped, color: '#ec4899', href: '/whitepaper/#neural-impact' },
  { label: 'Exploits Demonstrated', sub: 'CWEs tested in practice', value: metrics.exploits_demonstrated, color: '#ef4444', href: '#disclosures' },
  { label: 'Vulnerabilities Found', value: metrics.vulnerabilities_found, color: '#f97316', href: '#disclosures' },
  { label: 'Standards Submitted', value: metrics.standards_submitted, color: '#10b981', href: '#standards' },
  { label: 'Specifications Published', value: metrics.specifications_published, color: '#4f46e5', href: '#specifications' },
];
---

<PageLayout
  title="Milestones"
  description="A timeline of QIF framework milestones — tracking progress from foundation to standards submission."
  breadcrumbs={[{ label: 'About', href: '/about/' }, { label: 'Milestones' }]}
>
  <div class="max-w-4xl">
    <!-- Hero -->
    <div class="mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold font-[family-name:var(--font-heading)] mb-4 uppercase tracking-tight">Milestones</h1>
      <p class="text-lg text-[var(--color-text-muted)] mb-6 max-w-2xl">
        Building the foundation for neural security, one breakthrough at a time. The following timeline tracks the derivation of the framework from zero to standard.
      </p>
      
      <!-- Chart Placeholder/Visualization -->
      <div class="glass rounded-2xl p-6 mb-8 border border-[var(--color-border)] relative overflow-hidden group">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-[var(--color-text-faint)]">Project Trajectory</h2>
          <div class="flex gap-4">
            <div class="flex items-center gap-1.5">
              <div class="w-2.5 h-2.5 rounded-full bg-[var(--color-accent-primary)]"></div>
              <span class="text-[10px] uppercase font-semibold text-[var(--color-text-faint)]">Techniques</span>
            </div>
            <div class="flex items-center gap-1.5">
              <div class="w-2.5 h-2.5 rounded-full bg-[var(--color-accent-secondary)]"></div>
              <span class="text-[10px] uppercase font-semibold text-[var(--color-text-faint)]">Specifications</span>
            </div>
          </div>
        </div>
        
        <div class="relative h-48 w-full flex items-end gap-[2%] px-2">
          {[...milestones].reverse().map((m, i) => {
            // Mock growth visual
            const height = Math.min(100, 20 + (i * (80 / milestones.length)));
            const isSpec = m.category === 'protocol' || m.category === 'standards';
            return (
              <div class="flex-1 flex flex-col items-center justify-end group/bar">
                <div 
                  class="w-full rounded-t-sm transition-all duration-500 group-hover/bar:brightness-125" 
                  style={`height: ${height}%; background: ${isSpec ? 'var(--color-accent-secondary)' : 'var(--color-accent-primary)'}; opacity: ${0.3 + (i / [...milestones].length) * 0.7}`}
                ></div>
                <div class="absolute -bottom-6 opacity-0 group-hover/bar:opacity-100 transition-opacity whitespace-nowrap text-[9px] font-mono text-[var(--color-text-faint)] rotate-45 origin-left">
                  {m.date.split('-').slice(1).join('/')}
                </div>
              </div>
            )
          })}
          <!-- Grid lines -->
          <div class="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-5 py-1">
            <div class="border-t border-white w-full"></div>
            <div class="border-t border-white w-full"></div>
            <div class="border-t border-white w-full"></div>
            <div class="border-t border-white w-full"></div>
          </div>
        </div>
        
        <div class="mt-8 flex items-center justify-between text-[var(--color-text-faint)]">
          <span class="text-[10px] font-mono uppercase tracking-tighter">Day 1</span>
          <span class="text-[10px] font-mono uppercase tracking-tighter">Day {daySpan}</span>
        </div>
      </div>

      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--color-bg-surface)] border border-[var(--color-border)]">
        <span class="text-sm font-medium text-[var(--color-text-primary)]">
          {milestones.length} milestones in {daySpan} days
        </span>
        <span class="text-xs text-[var(--color-text-faint)]">
          {formatDate(firstDate.toISOString().slice(0, 10))} &mdash; {formatDate(lastDate.toISOString().slice(0, 10))}
        </span>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="mb-12">
      <h2 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-4 text-[var(--color-text-primary)]">By the Numbers</h2>
      <div class="dashboard-grid">
        {dashboardItems.map((item) => (
          <a href={item.href} class="dashboard-card glass-subtle rounded-xl p-4">
            <div class="dashboard-value" style={`color: ${item.color};`}>
              {item.value}
            </div>
            <div class="dashboard-label">
              {item.label}
            </div>
            {item.sub && (
              <div class="dashboard-sub">{item.sub}</div>
            )}
          </a>
        ))}
      </div>
    </div>

    <!-- ═══ DETAIL SECTIONS ═══ -->

    <!-- Disclosures -->
    <section id="disclosures" class="mb-12">
      <h2 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-4 text-[var(--color-text-primary)]">
        Security Disclosures
      </h2>
      <div class="space-y-3">
        {disclosures.map((d) => {
          const sc = statusColors[d.status] || statusColors.disclosed;
          return (
            <div class="detail-card glass-subtle rounded-xl p-4 sm:p-5">
              <div class="flex flex-wrap items-center gap-2 mb-2">
                <span
                  class="text-xs font-semibold px-2 py-0.5 rounded-full capitalize"
                  style={`color: ${sc.text}; background-color: ${sc.bg};`}
                >
                  {d.status}
                </span>
                <time class="text-xs font-[family-name:var(--font-mono)] text-[var(--color-text-faint)]" datetime={d.date}>
                  {formatDate(d.date)}
                </time>
              </div>
              <h3 class="text-sm sm:text-base font-semibold text-[var(--color-text-primary)] mb-1">
                {d.href ? (
                  <a href={d.href} class="hover:text-[var(--color-accent-primary)] transition-colors">{d.title}</a>
                ) : d.title}
              </h3>
              <p class="text-xs sm:text-sm text-[var(--color-text-muted)] leading-relaxed mb-2">
                {d.summary}
              </p>
              <div class="flex flex-wrap gap-1.5">
                {d.cwes.map((cwe: string) => (
                  <span class="text-xs font-[family-name:var(--font-mono)] px-1.5 py-0.5 rounded bg-[var(--color-bg-deep)] text-[var(--color-text-faint)] border border-[var(--color-border)]">
                    {cwe}
                  </span>
                ))}
                {d.disclosed_to.map((org: string) => (
                  <span class="text-xs px-1.5 py-0.5 rounded bg-[var(--color-bg-surface)] text-[var(--color-text-faint)]">
                    {org}
                  </span>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </section>

    <!-- Standards -->
    <section id="standards" class="mb-12">
      <h2 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-4 text-[var(--color-text-primary)]">
        Standards Submissions
      </h2>
      <div class="space-y-3">
        {standards.map((s) => {
          const sc = statusColors[s.status] || statusColors.submitted;
          return (
            <a href={s.href} class="detail-card glass-subtle rounded-xl p-4 sm:p-5 block card-hover group">
              <div class="flex flex-wrap items-center gap-2 mb-2">
                <span
                  class="text-xs font-semibold px-2 py-0.5 rounded-full capitalize"
                  style={`color: ${sc.text}; background-color: ${sc.bg};`}
                >
                  {s.status}
                </span>
                <time class="text-xs font-[family-name:var(--font-mono)] text-[var(--color-text-faint)]" datetime={s.date}>
                  {formatDate(s.date)}
                </time>
              </div>
              <h3 class="text-sm sm:text-base font-semibold text-[var(--color-text-primary)] mb-1 group-hover:text-[var(--color-accent-primary)] transition-colors">
                {s.title} &rarr; {s.body}
              </h3>
              <p class="text-xs sm:text-sm text-[var(--color-text-muted)] leading-relaxed">
                {s.summary}
              </p>
            </a>
          );
        })}
      </div>
    </section>

    <!-- Specifications -->
    <section id="specifications" class="mb-12">
      <h2 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-4 text-[var(--color-text-primary)]">
        Published Specifications
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        {specifications.map((spec) => (
          <a href={spec.href} class="detail-card glass-subtle rounded-xl p-4 block card-hover group text-center">
            <div class="text-xs font-semibold text-[var(--color-accent-primary)] mb-1">v{spec.version}</div>
            <h3 class="text-sm font-semibold text-[var(--color-text-primary)] mb-1 group-hover:text-[var(--color-accent-primary)] transition-colors">
              {spec.title}
            </h3>
            <p class="text-xs text-[var(--color-text-faint)] leading-relaxed">
              {spec.summary}
            </p>
          </a>
        ))}
      </div>
    </section>

    <!-- Timeline -->
    <div class="mb-4">
      <h2 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-6 text-[var(--color-text-primary)]">Timeline</h2>
    </div>
    <div class="timeline-container">
      {sorted.map((milestone, i) => {
        const colors = categoryColors[milestone.category] || categoryColors.framework;
        return (
          <div class="timeline-item reveal" style={`--reveal-delay: ${i * 80}ms;`}>
            <!-- Timeline connector -->
            <div class="timeline-track">
              <div class="timeline-dot" style={`background-color: ${colors.text};`} />
              {i < sorted.length - 1 && <div class="timeline-line" />}
            </div>

            <!-- Card -->
            <a href={milestone.href} class="timeline-card glass-subtle rounded-xl p-5 sm:p-6 card-hover block group">
              <div class="flex flex-wrap items-center gap-3 mb-2">
                <time class="text-xs font-medium font-[family-name:var(--font-mono)] text-[var(--color-text-faint)]" datetime={milestone.date}>
                  {formatDate(milestone.date)}
                </time>
                <span
                  class="text-xs font-medium px-2 py-0.5 rounded-full border capitalize"
                  style={`color: ${colors.text}; background-color: ${colors.bg}; border-color: ${colors.border};`}
                >
                  {milestone.category}
                </span>
              </div>
              <h3 class="text-base sm:text-lg font-semibold font-[family-name:var(--font-heading)] mb-1.5 group-hover:text-[var(--color-accent-primary)] transition-colors">
                {milestone.title}
              </h3>
              <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
                {milestone.description}
              </p>
            </a>
          </div>
        );
      })}
    </div>
  </div>
</PageLayout>

<style>
  /* Dashboard */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
  }

  .dashboard-card {
    text-align: center;
    transition: transform 0.2s ease;
  }

  .dashboard-card:hover {
    transform: translateY(-2px);
  }

  .dashboard-value {
    font-size: 1.75rem;
    font-weight: 700;
    font-family: var(--font-mono);
    line-height: 1.2;
    margin-bottom: 0.25rem;
  }

  .dashboard-label {
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    line-height: 1.3;
  }

  .dashboard-sub {
    font-size: 0.55rem;
    color: var(--color-text-faint);
    margin-top: 0.15rem;
    line-height: 1.2;
  }

  @media (max-width: 639px) {
    .dashboard-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .dashboard-value {
      font-size: 1.35rem;
    }

    .dashboard-label {
      font-size: 0.6rem;
    }
  }

  /* Detail sections */
  .detail-card {
    transition: transform 0.15s ease;
  }

  .detail-card:hover {
    transform: translateY(-1px);
  }

  /* Timeline */
  .timeline-container {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0;
    padding-bottom: 4rem;
  }

  .timeline-item {
    display: grid;
    grid-template-columns: 24px 1fr;
    gap: 1rem;
    transition-delay: var(--reveal-delay, 0ms);
  }

  .timeline-track {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .timeline-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-top: 1.5rem;
    flex-shrink: 0;
    z-index: 1;
  }

  .timeline-line {
    width: 2px;
    flex-grow: 1;
    background-color: var(--color-border);
    margin-top: 0.5rem;
  }

  .timeline-card {
    margin-bottom: 1rem;
  }

  @media (max-width: 639px) {
    .timeline-item {
      grid-template-columns: 16px 1fr;
      gap: 0.75rem;
    }

    .timeline-dot {
      width: 8px;
      height: 8px;
      margin-top: 1.25rem;
    }
  }
</style>
