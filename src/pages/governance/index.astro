---
import PageLayout from '../../layouts/PageLayout.astro';
import { getCollection, render } from 'astro:content';

const docs = await getCollection('governance');
const sorted = docs.sort((a, b) => (a.data.order ?? 99) - (b.data.order ?? 99));

// Build lookup
const byId: Record<string, typeof sorted[number]> = {};
for (const doc of sorted) {
  byId[doc.id] = doc;
}

// Ordered sections for the wiki â€” each category groups related docs
const categories = [
  {
    label: 'Core Standards',
    color: 'var(--color-accent-primary)',
    ids: ['code_of_conduct', 'transparency', 'data_policy_faq', 'accessibility'],
  },
  {
    label: 'Ethics & Rights',
    color: 'var(--color-accent-tertiary)',
    ids: ['neuroethics_alignment', 'informed_consent_framework', 'pediatric_considerations', 'post_deployment_ethics'],
  },
  {
    label: 'Compliance & Alignment',
    color: 'var(--color-accent-secondary)',
    ids: ['regulatory_compliance', 'neurosecurity-grc', 'neurosecurity_grc_convergence', 'unesco_alignment', 'qif-neuroethics'],
  },
  {
    label: 'Future Work',
    color: 'var(--color-text-faint)',
    ids: ['ethical-neurosecurity-code-of-ethics'],
    note: 'A neurosecurity-specific code of ethics (adapted from ISC2/CEH models) is a long-term goal. The priority is converging existing GRC frameworks (NIST SP 800-53, ISO 27001, FDA/FDORA) into neurosecurity GRC first. Build the compliance foundation, then codify the professional ethics on top.',
  },
];

// Map content IDs to actual GitHub filenames
const idToFilename: Record<string, string> = {};
for (const doc of sorted) {
  // IDs with hyphens keep hyphens; IDs with underscores keep underscores
  // The actual files are UPPERCASE with the original separator
  const name = doc.id.includes('-')
    ? doc.id.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('-').toUpperCase()
    : doc.id.toUpperCase();
  idToFilename[doc.id] = `${name}.md`;
}
// Fix special cases where auto-mapping doesn't work
idToFilename['ethical-neurosecurity-code-of-ethics'] = 'ETHICAL-NEUROSECURITY-CODE-OF-ETHICS.md';
idToFilename['neurosecurity-grc'] = 'NEUROSECURITY-GRC.md';
idToFilename['qif-neuroethics'] = 'QIF-NEUROETHICS.md';
idToFilename['neurosecurity_grc_convergence'] = 'NEUROSECURITY_GRC_CONVERGENCE.md';

// Pre-render all docs
const rendered: Record<string, Awaited<ReturnType<typeof render>>> = {};
for (const doc of sorted) {
  rendered[doc.id] = await render(doc);
}
---

<PageLayout
  title="Governance Wiki"
  description="Ethics, compliance, and transparency documents governing the QIF Framework and Qinnovate standards development."
  breadcrumbs={[{ label: 'Governance' }]}
  wide={true}
>
  <div class="mb-8 reveal">
    <h1 class="text-3xl sm:text-4xl font-bold font-[family-name:var(--font-heading)] mb-4">Governance</h1>
    <p class="text-lg text-[var(--color-text-muted)] max-w-3xl">
      Ethics, compliance, and transparency documents governing the QIF Framework and Qinnovate standards development.
      It may not all be implemented fully yet, but this is the foundational work for what's to come.
    </p>
    <p class="text-sm text-[var(--color-text-faint)] mt-2 max-w-3xl">
      Initial drafts are synthesized by the author with AI assistance. Final versions require human collaborators and reviewers to identify gaps, errors, and cognitive biases. See the <a href="#transparency" class="text-[var(--color-accent-primary)] hover:underline">Transparency Statement</a> for a full audit trail.
    </p>
    <a
      href="https://github.com/qinnovates/qinnovate/tree/main/governance"
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex items-center gap-1.5 mt-3 text-sm text-[var(--color-text-muted)] hover:text-[var(--color-accent-primary)] transition-colors"
    >
      <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      View source on GitHub &rarr;
    </a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-8">
    <!-- Sticky sidebar TOC -->
    <nav class="hidden lg:block">
      <div class="sticky top-24 max-h-[80vh] overflow-y-auto pr-2">
        <p class="text-xs font-semibold uppercase tracking-wider text-[var(--color-text-faint)] mb-3">Contents</p>
        {categories.map((cat) => (
          <div class="mb-4">
            <p class="text-xs font-semibold uppercase tracking-wider mb-1.5" style={`color: ${cat.color}`}>
              {cat.label}
            </p>
            <ul class="space-y-1">
              {cat.ids.map((id) => {
                const doc = byId[id];
                if (!doc) return null;
                return (
                  <li>
                    <a
                      href={`#${doc.id}`}
                      class="gov-toc-link block text-sm text-[var(--color-text-faint)] hover:text-[var(--color-accent-primary)] transition-colors py-0.5 border-l-2 border-transparent pl-2 hover:border-[var(--color-accent-primary)]"
                      data-section={doc.id}
                    >
                      {doc.data.title}
                    </a>
                  </li>
                );
              })}
            </ul>
          </div>
        ))}
      </div>
    </nav>

    <!-- Mobile TOC (collapsible) -->
    <details class="lg:hidden glass-subtle rounded-xl p-4 mb-4 col-span-full">
      <summary class="text-sm font-semibold cursor-pointer text-[var(--color-text-muted)]">Table of Contents</summary>
      <div class="mt-3 space-y-3">
        {categories.map((cat) => (
          <div>
            <p class="text-xs font-semibold uppercase tracking-wider mb-1" style={`color: ${cat.color}`}>{cat.label}</p>
            <ul class="space-y-1">
              {cat.ids.map((id) => {
                const doc = byId[id];
                if (!doc) return null;
                return (
                  <li><a href={`#${doc.id}`} class="text-sm text-[var(--color-text-faint)] hover:text-[var(--color-accent-primary)]">{doc.data.title}</a></li>
                );
              })}
            </ul>
          </div>
        ))}
      </div>
    </details>

    <!-- Main content: all docs rendered inline -->
    <div class="min-w-0">
      {categories.map((cat) => (
        <div class="mb-12">
          <h2 class="text-sm font-semibold uppercase tracking-wider mb-3" style={`color: ${cat.color}`}>
            {cat.label}
          </h2>
          {cat.note && (
            <p class="text-xs text-[var(--color-text-faint)] mb-6 max-w-2xl italic">{cat.note}</p>
          )}

          {cat.ids.map((id) => {
            const doc = byId[id];
            if (!doc) return null;
            const { Content } = rendered[doc.id];
            return (
              <section id={doc.id} class="mb-12 scroll-mt-24">
                <div class="flex items-start justify-between gap-4 mb-4">
                  <h3 class="text-2xl font-bold font-[family-name:var(--font-heading)]">
                    {doc.data.title}
                  </h3>
                  <a
                    href={`https://github.com/qinnovates/qinnovate/blob/main/governance/${idToFilename[doc.id]}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="shrink-0 text-xs text-[var(--color-text-faint)] hover:text-[var(--color-accent-primary)] transition-colors flex items-center gap-1 mt-1"
                    title="Edit on GitHub"
                  >
                    <svg class="w-3.5 h-3.5" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                    Edit
                  </a>
                </div>
                {doc.data.description && (
                  <p class="text-sm text-[var(--color-text-muted)] italic mb-4">{doc.data.description}</p>
                )}
                <div class="prose prose-sm [&>h1]:hidden">
                  <Content />
                </div>
                <hr class="border-[var(--color-border)]/30 mt-8" />
              </section>
            );
          })}
        </div>
      ))}
    </div>
  </div>

  <!-- IntersectionObserver for active TOC highlighting -->
  <script>
    function initGovToc() {
      const sections = document.querySelectorAll('section[id]');
      const links = document.querySelectorAll('.gov-toc-link');
      if (!sections.length || !links.length) return;

      const observer = new IntersectionObserver(
        (entries) => {
          for (const entry of entries) {
            if (entry.isIntersecting) {
              links.forEach((l) => {
                const el = l as HTMLElement;
                if (el.dataset.section === entry.target.id) {
                  el.classList.add('text-[var(--color-accent-primary)]', 'border-[var(--color-accent-primary)]');
                  el.classList.remove('text-[var(--color-text-faint)]', 'border-transparent');
                } else {
                  el.classList.remove('text-[var(--color-accent-primary)]', 'border-[var(--color-accent-primary)]');
                  el.classList.add('text-[var(--color-text-faint)]', 'border-transparent');
                }
              });
            }
          }
        },
        { rootMargin: '-20% 0px -60% 0px' }
      );

      sections.forEach((s) => observer.observe(s));
    }

    document.addEventListener('astro:page-load', initGovToc);
    initGovToc();
  </script>
</PageLayout>
