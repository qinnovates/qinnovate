---
import PageLayout from '../../layouts/PageLayout.astro';
import { THREAT_VECTORS, SEVERITY_COLORS } from '../../lib/threat-data';

export function getStaticPaths() {
  return THREAT_VECTORS.map((threat) => ({
    params: { id: threat.id },
    props: { threat },
  }));
}

const { threat } = Astro.props;
const severityColor = SEVERITY_COLORS[threat.severity] || SEVERITY_COLORS.low;

const NEURORIGHT_LABELS: Record<string, string> = {
  MP: 'Mental Privacy', CL: 'Cognitive Liberty', MI: 'Mental Integrity',
  PC: 'Psychological Continuity', CA: 'Cognitive Authenticity',
  DI: 'Dynamical Integrity', IDA: 'Informational Disassociation',
};

const REQ_LABELS: Record<string, string> = {
  TM: 'Threat Modeling', VA: 'Vulnerability Assessment',
  SBOM: 'Software BOM', SA: 'Security Architecture', PM: 'Post-Market Monitoring',
};

const nr = threat.neurorights as { affected: string[]; cci: number } | null;
const reg = (threat.regulatory as any)?.fdora_524b as {
  cyber_device: boolean;
  prongs: { software: boolean; network_connectable: boolean; vulnerable: boolean };
  applicable_requirements: string[];
  coverage_score: number;
  gaps: string[];
} | null;
const hasGovernance = nr || reg;
---

<PageLayout
  title={`${threat.id}: ${threat.name} | TARA Atlas`}
  description={threat.description}
  breadcrumbs={[
    { label: 'Explore', href: '/explore/' },
    { label: 'TARA', href: '/TARA/' },
    { label: threat.id }
  ]}
  maxWidth="narrow"
>
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-2">
      <h1 class="text-3xl font-bold font-mono">{threat.id}</h1>
      <span
        class="px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider border"
        style={`background:${severityColor.bg}; color:${severityColor.text}; border-color:${severityColor.border}`}
      >
        {threat.severity}
      </span>
    </div>
    <h2 class="text-2xl font-bold text-[var(--color-text-primary)] mb-4">{threat.name}</h2>
    <p class="text-lg text-[var(--color-text-muted)] leading-relaxed mb-6">
      {threat.description}
    </p>

    <!-- Metadata Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
      <div class="glass-subtle rounded-lg p-4">
        <h3 class="text-xs font-bold uppercase text-[var(--color-text-faint)] mb-2">Technique Details</h3>
        <dl class="text-sm space-y-2">
          <div class="flex justify-between">
            <dt class="text-[var(--color-text-muted)]">Tactic</dt>
            <dd class="font-mono">{threat.tactic}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-[var(--color-text-muted)]">Status</dt>
            <dd>{threat.status}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-[var(--color-text-muted)]">Bands</dt>
            <dd>{threat.bands.join(', ')}</dd>
          </div>
        </dl>
      </div>

      <div class="glass-subtle rounded-lg p-4">
        <h3 class="text-xs font-bold uppercase text-[var(--color-text-faint)] mb-2">Scoring</h3>
        <div class="text-sm space-y-2">
           <div>
             <span class="text-[var(--color-text-muted)] block text-xs">NISS v1.0</span>
             <code class="text-xs break-all">{threat.niss.vector}</code>
           </div>
           {threat.cvss && (
             <div>
               <span class="text-[var(--color-text-muted)] block text-xs">CVSS v4.0</span>
               <code class="text-xs break-all">{threat.cvss.base_vector}</code>
             </div>
           )}
        </div>
      </div>
    </div>

    <!-- Dual Use Section -->
    {threat.tara && (
      <div class="glass rounded-xl p-6 border-l-4 border-green-500 mb-8">
        <h3 class="text-lg font-bold text-[var(--color-text-primary)] mb-3 flex items-center gap-2">
          <span class="text-green-500">✚</span> Therapeutic Application
        </h3>
        <p class="text-sm text-[var(--color-text-muted)] mb-4">{threat.tara.mechanism}</p>

        {threat.tara.clinical && (
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <h4 class="text-xs font-bold uppercase text-[var(--color-text-faint)] mb-1">Clinical Analog</h4>
              <p class="text-sm font-medium">{threat.tara.clinical.therapeutic_analog}</p>
            </div>
            <div>
              <h4 class="text-xs font-bold uppercase text-[var(--color-text-faint)] mb-1">Treats</h4>
              <ul class="text-sm list-disc pl-4 text-[var(--color-text-muted)]">
                {threat.tara.clinical.conditions.map(c => <li>{c}</li>)}
              </ul>
            </div>
          </div>
        )}
      </div>
    )}

    <!-- Governance Section -->
    {hasGovernance && (
      <div class="glass rounded-xl p-6 border-l-4 border-purple-500 mb-8">
        <h3 class="text-lg font-bold text-[var(--color-text-primary)] mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgb(168,85,247)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          Governance
        </h3>

        <div class="space-y-5">
          {/* --- Neurorights --- */}
          {nr && nr.affected.length > 0 && (
            <div>
              <h4 class="text-xs font-bold uppercase tracking-wider text-[var(--color-text-faint)] mb-2">Neurorights Impact</h4>
              <div class="flex flex-wrap gap-1.5 mb-3">
                {nr.affected.map((code: string) => (
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-purple-500/10 text-purple-400 border border-purple-500/20">
                    <span class="font-bold">{code}</span>
                    <span class="text-purple-400/70">{NEURORIGHT_LABELS[code] ?? code}</span>
                  </span>
                ))}
              </div>
              <div class="flex items-center gap-3 text-sm">
                <span class="text-[var(--color-text-muted)]">Consent Complexity</span>
                <div class="flex items-center gap-2 flex-1">
                  <div class="flex-1 h-1.5 rounded-full bg-[var(--color-border)] overflow-hidden max-w-[120px]">
                    <div
                      class="h-full rounded-full"
                      style={`width: ${Math.min(nr.cci / 4 * 100, 100)}%; background: ${nr.cci >= 2.0 ? 'rgb(239,68,68)' : nr.cci >= 1.0 ? 'rgb(234,179,8)' : 'rgb(34,197,94)'}`}
                    />
                  </div>
                  <span class={`font-mono font-bold text-xs ${nr.cci >= 2.0 ? 'text-red-400' : nr.cci >= 1.0 ? 'text-yellow-400' : 'text-green-400'}`}>
                    {nr.cci.toFixed(2)}
                  </span>
                  <span class="text-[var(--color-text-faint)] text-xs">/ 4.0</span>
                </div>
              </div>
            </div>
          )}

          {/* --- Divider between sub-sections --- */}
          {nr && nr.affected.length > 0 && reg && (
            <hr class="border-[var(--color-border)] opacity-50" />
          )}

          {/* --- FDORA §3305 Regulatory --- */}
          {reg && (
            <div>
              <h4 class="text-xs font-bold uppercase tracking-wider text-[var(--color-text-faint)] mb-2">FDORA §3305 Compliance</h4>

              {/* Cyber Device Status */}
              <div class="flex items-center gap-2 mb-3">
                <span class={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold ${reg.cyber_device ? 'bg-blue-500/15 text-blue-400 border border-blue-500/25' : 'bg-[var(--color-border)] text-[var(--color-text-faint)] border border-transparent'}`}>
                  {reg.cyber_device ? 'Cyber Device' : 'Non-Cyber Device'}
                </span>
                {!reg.cyber_device && (
                  <span class="text-xs text-[var(--color-text-faint)]">
                    (missing: {[
                      !reg.prongs.software && 'software',
                      !reg.prongs.network_connectable && 'network',
                    ].filter(Boolean).join(', ')})
                  </span>
                )}
              </div>

              {/* Coverage Score */}
              <div class="flex items-center gap-3 text-sm mb-3">
                <span class="text-[var(--color-text-muted)]">Regulatory Coverage</span>
                <div class="flex items-center gap-2 flex-1">
                  <div class="flex-1 h-1.5 rounded-full bg-[var(--color-border)] overflow-hidden max-w-[120px]">
                    <div
                      class="h-full rounded-full"
                      style={`width: ${reg.coverage_score * 100}%; background: ${reg.coverage_score >= 0.7 ? 'rgb(34,197,94)' : reg.coverage_score >= 0.4 ? 'rgb(234,179,8)' : 'rgb(239,68,68)'}`}
                    />
                  </div>
                  <span class={`font-mono font-bold text-xs ${reg.coverage_score >= 0.7 ? 'text-green-400' : reg.coverage_score >= 0.4 ? 'text-yellow-400' : 'text-red-400'}`}>
                    {reg.coverage_score.toFixed(1)}
                  </span>
                  <span class="text-[var(--color-text-faint)] text-xs">/ 1.0</span>
                </div>
              </div>

              {/* 524B Requirements */}
              {reg.applicable_requirements.length > 0 && (
                <div class="mb-3">
                  <span class="text-xs text-[var(--color-text-muted)] block mb-1">524B Requirements</span>
                  <div class="flex flex-wrap gap-1.5">
                    {reg.applicable_requirements.map((r: string) => (
                      <span class="px-1.5 py-0.5 rounded text-xs font-mono bg-[var(--color-border)] text-[var(--color-text-muted)]" title={REQ_LABELS[r] ?? r}>
                        {r}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Gaps */}
              {reg.gaps.length > 0 && (
                <div>
                  <span class="text-xs text-[var(--color-text-muted)] block mb-1">Regulatory Gaps</span>
                  <ul class="space-y-1">
                    {reg.gaps.map((gap: string) => (
                      <li class="text-xs text-[var(--color-text-faint)] flex items-start gap-1.5">
                        <span class="text-yellow-500 mt-0.5 shrink-0">!</span>
                        <span>{gap}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    )}

    <!-- GitHub Edit Link -->
    <div class="mt-12 pt-6 border-t border-[var(--color-border)] flex justify-between items-center text-sm">
      <span class="text-[var(--color-text-faint)]">QIF Standardization Body</span>
      <a
        href={`https://github.com/qinnovates/qinnovate/blob/main/shared/qtara-registrar.json`}
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center gap-2 text-[var(--color-accent-primary)] hover:underline"
      >
        <span>Edit this on GitHub</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 3C6.77 6.5 6.73 6.6 7 2.5c0-1.5 1-2.5 1-2.5 0-1.15 0-2.35 0-3.5-.73 1.02-1.08 2.25-1 3.5-.32 1.48-.32 3 0 4.5.27 1.4.35 2.85 1 5.5v4"></path></svg>
      </a>
    </div>

  </div>
</PageLayout>
