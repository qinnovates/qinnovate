---
import PageLayout from '../layouts/PageLayout.astro';
import { COHERENCE, SCALE_FREQUENCY } from '../lib/qif-constants';
import BrainVisualization from '../components/brain/BrainVisualization';
import { getBrainViewData } from '../lib/brain-view-data';

const brainViews = getBrainViewData();
---

<PageLayout
  title="Security — Qinnovate"
  description="How QIF protects neural interfaces — signal coherence authentication, frequency-band defense mapping, and the security architecture behind the hourglass model."
  breadcrumbs={[{ label: 'Security' }]}
>
  <div class="mb-12">
    <h1 class="text-3xl sm:text-4xl font-bold font-[family-name:var(--font-heading)] mb-4">Security</h1>
    <p class="text-lg text-[var(--color-text-muted)] max-w-3xl">
      QIF's security architecture protects neural interfaces across three domains: real-time signal authentication, layered frequency-band defense, and threat-mapped scoring. These are the mechanisms that determine whether a neural signal is legitimate or tampered with.
    </p>
  </div>

  <!-- Brain Visualization -->
  <section class="mb-16">
    <BrainVisualization client:only="react" views={brainViews} defaultView="security" />
  </section>

  <!-- Signal Authentication -->
  <section class="mb-16">
    <h2 class="text-2xl font-semibold font-[family-name:var(--font-heading)] mb-2">Signal Authentication</h2>
    <p class="text-[var(--color-text-muted)] mb-8 max-w-3xl">
      The coherence metric <span class="font-[family-name:var(--font-mono)] text-[var(--color-accent-secondary)]">C<sub>s</sub></span> measures whether a neural signal is authentic by evaluating three variance dimensions. When coherence drops below threshold, the system flags or rejects the signal — the same way a spam filter catches forged emails, but for brain signals.
    </p>

    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Coherence Calculator -->
      <div class="glass rounded-xl p-8" id="coherence-calc">
        <h3 class="text-xl font-semibold font-[family-name:var(--font-heading)] mb-2">Coherence Calculator</h3>
        <p class="text-sm text-[var(--color-text-muted)] mb-6">
          Adjust variance parameters to compute the coherence metric in real time. Higher variance means more signal degradation.
        </p>

        <div class="space-y-6">
          <!-- Phase variance slider -->
          <div>
            <div class="flex justify-between text-sm mb-2">
              <label for="sigma-phi" class="text-[var(--color-text-muted)]">Phase variance (&sigma;&sup2;&psi;)</label>
              <span id="sigma-phi-val" class="font-[family-name:var(--font-mono)] text-[var(--color-accent-secondary)]">0.10</span>
            </div>
            <input type="range" id="sigma-phi" min="0" max="2" step="0.01" value="0.10" class="w-full accent-[var(--color-accent-secondary)]" />
          </div>

          <!-- Temporal variance slider -->
          <div>
            <div class="flex justify-between text-sm mb-2">
              <label for="sigma-tau" class="text-[var(--color-text-muted)]">Temporal variance (&sigma;&sup2;&tau;)</label>
              <span id="sigma-tau-val" class="font-[family-name:var(--font-mono)] text-[var(--color-accent-secondary)]">0.10</span>
            </div>
            <input type="range" id="sigma-tau" min="0" max="2" step="0.01" value="0.10" class="w-full accent-[var(--color-accent-secondary)]" />
          </div>

          <!-- Spatial variance slider -->
          <div>
            <div class="flex justify-between text-sm mb-2">
              <label for="sigma-gamma" class="text-[var(--color-text-muted)]">Spatial variance (&sigma;&sup2;&gamma;)</label>
              <span id="sigma-gamma-val" class="font-[family-name:var(--font-mono)] text-[var(--color-accent-secondary)]">0.10</span>
            </div>
            <input type="range" id="sigma-gamma" min="0" max="2" step="0.01" value="0.10" class="w-full accent-[var(--color-accent-secondary)]" />
          </div>

          <!-- Result -->
          <div class="glass rounded-lg p-6 text-center">
            <div class="text-xs text-[var(--color-text-faint)] mb-2 font-[family-name:var(--font-mono)]">
              {COHERENCE.formula}
            </div>
            <div class="text-4xl font-bold font-[family-name:var(--font-heading)]" id="coherence-result">
              0.741
            </div>
            <div class="text-sm font-medium mt-2" id="coherence-status">
              Coherent
            </div>
            <div class="w-full h-2 rounded-full bg-[var(--color-bg-deep)] mt-4">
              <div id="coherence-bar" class="h-full rounded-full transition-all duration-300" style="width: 74.1%; background-color: #10b981;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Decision thresholds -->
      <div class="glass rounded-xl p-8">
        <h3 class="text-xl font-semibold font-[family-name:var(--font-heading)] mb-2">Decision Thresholds</h3>
        <p class="text-sm text-[var(--color-text-muted)] mb-6">
          How NSP (Neural Security Protocol) responds to coherence levels in real time.
        </p>

        <div class="space-y-4">
          <div class="glass rounded-lg p-4 border-l-4" style="border-color: #10b981;">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-semibold" style="color: #10b981;">High Coherence</span>
              <span class="text-xs font-[family-name:var(--font-mono)] text-[var(--color-text-faint)]">C<sub>s</sub> &gt; 0.6</span>
            </div>
            <p class="text-xs text-[var(--color-text-muted)]">Signal accepted. Authenticated signals pass through. Invalid auth triggers alert.</p>
          </div>
          <div class="glass rounded-lg p-4 border-l-4" style="border-color: #f59e0b;">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-semibold" style="color: #f59e0b;">Medium Coherence</span>
              <span class="text-xs font-[family-name:var(--font-mono)] text-[var(--color-text-faint)]">0.3 &lt; C<sub>s</sub> &lt; 0.6</span>
            </div>
            <p class="text-xs text-[var(--color-text-muted)]">Gateway zone. Valid auth accepted with flag for review. Invalid auth rejected with alert.</p>
          </div>
          <div class="glass rounded-lg p-4 border-l-4" style="border-color: #ef4444;">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-semibold" style="color: #ef4444;">Low Coherence</span>
              <span class="text-xs font-[family-name:var(--font-mono)] text-[var(--color-text-faint)]">C<sub>s</sub> &lt; 0.3</span>
            </div>
            <p class="text-xs text-[var(--color-text-muted)]">Breach detected. All signals rejected regardless of authentication. Critical alert raised.</p>
          </div>
        </div>

        <div class="mt-6 p-4 rounded-lg bg-[var(--color-bg-deep)]">
          <p class="text-xs text-[var(--color-text-faint)]">
            <strong class="text-[var(--color-text-muted)]">Biological basis:</strong> Phase coherence follows Fries' Communication Through Coherence (2005/2015). STDP windows of &plusmn;10&ndash;20 ms (Markram 1997, Bi &amp; Poo 1998) provide the timing constraint. The exponential form is a Boltzmann factor — the same mathematical structure as thermal physics and Shannon entropy.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Scale-Frequency Defense -->
  <section class="mb-16">
    <h2 class="text-2xl font-semibold font-[family-name:var(--font-heading)] mb-2">Scale-Frequency Defense Mapping</h2>
    <p class="text-[var(--color-text-muted)] mb-8 max-w-3xl">
      Neural oscillation bands operate at different frequencies and spatial scales. Each band represents a distinct attack surface — and a distinct layer of defense in the hourglass model.
    </p>

    <div class="glass rounded-xl p-8 max-w-2xl">
      <!-- Visual representation -->
      <div class="space-y-4 mb-8">
        {SCALE_FREQUENCY.bands.map((band) => {
          const maxExtent = 20;
          const extent = parseFloat(band.extent.replace(/[^0-9.]/g, ''));
          const percent = (extent / maxExtent) * 100;
          const freqParts = band.frequency.split('-');
          const maxFreq = parseFloat(freqParts[freqParts.length - 1]);
          const hue = maxFreq > 30 ? 280 : maxFreq > 8 ? 180 : maxFreq > 4 ? 200 : 220;
          return (
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="font-medium">{band.name}</span>
                <span class="text-[var(--color-text-faint)] font-[family-name:var(--font-mono)] text-xs">
                  {band.frequency} &middot; {band.extent}
                </span>
              </div>
              <div class="w-full h-8 rounded bg-[var(--color-bg-deep)] relative overflow-hidden">
                <div
                  class="h-full rounded flex items-center px-3 text-xs font-[family-name:var(--font-mono)] text-white/80"
                  style={`width: ${percent}%; background: linear-gradient(90deg, hsl(${hue}, 60%, 40%), hsl(${hue}, 60%, 30%));`}
                >
                  k &asymp; {band.k}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <div class="glass rounded-lg p-4 text-center">
        <p class="text-sm font-[family-name:var(--font-mono)] text-[var(--color-accent-tertiary)]">
          v = f &times; &lambda; &ensp;&rarr;&ensp; k &asymp; {SCALE_FREQUENCY.k_range}
        </p>
        <p class="text-xs text-[var(--color-text-faint)] mt-1">
          The product of frequency and spatial extent is approximately constant across neural bands.
        </p>
      </div>
    </div>
  </section>

  <!-- Security Architecture Links -->
  <section>
    <h2 class="text-2xl font-semibold font-[family-name:var(--font-heading)] mb-6">Security Architecture</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <a href="/framework/" class="glass rounded-xl p-6 block group hover:translate-y-[-2px] transition-transform">
        <h3 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-2 group-hover:text-[var(--color-accent-secondary)] transition-colors">QIF Framework</h3>
        <p class="text-sm text-[var(--color-text-muted)]">The 11-band hourglass architecture — layered defense from electromagnetic fields to cognitive state.</p>
      </a>
      <a href="/nsp/" class="glass rounded-xl p-6 block group hover:translate-y-[-2px] transition-transform">
        <h3 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-2 group-hover:text-[var(--color-accent-secondary)] transition-colors">NSP Protocol</h3>
        <p class="text-sm text-[var(--color-text-muted)]">Secure communication protocol for neural implants, built on coherence-based signal authentication.</p>
      </a>
      <a href="/scoring/" class="glass rounded-xl p-6 block group hover:translate-y-[-2px] transition-transform">
        <h3 class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-2 group-hover:text-[var(--color-accent-secondary)] transition-colors">NISS Scoring</h3>
        <p class="text-sm text-[var(--color-text-muted)]">Neural Impact Scoring System — vulnerability severity for brains, not servers.</p>
      </a>
    </div>
  </section>
</PageLayout>

<script>
  const sliders = ['sigma-phi', 'sigma-tau', 'sigma-gamma'].map((id) => ({
    input: document.getElementById(id) as HTMLInputElement,
    display: document.getElementById(`${id}-val`) as HTMLElement,
  }));

  const result = document.getElementById('coherence-result')!;
  const status = document.getElementById('coherence-status')!;
  const bar = document.getElementById('coherence-bar')!;

  function updateCoherence() {
    const values = sliders.map((s) => parseFloat(s.input.value));
    values.forEach((v, i) => {
      sliders[i].display.textContent = v.toFixed(2);
    });

    const sum = values.reduce((a, b) => a + b, 0);
    const cs = Math.exp(-sum);

    result.textContent = cs.toFixed(3);
    bar.style.width = `${cs * 100}%`;

    if (cs > 0.6) {
      result.style.color = '#10b981';
      status.textContent = 'Coherent';
      status.style.color = '#10b981';
      bar.style.backgroundColor = '#10b981';
    } else if (cs > 0.3) {
      result.style.color = '#f59e0b';
      status.textContent = 'Gateway';
      status.style.color = '#f59e0b';
      bar.style.backgroundColor = '#f59e0b';
    } else {
      result.style.color = '#ef4444';
      status.textContent = 'Breach';
      status.style.color = '#ef4444';
      bar.style.backgroundColor = '#ef4444';
    }
  }

  sliders.forEach((s) => {
    s.input.addEventListener('input', updateCoherence);
  });

  updateCoherence();
</script>
