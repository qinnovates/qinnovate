---
import PageLayout from '../layouts/PageLayout.astro';
import {
  THREAT_VECTORS,
  DIAGNOSTIC_CLUSTER_COLORS,
  DIAGNOSTIC_CLUSTER_LABELS,
  SEVERITY_COLORS,
  getDsm5Stats,
} from '../lib/threat-data';
import type { ThreatVector, DiagnosticCluster, Dsm5Diagnosis, Dsm5RiskClass, Dsm5Confidence } from '../lib/threat-data';

const stats = getDsm5Stats();
const totalTechniques = THREAT_VECTORS.length;

// Get all techniques with DSM-5 mappings
const dsm5Techniques = THREAT_VECTORS.filter(t => t.tara?.dsm5?.primary?.length > 0);

// Risk class breakdown
const riskClassGroups: { key: Dsm5RiskClass; label: string; description: string; count: number }[] = [
  { key: 'direct', label: 'Direct Risk', description: 'The attack mechanism directly causes the psychiatric outcome through a documented neural pathway.', count: stats.riskClass.direct },
  { key: 'indirect', label: 'Indirect Risk', description: 'The psychiatric outcome arises secondary to the primary neurological disruption.', count: stats.riskClass.indirect },
];

// Cluster breakdown
const clusterGroups: { key: DiagnosticCluster; label: string; count: number }[] = (
  Object.entries(stats.clusters) as [DiagnosticCluster, number][]
)
  .filter(([, count]) => count > 0)
  .sort((a, b) => b[1] - a[1])
  .map(([key, count]) => ({
    key,
    label: DIAGNOSTIC_CLUSTER_LABELS[key],
    count,
  }));

// Collect all unique DSM-5 diagnoses with their linked techniques
const diagnosisMap = new Map<string, { diagnosis: Dsm5Diagnosis; techniques: ThreatVector[]; isPrimary: boolean[] }>();
for (const t of dsm5Techniques) {
  const dsm = t.tara!.dsm5!;
  for (const d of dsm.primary) {
    const existing = diagnosisMap.get(d.code);
    if (existing) {
      existing.techniques.push(t);
      existing.isPrimary.push(true);
    } else {
      diagnosisMap.set(d.code, { diagnosis: d, techniques: [t], isPrimary: [true] });
    }
  }
  for (const d of dsm.secondary ?? []) {
    const existing = diagnosisMap.get(d.code);
    if (existing) {
      existing.techniques.push(t);
      existing.isPrimary.push(false);
    } else {
      diagnosisMap.set(d.code, { diagnosis: d, techniques: [t], isPrimary: [false] });
    }
  }
}
const diagnosisEntries = [...diagnosisMap.entries()]
  .sort((a, b) => b[1].techniques.length - a[1].techniques.length);
const uniqueDiagnoses = diagnosisEntries.length;

// Confidence color helper
const confidenceColor = (c: string) => {
  switch (c) {
    case 'established': return { bg: 'rgba(239, 68, 68, 0.12)', text: '#ef4444' };
    case 'probable': return { bg: 'rgba(245, 158, 11, 0.12)', text: '#f59e0b' };
    case 'theoretical': return { bg: 'rgba(148, 163, 184, 0.12)', text: '#94a3b8' };
    default: return { bg: 'rgba(148, 163, 184, 0.12)', text: '#94a3b8' };
  }
};

// Risk class color helper
const riskColor = (r: string) => {
  switch (r) {
    case 'direct': return { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.3)', text: '#ef4444' };
    case 'indirect': return { bg: 'rgba(245, 158, 11, 0.15)', border: 'rgba(245, 158, 11, 0.3)', text: '#f59e0b' };
    default: return { bg: 'rgba(148, 163, 184, 0.15)', border: 'rgba(148, 163, 184, 0.3)', text: '#94a3b8' };
  }
};

// Confidence breakdown across all primary diagnoses
const confidenceCounts = { established: 0, probable: 0, theoretical: 0 };
for (const t of dsm5Techniques) {
  for (const d of t.tara!.dsm5!.primary) {
    confidenceCounts[d.confidence as keyof typeof confidenceCounts] =
      (confidenceCounts[d.confidence as keyof typeof confidenceCounts] ?? 0) + 1;
  }
}

const breadcrumbs = [
  { label: 'Psychiatric Impact' },
];
---

<PageLayout
  title="Psychiatric Impact Map — When BCI Attacks Become Diagnoses"
  description={`${stats.withDsm5} of ${totalTechniques} BCI attack techniques map to DSM-5-TR diagnostic criteria based on known neuroanatomy. These clinical mappings are research-grade and await validation by psychiatrists and neuroscientists.`}
  breadcrumbs={breadcrumbs}
  wide
>

  <!-- ═══ HERO ═══ -->
  <section class="py-12 md:py-20">
    <div class="text-center max-w-3xl mx-auto mb-12">
      <p class="text-xs font-medium tracking-[0.2em] uppercase mb-4 text-[var(--color-text-faint)]">
        Psychiatric Impact Map
      </p>
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold font-[family-name:var(--font-heading)] tracking-tight mb-6 leading-[1.15]">
        <span class="text-[var(--color-text-primary)]">When BCI Attacks</span>
        <br />
        <span class="bg-gradient-to-r from-red-500 via-amber-500 to-purple-500 bg-clip-text text-transparent">
          Become Diagnoses.
        </span>
      </h1>
      <p class="text-base sm:text-lg text-[var(--color-text-muted)] max-w-2xl mx-auto leading-relaxed">
        {stats.withDsm5} of {totalTechniques} catalogued BCI attack techniques map to symptoms
        matching DSM-5-TR diagnostic criteria — based on known neuroanatomical pathways and functional neuroscience.
        These mappings require clinical validation by psychiatrists and neuroscientists before informing clinical practice.
      </p>
    </div>

    <!-- Stats bar -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 max-w-3xl mx-auto mb-12">
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-red-500">
          {stats.withDsm5}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">techniques with<br/>psychiatric outcomes</p>
      </div>
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-amber-500">
          {uniqueDiagnoses}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">DSM-5-TR<br/>diagnoses linked</p>
      </div>
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-purple-500">
          {Object.keys(stats.clusters).filter(k => stats.clusters[k as DiagnosticCluster] > 0).length}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">diagnostic<br/>clusters</p>
      </div>
      <div class="glass rounded-lg p-4 text-center">
        <p class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] text-red-400">
          {stats.riskClass.direct}
        </p>
        <p class="text-[10px] sm:text-xs text-[var(--color-text-muted)] mt-1 leading-tight">direct-risk<br/>pathways</p>
      </div>
    </div>
  </section>

  <!-- ═══ VALIDATION STATUS ═══ -->
  <div class="max-w-3xl mx-auto mb-8">
    <div class="rounded-xl p-4 sm:p-5 border border-amber-500/20" style="background: rgba(245, 158, 11, 0.06);">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-amber-500 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
        </svg>
        <div>
          <p class="text-sm font-semibold text-amber-500 mb-1">Research Status: Awaiting Clinical Validation</p>
          <p class="text-xs text-[var(--color-text-muted)] leading-relaxed">
            These DSM-5-TR mappings are based on known neuroanatomy and published neuroscience, but they have
            <strong class="text-[var(--color-text-primary)]">not been reviewed or validated by psychiatrists or clinical neuroscientists.</strong>
            The mappings were developed by a single security researcher through literature review and threat modeling.
            Clinical validation, interrater reliability studies, and expert panel review are needed before these
            mappings can inform clinical decision-making. See
            <a href="https://doi.org/10.5281/zenodo.18640105" class="text-amber-500 hover:underline">Section 9 of the preprint</a>
            for the full limitations disclosure.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ FOR CLINICIANS ═══ -->
  <section class="py-12 md:py-16" id="clinicians">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        For Clinicians
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="glass rounded-2xl p-6 sm:p-8 max-w-3xl mx-auto reveal">
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-4">
        A patient presents with sudden-onset anxiety, depersonalization, or motor tics — and they have a brain-computer
        interface. Is this a psychiatric condition, a device malfunction, or an attack? Today, there is no clinical
        framework to help you differentiate.
      </p>
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-4">
        This map traces <strong class="text-[var(--color-text-primary)]">every documented pathway from BCI exploitation
        to a DSM-5-TR diagnosis.</strong> Each technique is linked to the neural structures it disrupts, the functional
        systems it impairs, and the clinical presentation that results. The confidence level indicates whether the
        pathway is established in neuroscience literature, probable based on mechanism, or theoretical.
      </p>
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
        <strong class="text-[var(--color-text-primary)]">This is not diagnostic guidance.</strong> It is a
        research mapping that helps clinicians understand what is technically possible when a neural device is
        compromised — so that emerging symptom presentations can be evaluated in context.
      </p>
    </div>
  </section>

  <!-- ═══ DIAGNOSTIC CLUSTERS ═══ -->
  <section class="py-12 md:py-16" id="clusters">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Diagnostic Clusters
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <p class="text-sm text-[var(--color-text-muted)] max-w-2xl mx-auto text-center mb-8">
      Attack techniques are grouped into four diagnostic clusters based on their primary psychiatric
      outcome pattern. Each cluster represents a family of related symptoms that emerge from similar
      neural disruption mechanisms.
    </p>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 max-w-3xl mx-auto mb-6">
      {clusterGroups.map(g => (
        <div
          class="rounded-lg p-4 text-center"
          style={`background: ${DIAGNOSTIC_CLUSTER_COLORS[g.key].bg}; border: 1px solid ${DIAGNOSTIC_CLUSTER_COLORS[g.key].border};`}
        >
          <p
            class="text-2xl font-bold font-[family-name:var(--font-heading)]"
            style={`color: ${DIAGNOSTIC_CLUSTER_COLORS[g.key].text};`}
          >
            {g.count}
          </p>
          <p class="text-[10px] sm:text-xs mt-1 leading-tight" style={`color: ${DIAGNOSTIC_CLUSTER_COLORS[g.key].text}; opacity: 0.8;`}>
            {g.label}
          </p>
        </div>
      ))}
    </div>

    <div class="max-w-3xl mx-auto space-y-3 mt-8">
      <div class="glass rounded-lg p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-3 h-3 rounded-sm" style={`background: ${DIAGNOSTIC_CLUSTER_COLORS.mood_trauma.text};`}></span>
          <span class="text-sm font-semibold text-[var(--color-text-primary)]">Mood / Trauma</span>
          <span class="text-xs text-[var(--color-text-faint)] ml-auto">{stats.clusters.mood_trauma} techniques</span>
        </div>
        <p class="text-xs text-[var(--color-text-muted)] leading-relaxed">
          Attacks that disrupt limbic circuitry — primarily amygdala, hippocampus, and prefrontal connectivity. Present as depression, anxiety, PTSD-like symptoms, adjustment disorders. Most common cluster because emotional regulation pathways are the most accessible via neurostimulation.
        </p>
      </div>
      <div class="glass rounded-lg p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-3 h-3 rounded-sm" style={`background: ${DIAGNOSTIC_CLUSTER_COLORS.cognitive_psychotic.text};`}></span>
          <span class="text-sm font-semibold text-[var(--color-text-primary)]">Cognitive / Psychotic</span>
          <span class="text-xs text-[var(--color-text-faint)] ml-auto">{stats.clusters.cognitive_psychotic} techniques</span>
        </div>
        <p class="text-xs text-[var(--color-text-muted)] leading-relaxed">
          Attacks targeting cortical processing, thalamocortical loops, and dopaminergic pathways. Can produce perceptual distortions, hallucinations, thought disorganization, and cognitive impairment that mimics schizophrenia spectrum, ADHD, or neurocognitive disorders.
        </p>
      </div>
      <div class="glass rounded-lg p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-3 h-3 rounded-sm" style={`background: ${DIAGNOSTIC_CLUSTER_COLORS.motor_neurocognitive.text};`}></span>
          <span class="text-sm font-semibold text-[var(--color-text-primary)]">Motor / Neurocognitive</span>
          <span class="text-xs text-[var(--color-text-faint)] ml-auto">{stats.clusters.motor_neurocognitive} techniques</span>
        </div>
        <p class="text-xs text-[var(--color-text-muted)] leading-relaxed">
          Attacks disrupting motor cortex, basal ganglia, cerebellum, or spinal cord pathways. Manifest as involuntary movements, coordination deficits, conversion-like symptoms, or progressive neurocognitive decline. Often the most clinically visible outcomes.
        </p>
      </div>
      <div class="glass rounded-lg p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-3 h-3 rounded-sm" style={`background: ${DIAGNOSTIC_CLUSTER_COLORS.persistent_personality.text};`}></span>
          <span class="text-sm font-semibold text-[var(--color-text-primary)]">Persistent / Personality</span>
          <span class="text-xs text-[var(--color-text-faint)] ml-auto">{stats.clusters.persistent_personality} techniques</span>
        </div>
        <p class="text-xs text-[var(--color-text-muted)] leading-relaxed">
          Attacks causing sustained alterations to personality, identity, or behavioral regulation through prolonged or repeated neural manipulation. The most concerning cluster for neurorights — these changes can persist after the attack ceases.
        </p>
      </div>
    </div>
  </section>

  <!-- ═══ RISK CLASS ═══ -->
  <section class="py-12 md:py-16" id="risk">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Risk Classification
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-2xl mx-auto mb-6">
      {riskClassGroups.map(g => (
        <div
          class="rounded-lg p-5 text-center"
          style={`background: ${riskColor(g.key).bg}; border: 1px solid ${riskColor(g.key).border};`}
        >
          <p
            class="text-3xl font-bold font-[family-name:var(--font-heading)]"
            style={`color: ${riskColor(g.key).text};`}
          >
            {g.count}
          </p>
          <p class="text-sm font-medium mt-1" style={`color: ${riskColor(g.key).text};`}>
            {g.label}
          </p>
          <p class="text-[10px] mt-2 leading-relaxed" style={`color: ${riskColor(g.key).text}; opacity: 0.7;`}>
            {g.description}
          </p>
        </div>
      ))}
    </div>
  </section>

  <!-- ═══ EVIDENCE CONFIDENCE ═══ -->
  <section class="py-12 md:py-16" id="confidence">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Evidence Confidence
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <p class="text-sm text-[var(--color-text-muted)] max-w-2xl mx-auto text-center mb-6">
      Each technique-to-diagnosis link is classified by the strength of the underlying neuroscience
      evidence connecting the attack mechanism to the clinical outcome.
    </p>

    <div class="max-w-3xl mx-auto">
      <div class="flex gap-1 h-8 rounded-full overflow-hidden mb-3">
        {Object.entries(confidenceCounts).filter(([, c]) => c > 0).map(([level, count]) => (
          <div
            class="flex items-center justify-center text-[10px] font-medium transition-all"
            style={`flex: ${count}; background: ${confidenceColor(level).bg}; color: ${confidenceColor(level).text};`}
            title={`${level}: ${count} mappings`}
          >
            {count > 5 && `${level} (${count})`}
          </div>
        ))}
      </div>
      <div class="flex flex-wrap justify-center gap-x-4 gap-y-1">
        <span class="flex items-center gap-1.5 text-xs text-[var(--color-text-faint)]">
          <span class="w-2 h-2 rounded-sm" style={`background: ${confidenceColor('established').text};`}></span>
          Established ({confidenceCounts.established})
          <span class="text-[10px] text-[var(--color-text-faint)]">— published neuroscience evidence</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-[var(--color-text-faint)]">
          <span class="w-2 h-2 rounded-sm" style={`background: ${confidenceColor('probable').text};`}></span>
          Probable ({confidenceCounts.probable})
          <span class="text-[10px] text-[var(--color-text-faint)]">— strong mechanistic basis</span>
        </span>
        {confidenceCounts.theoretical > 0 && (
          <span class="flex items-center gap-1.5 text-xs text-[var(--color-text-faint)]">
            <span class="w-2 h-2 rounded-sm" style={`background: ${confidenceColor('theoretical').text};`}></span>
            Theoretical ({confidenceCounts.theoretical})
            <span class="text-[10px] text-[var(--color-text-faint)]">— plausible but unvalidated</span>
          </span>
        )}
      </div>
    </div>
  </section>

  <!-- ═══ DIAGNOSIS EXPLORER ═══ -->
  <section class="py-12 md:py-16" id="diagnoses">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        Diagnosis Explorer
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <p class="text-sm text-[var(--color-text-muted)] max-w-2xl mx-auto text-center mb-8">
      {uniqueDiagnoses} DSM-5-TR diagnoses linked to {stats.withDsm5} attack techniques.
      Expand any diagnosis to see the techniques that can produce it, with their neural pathways and NISS severity scores.
    </p>

    <div class="max-w-4xl mx-auto space-y-2">
      {diagnosisEntries.map(([code, { diagnosis, techniques, isPrimary }]) => {
        const primaryCount = isPrimary.filter(Boolean).length;
        const secondaryCount = isPrimary.filter(p => !p).length;
        return (
          <details class="glass rounded-lg group">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-white/5 transition-colors rounded-lg">
              <span class="flex items-center gap-3">
                <span class="text-xs font-mono px-2 py-0.5 rounded bg-[var(--color-bg-muted)] text-[var(--color-text-faint)]">{code}</span>
                <span class="text-sm font-medium text-[var(--color-text-primary)]">{diagnosis.name}</span>
              </span>
              <span class="flex items-center gap-2">
                <span class="text-xs text-[var(--color-text-faint)]">
                  {techniques.length} technique{techniques.length !== 1 ? 's' : ''}
                  {secondaryCount > 0 && ` (${primaryCount} primary, ${secondaryCount} secondary)`}
                </span>
                <svg class="w-3.5 h-3.5 text-[var(--color-text-faint)] group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </span>
            </summary>
            <div class="px-4 pb-4 space-y-2">
              {techniques.map((t, idx) => {
                const dsm = t.tara!.dsm5!;
                const cluster = DIAGNOSTIC_CLUSTER_COLORS[dsm.cluster];
                const clusterLabel = DIAGNOSTIC_CLUSTER_LABELS[dsm.cluster];
                const isPrim = isPrimary[idx];
                const sevColor = SEVERITY_COLORS[t.niss.severity as keyof typeof SEVERITY_COLORS] ?? SEVERITY_COLORS.low;
                return (
                  <a
                    href={`/TARA/${t.id}/`}
                    class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 p-3 rounded-md hover:bg-white/5 transition-colors border border-transparent hover:border-[var(--color-border)]"
                  >
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        <p class="text-xs font-mono text-[var(--color-text-faint)]">{t.id}</p>
                        {!isPrim && (
                          <span class="text-[9px] px-1.5 py-0.5 rounded bg-[var(--color-bg-muted)] text-[var(--color-text-faint)]">secondary</span>
                        )}
                      </div>
                      <p class="text-sm font-medium text-[var(--color-text-primary)] truncate">{t.name}</p>
                      <p class="text-[11px] text-[var(--color-text-faint)] mt-1 line-clamp-1">
                        Pathway: {dsm.pathway}
                      </p>
                    </div>
                    <div class="flex flex-wrap gap-1.5 shrink-0">
                      <span
                        class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                        style={`background: ${cluster.bg}; color: ${cluster.text};`}
                      >
                        {clusterLabel}
                      </span>
                      <span
                        class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                        style={`background: ${sevColor.bg}; color: ${sevColor.text};`}
                      >
                        NISS {t.niss.score}
                      </span>
                      <span
                        class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                        style={`background: ${riskColor(dsm.risk_class).bg}; color: ${riskColor(dsm.risk_class).text};`}
                      >
                        {dsm.risk_class}
                      </span>
                    </div>
                  </a>
                );
              })}
            </div>
          </details>
        );
      })}
    </div>
  </section>

  <!-- ═══ NEURAL IMPACT CHAIN ═══ -->
  <section class="py-12 md:py-16" id="impact-chain">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        The Neural Impact Chain
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="glass rounded-2xl p-6 sm:p-8 max-w-3xl mx-auto reveal">
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-6 text-center">
        Every technique-to-diagnosis mapping follows a six-stage chain. Understanding this chain
        helps clinicians trace a presenting symptom back to a potential technical cause.
      </p>

      <div class="space-y-0 max-w-md mx-auto">
        {[
          { step: '1', label: 'Attack Technique', desc: 'The specific BCI exploitation method', color: '#3b82f6' },
          { step: '2', label: 'Hourglass Band', desc: 'Which layer of the neurotechnology stack is targeted', color: '#6366f1' },
          { step: '3', label: 'Neural Structure', desc: 'The brain region or pathway disrupted', color: '#8b5cf6' },
          { step: '4', label: 'Functional System', desc: 'The cognitive, emotional, or motor system impaired', color: '#a855f7' },
          { step: '5', label: 'NISS Score', desc: 'Severity of the neural impact (0–5 scale)', color: '#d946ef' },
          { step: '6', label: 'DSM-5-TR Diagnosis', desc: 'The resulting clinical presentation', color: '#ef4444' },
        ].map((s, i) => (
          <div class="flex items-start gap-4">
            <div class="flex flex-col items-center">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shrink-0"
                style={`background: ${s.color};`}
              >
                {s.step}
              </div>
              {i < 5 && <div class="w-0.5 h-6" style={`background: ${s.color}30;`}></div>}
            </div>
            <div class="pb-4">
              <p class="text-sm font-semibold text-[var(--color-text-primary)]">{s.label}</p>
              <p class="text-xs text-[var(--color-text-muted)]">{s.desc}</p>
            </div>
          </div>
        ))}
      </div>

      <div class="text-center mt-4">
        <a
          href="/publications/2026-02-13-the-neural-impact-chain-when-niss-scores-predict-psychiatric-diagnoses/"
          class="inline-flex items-center gap-1.5 text-xs font-medium text-[var(--color-accent-primary)] hover:underline"
        >
          Read the full Neural Impact Chain paper
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- ═══ EXPLORE TECHNIQUES ═══ -->
  <section class="py-12 md:py-16" id="techniques">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        All {stats.withDsm5} Techniques by Cluster
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="max-w-4xl mx-auto grid gap-3 sm:grid-cols-2">
      {dsm5Techniques.sort((a, b) => {
        const clusterOrder: DiagnosticCluster[] = ['mood_trauma', 'cognitive_psychotic', 'motor_neurocognitive', 'persistent_personality', 'non_diagnostic'];
        const aIdx = clusterOrder.indexOf(a.tara!.dsm5!.cluster);
        const bIdx = clusterOrder.indexOf(b.tara!.dsm5!.cluster);
        if (aIdx !== bIdx) return aIdx - bIdx;
        return (b.niss?.score ?? 0) - (a.niss?.score ?? 0);
      }).map(t => {
        const dsm = t.tara!.dsm5!;
        const cluster = DIAGNOSTIC_CLUSTER_COLORS[dsm.cluster];
        const clusterLabel = DIAGNOSTIC_CLUSTER_LABELS[dsm.cluster];
        const sevColor = SEVERITY_COLORS[t.niss.severity as keyof typeof SEVERITY_COLORS] ?? SEVERITY_COLORS.low;
        return (
          <a
            href={`/TARA/${t.id}/`}
            class="glass rounded-lg p-4 hover:ring-1 hover:ring-red-500/20 transition-all group"
          >
            <div class="flex items-start justify-between gap-2 mb-2">
              <p class="text-xs font-mono text-[var(--color-text-faint)]">{t.id}</p>
              <span
                class="px-2 py-0.5 rounded-full text-[9px] font-semibold uppercase shrink-0"
                style={`background: ${cluster.bg}; color: ${cluster.text}; border: 1px solid ${cluster.border};`}
              >
                {clusterLabel}
              </span>
            </div>
            <p class="text-sm font-medium text-[var(--color-text-primary)] mb-1 group-hover:text-red-500 transition-colors">
              {t.name}
            </p>
            <p class="text-xs text-[var(--color-text-faint)] mb-3 line-clamp-1">
              {dsm.pathway}
            </p>
            <div class="flex flex-wrap gap-1.5 mb-2">
              <span
                class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                style={`background: ${sevColor.bg}; color: ${sevColor.text};`}
              >
                NISS {t.niss.score}
              </span>
              <span
                class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                style={`background: ${riskColor(dsm.risk_class).bg}; color: ${riskColor(dsm.risk_class).text};`}
              >
                {dsm.risk_class} risk
              </span>
              {dsm.primary.slice(0, 2).map(d => (
                <span class="px-2 py-0.5 rounded-full text-[10px] font-medium bg-[var(--color-bg-muted)] text-[var(--color-text-faint)]">
                  {d.name}
                </span>
              ))}
              {dsm.primary.length > 2 && (
                <span class="px-2 py-0.5 rounded-full text-[10px] font-medium bg-[var(--color-bg-muted)] text-[var(--color-text-faint)]">
                  +{dsm.primary.length - 2} more
                </span>
              )}
            </div>
          </a>
        );
      })}
    </div>
  </section>

  <!-- ═══ PIVOT TO TARA ═══ -->
  <section class="py-12 md:py-16" id="tara-pivot">
    <div class="flex items-center gap-4 mb-8">
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
      <h2 class="text-lg sm:text-xl font-bold font-[family-name:var(--font-heading)] text-[var(--color-text-primary)] whitespace-nowrap">
        See the Full Picture
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <div class="glass rounded-2xl p-6 sm:p-8 max-w-3xl mx-auto reveal">
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-4">
        This page shows the psychiatric outcomes. To trace how each diagnosis arises — from the attack mechanism,
        through the affected neural band, to the NISS severity score that predicts it — open the full technique
        entry in the TARA Atlas.
      </p>
      <p class="text-sm text-[var(--color-text-muted)] leading-relaxed mb-6">
        Every technique listed above links directly to its TARA page, where you can see all four projections:
        the security assessment, therapeutic analog, diagnostic mapping, and governance requirements.
        The TARA Atlas is the single source of truth — this page is one lens into it.
      </p>

      <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
        <a
          href="/TARA/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium text-white transition-colors"
          style="background: var(--color-accent-primary);"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
          </svg>
          Open TARA Atlas
        </a>
        <span class="text-xs text-[var(--color-text-faint)]">
          View all {totalTechniques} techniques with full scoring and projections
        </span>
      </div>
    </div>
  </section>

  <!-- ═══ CALL TO ACTION ═══ -->
  <section class="py-12 md:py-20" id="cta">
    <div class="glass rounded-2xl p-8 sm:p-12 max-w-3xl mx-auto text-center reveal">
      <h2 class="text-2xl sm:text-3xl font-bold font-[family-name:var(--font-heading)] mb-4 text-[var(--color-text-primary)]">
        This work needs your expertise.
      </h2>
      <p class="text-sm text-[var(--color-text-muted)] mb-4 max-w-lg mx-auto leading-relaxed">
        These mappings were built by a security researcher, not a clinician. They need validation
        by psychiatrists, clinical neuroscientists, and neuroethicists before they can responsibly
        inform clinical practice.
      </p>
      <p class="text-sm text-[var(--color-text-muted)] mb-8 max-w-lg mx-auto leading-relaxed">
        If you are a clinician or researcher working in neuroscience, psychiatry, or BCI safety — we
        welcome peer review, corrections, and collaboration. This map is a starting point built for
        scrutiny, not prescription.
      </p>

      <div class="flex flex-wrap items-center justify-center gap-3">
        <a
          href="/explorer/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium text-white transition-colors"
          style="background: var(--color-accent-primary);"
        >
          Threat Explorer
        </a>
        <a
          href="/therapeutics/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors"
          style="background: rgba(0,0,0,0.05); color: var(--color-text-primary);"
        >
          Therapeutic Atlas
        </a>
        <a
          href="/TARA/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors"
          style="background: rgba(0,0,0,0.05); color: var(--color-text-primary);"
        >
          TARA Registry
        </a>
        <a
          href="/whitepaper/"
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors"
          style="background: rgba(0,0,0,0.05); color: var(--color-text-primary);"
        >
          Read the Whitepaper
        </a>
      </div>
    </div>
  </section>

</PageLayout>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  details[open] > summary {
    border-bottom: 1px solid var(--color-border);
    border-radius: 0.5rem 0.5rem 0 0;
  }
</style>
