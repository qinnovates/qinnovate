---
import PageLayout from '../layouts/PageLayout.astro';
import { HOURGLASS_BANDS, COHERENCE, SCALE_FREQUENCY, QIF_VERSION } from '../lib/qif-constants';
import Hourglass3D from '../components/Hourglass3D';
import { THREAT_VECTORS, THREAT_TACTICS, THREAT_DOMAINS, getTacticsWithCounts } from '../lib/threat-data';

const tacticsWithCounts = getTacticsWithCounts();
const totalTechniques = THREAT_VECTORS.length;
const totalTactics = THREAT_TACTICS.length;
const totalDomains = (THREAT_DOMAINS as any[]).length;

const tacticColors: Record<string, string> = {
  'N': '#06b6d4',   // Neural → cyan
  'C': '#f59e0b',   // Cognitive → amber
  'P': '#ef4444',   // Physiological → red
  'D': '#06b6d4',   // Data → cyan
  'B': '#8b5cf6',   // BCI System → violet
  'M': '#10b981',   // Model → emerald
  'E': '#f97316',   // Energy → orange
};
---

<PageLayout
  title="QIF Framework"
  description="The Quantified Interconnection Framework — an 11-band hourglass security architecture for brain-computer interfaces."
  breadcrumbs={[{ label: 'Framework' }]}
  maxWidth="wide"
>
  <div class="lg:grid lg:grid-cols-[240px_1fr] lg:gap-12">
    <!-- Sidebar (sticky TOC) -->
    <aside class="hidden lg:block">
      <nav class="sticky top-24 space-y-1" aria-label="Table of contents">
        <p class="text-xs font-semibold tracking-wider uppercase text-[var(--color-text-faint)] mb-3">On this page</p>
        {[
          { href: '#overview', label: 'Overview' },
          { href: '#foundations', label: 'Foundations' },
          { href: '#hourglass', label: 'Hourglass Model' },
          { href: '#bands', label: '11 Bands' },
          { href: '#scale-frequency', label: 'Scale-Frequency' },
          { href: '#threat-model', label: 'Threat Model' },
          { href: '#taxonomy', label: 'TARA Taxonomy' },
          { href: '#niss', label: 'NISS Scoring' },
          { href: '#coherence', label: 'Coherence Metric' },
        ].map((item) => (
          <a href={item.href} class="block text-sm py-1.5 text-[var(--color-text-muted)] hover:text-[var(--color-accent-primary)] transition-colors border-l-2 border-transparent hover:border-[var(--color-accent-primary)] pl-3">
            {item.label}
          </a>
        ))}
      </nav>
    </aside>

    <!-- Main content -->
    <div class="max-w-3xl">
      <!-- Overview -->
      <section id="overview" class="mb-20">
        <h1 class="text-3xl sm:text-4xl font-bold font-[family-name:var(--font-heading)] mb-6">
          QIF Framework <span class="text-[var(--color-accent-primary)]">v{QIF_VERSION}</span>
        </h1>
        <div class="prose">
          <p class="text-lg text-[var(--color-text-muted)]">
            The **Quantified Interconnection Framework (QIF)** is an open security standard for brain-computer interfaces. It defines the threat model, security architecture, and coherence metrics for protecting neural data at every layer — from hardware to human identity.
          </p>
          <p>
            QIF answers a question no existing framework addresses: <em>how do you secure a system where one endpoint is a brain?</em> Existing cybersecurity models (OSI, Zero Trust) handle synthetic systems. Existing neuroethics frameworks handle consent and privacy. QIF bridges both with an engineering specification for the interface between them, including three original systems developed by Qinnovate:
          </p>
          <ul>
            <li><strong>TARA Atlas</strong> (Therapeutic Applications &amp; Risk Assessment) &mdash; a dual-use atlas that classifies each BCI technique as both a security threat and a potential therapeutic application, maps techniques to DSM-5-TR psychiatric diagnoses through the Neural Impact Chain, and traces clinical outcomes from physical mechanism to cognitive function</li>
            <li><strong>NISS</strong> (Neural Impact Scoring System) &mdash; a purpose-built vulnerability scoring system that extends CVSS with five neural-specific metrics: biological impact, cognitive integrity, consent violation, reversibility, and neuroplasticity</li>
            <li><strong>NSP</strong> (Neural Sensory Protocol) &mdash; a five-layer, post-quantum wire protocol for securing BCI data links at 3.25% power overhead on implanted devices</li>
          </ul>
        </div>
      </section>

      <!-- Foundational Frameworks -->
      <section id="foundations" class="mb-20">
        <h2 class="text-2xl font-bold font-[family-name:var(--font-heading)] mb-6">Derived From Three Frameworks</h2>
        <div class="prose mb-8">
          <p>
            QIF's hourglass architecture didn't emerge from a single discipline. It was derived by finding a structural pattern across three independent models — each spanning ~7-8 layers, each covering roughly one order of magnitude per layer in spatial scale. The hourglass is where networking meets neuroscience at the physical interface.
          </p>
        </div>

        <div class="grid sm:grid-cols-3 gap-4">
          <div class="glass rounded-xl p-6" style="border-top: 3px solid #3b82f6;">
            <div class="text-sm font-bold font-[family-name:var(--font-mono)] text-[#3b82f6] mb-2">01</div>
            <h3 class="text-base font-semibold font-[family-name:var(--font-heading)] mb-2">OSI Model</h3>
            <p class="text-xs text-[var(--color-text-faint)] mb-3">ISO/IEC 7498-1, 1984</p>
            <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
              The 7-layer networking stack. The pedagogical starting point for thinking about layered security — proving that complex systems become manageable when decomposed into well-defined abstraction boundaries.
            </p>
          </div>
          <div class="glass rounded-xl p-6" style="border-top: 3px solid #10b981;">
            <div class="text-sm font-bold font-[family-name:var(--font-mono)] text-[#10b981] mb-2">02</div>
            <h3 class="text-base font-semibold font-[family-name:var(--font-heading)] mb-2">Kandel's Nervous System Hierarchy</h3>
            <p class="text-xs text-[var(--color-text-faint)] mb-3">Eric Kandel et al., <em>Principles of Neural Science</em></p>
            <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
              The 7-level CNS organization from molecular to whole-brain. The neuroscience foundation for QIF's neural bands — demonstrating that the nervous system itself is a layered architecture with distinct security surfaces at each level.
            </p>
          </div>
          <div class="glass rounded-xl p-6" style="border-top: 3px solid #f59e0b;">
            <div class="text-sm font-bold font-[family-name:var(--font-mono)] text-[#f59e0b] mb-2">03</div>
            <h3 class="text-base font-semibold font-[family-name:var(--font-heading)] mb-2">Campbell's Biology</h3>
            <p class="text-xs text-[var(--color-text-faint)] mb-3">Campbell et al., <em>Biology</em></p>
            <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
              The 8-level biological organization from atoms to organisms. The cross-domain validation that layered architecture is a universal organizing principle — not just an engineering convenience, but a pattern that nature converges on independently.
            </p>
          </div>
        </div>
      </section>

      <!-- Hourglass Model -->
      <section id="hourglass" class="mb-20">
        <h2 class="text-2xl font-bold font-[family-name:var(--font-heading)] mb-6">The Hourglass Model</h2>
        <div class="prose mb-8">
          <p>
            QIF v{QIF_VERSION} organizes BCI security into an <strong>11-band hourglass</strong> — a 7-1-3 asymmetric architecture. The physical BCI device sits at the <strong>waist</strong> (I0, the Neural Interface), with seven neural bands above and three synthetic bands below.
          </p>
          <p>
            This topology mirrors how BCIs actually work: signals travel up from hardware through protocols to the brain, and commands travel down from cognition through processing to the device. The hourglass narrows at the exact point where biology meets synthetic systems — the most critical attack surface.
          </p>
        </div>

        <!-- Interactive 3D hourglass (React island) -->
        <div class="my-12" id="hourglass-interactive" style="min-height: 520px;">
          <Hourglass3D client:only="react" />
          <noscript>
            <div class="max-w-lg mx-auto space-y-3">
              {HOURGLASS_BANDS.map((band, i) => {
                const widths = [90, 82, 72, 62, 55, 45, 38, 30, 45, 58, 75];
                const width = widths[i];
                return (
                  <div
                    class="glass rounded-lg p-5 mx-auto"
                    style={`max-width: ${width}%; border-left: 3px solid ${band.color};`}
                  >
                    <div class="flex items-center gap-3">
                      <span class="text-xs font-bold font-[family-name:var(--font-mono)]" style={`color: ${band.color};`}>{band.id}</span>
                      <span class="text-sm font-semibold">{band.name}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </noscript>
        </div>
      </section>

      <!-- Band Details -->
      <section id="bands" class="mb-20">
        <h2 class="text-2xl font-bold font-[family-name:var(--font-heading)] mb-6">The 11 Bands</h2>
        <div class="space-y-8">
          {HOURGLASS_BANDS.map((band) => (
            <div class="glass rounded-xl p-6" style={`border-left: 3px solid ${band.color};`}>
              <div class="flex items-center gap-3 mb-3">
                <span class="text-sm font-bold font-[family-name:var(--font-mono)]" style={`color: ${band.color};`}>{band.id}</span>
                <h3 class="text-lg font-semibold font-[family-name:var(--font-heading)]">{band.name}</h3>
                <span class="text-xs px-2 py-0.5 rounded-full border border-[var(--color-border)] text-[var(--color-text-faint)] ml-auto">
                  {band.zone}
                </span>
              </div>
              <p class="text-sm text-[var(--color-text-muted)]">{band.description}</p>
            </div>
          ))}
        </div>
      </section>

      <!-- Scale-Frequency -->
      <section id="scale-frequency" class="mb-20">
        <h2 class="text-2xl font-bold font-[family-name:var(--font-heading)] mb-6">Scale-Frequency Invariant</h2>
        <div class="prose mb-8">
          <p>
            Neural oscillations follow a fundamental relationship: the product of frequency and spatial extent is approximately constant. This scale-frequency invariant defines how neural signals propagate and sets the physical constraints that any BCI security model must respect.
          </p>
        </div>

        <div class="glass rounded-xl p-8 text-center mb-8">
          <p class="text-2xl font-[family-name:var(--font-mono)] text-[var(--color-accent-tertiary)] mb-4">
            v = f &times; &lambda;
          </p>
          <p class="text-sm text-[var(--color-text-faint)]">
            k &asymp; 1&ndash;10 m/s (NOT 10&sup6;)
          </p>
        </div>

        <!-- Band data table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-[var(--color-border)]">
                <th class="text-left py-3 px-4 text-[var(--color-text-faint)] font-medium">Band</th>
                <th class="text-left py-3 px-4 text-[var(--color-text-faint)] font-medium">Frequency</th>
                <th class="text-left py-3 px-4 text-[var(--color-text-faint)] font-medium">Spatial Extent</th>
                <th class="text-left py-3 px-4 text-[var(--color-text-faint)] font-medium">k</th>
              </tr>
            </thead>
            <tbody>
              {SCALE_FREQUENCY.bands.map((band) => (
                <tr class="border-b border-[var(--color-border)]/50">
                  <td class="py-3 px-4 font-medium">{band.name}</td>
                  <td class="py-3 px-4 font-[family-name:var(--font-mono)] text-[var(--color-text-muted)]">{band.frequency}</td>
                  <td class="py-3 px-4 font-[family-name:var(--font-mono)] text-[var(--color-text-muted)]">{band.extent}</td>
                  <td class="py-3 px-4 font-[family-name:var(--font-mono)] text-[var(--color-accent-secondary)]">{band.k}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Threat Model -->
      <section id="threat-model" class="mb-20">
        <h2 class="text-2xl font-bold font-[family-name:var(--font-heading)] mb-6">Threat Model</h2>
        <div class="prose mb-8">
          <p>
            QIF defines threat vectors at each band of the hourglass. The model spans from physical hardware attacks (S3) through protocol exploitation (S1), neural signal manipulation (N1-N5), and cognitive integrity threats (N6-N7).
          </p>
          <p>
            The Neural Interface (I0) represents the highest-risk surface &mdash; where digital signals become neural stimulation and neural readings become digital data. Every attack that crosses this boundary is potentially irreversible in ways that traditional cybersecurity never encounters.
          </p>
        </div>

        <h3 id="taxonomy" class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-4">TARA Atlas</h3>
        <p class="text-xs font-semibold uppercase tracking-wider text-[var(--color-accent-primary)] mb-4">Therapeutic Applications &amp; Risk Assessment &ensp;|&ensp; by Qinnovate</p>
        <div class="prose mb-6">
          <p>
            TARA is a dual-use atlas where every entry is simultaneously a security threat, a clinical risk, and a potential therapeutic application. Developed by Qinnovate as the first classification system purpose-built for neural interfaces, TARA organizes {totalTechniques} techniques by the anatomical or functional <em>locus</em> where they operate, across {totalDomains} domains and {totalTactics} tactics using a <code>QIF-[Domain].[Action]</code> format.
          </p>
          <p>
            Beyond threat classification, TARA maps each technique through four projections: modality (attack severity and coupling mechanism), clinical (therapeutic analog, FDA status, treated conditions), diagnostic (DSM-5-TR psychiatric mapping via the <a href="/whitepaper/#neural-impact">Neural Impact Chain</a>), and governance (consent tier and regulatory requirements). The result is a single atlas that security engineers, clinicians, and regulators can each read from their own perspective.
          </p>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-8">
          {tacticsWithCounts.map((t) => {
            const color = tacticColors[t.domain_code] ?? '#94a3b8';
            return (
              <div class="glass rounded-lg p-3" style={`border-left: 3px solid ${color};`}>
                <div class="flex items-center justify-between">
                  <span class="text-xs font-bold font-[family-name:var(--font-mono)]" style={`color: ${color};`}>{t.id}</span>
                  <span class="text-xs font-[family-name:var(--font-mono)] text-[var(--color-text-faint)]">{t.count}</span>
                </div>
                <div class="text-sm font-medium mt-1">{t.name}</div>
              </div>
            );
          })}
        </div>

        <h3 id="niss" class="text-lg font-semibold font-[family-name:var(--font-heading)] mb-4">NISS v1.0 Scoring</h3>
        <p class="text-xs font-semibold uppercase tracking-wider text-[var(--color-accent-primary)] mb-4">First CVSS v4.0 Extension for Neural Security &ensp;|&ensp; by Qinnovate</p>
        <div class="prose mb-6">
          <p>
            Each technique is scored using <strong>NISS</strong> (Neural Impact Scoring System), the first CVSS v4.0 extension designed for neural security. Following FIRST.org's extension framework, NISS adds five neural-specific dimensions that CVSS structurally cannot express: Biological Impact, Cognitive Integrity, Reversibility, Violation of Consent, and Neuroplasticity. All TARA techniques have been mapped to both CVSS v4.0 base vectors and MITRE ATT&amp;CK-style technique IDs, empirically proving that 94.4% require NISS extension metrics for full-fidelity scoring.
          </p>
        </div>

        <div class="glass rounded-xl p-6 mb-8">
          <p class="text-center font-[family-name:var(--font-mono)] text-[var(--color-accent-tertiary)] mb-4">
            NISS = (BI + CG + CV + RV + NP) / 5
          </p>
          <div class="grid grid-cols-5 gap-3 text-center text-xs">
            <div>
              <div class="text-sm font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-primary)]">BI</div>
              <div class="text-[var(--color-text-faint)]">Biological Impact</div>
              <div class="text-[var(--color-text-muted)] mt-0.5">Weight 1.0</div>
            </div>
            <div>
              <div class="text-sm font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-primary)]">CG</div>
              <div class="text-[var(--color-text-faint)]">Cognitive Integrity</div>
              <div class="text-[var(--color-text-muted)] mt-0.5">Weight 1.0</div>
            </div>
            <div>
              <div class="text-sm font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-primary)]">CV</div>
              <div class="text-[var(--color-text-faint)]">Consent Violation</div>
              <div class="text-[var(--color-text-muted)] mt-0.5">Weight 1.0</div>
            </div>
            <div>
              <div class="text-sm font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-primary)]">RV</div>
              <div class="text-[var(--color-text-faint)]">Reversibility</div>
              <div class="text-[var(--color-text-muted)] mt-0.5">Weight 1.0</div>
            </div>
            <div>
              <div class="text-sm font-bold font-[family-name:var(--font-heading)] text-[var(--color-accent-primary)]">NP</div>
              <div class="text-[var(--color-text-faint)]">Neuroplasticity</div>
              <div class="text-[var(--color-text-muted)] mt-0.5">Weight 1.0</div>
            </div>
          </div>
        </div>

        <div class="prose">
          <p>
            For the complete scoring methodology, see the <a href="/scoring/">NISS Scoring page</a>. For the full technique atlas, explore the <a href="/TARA/">TARA Atlas</a>. The complete taxonomy derivation and metric definitions are in the <a href="/whitepaper/#taxonomy">QIF Whitepaper &sect;6.4&ndash;6.5</a>.
          </p>
        </div>
      </section>

      <!-- Coherence Metric -->
      <section id="coherence" class="mb-20">
        <h2 class="text-2xl font-bold font-[family-name:var(--font-heading)] mb-6">Coherence Metric</h2>
        <div class="prose mb-8">
          <p>
            The coherence metric provides a continuous, real-time measure of neural signal integrity. It collapses three variance dimensions — phase, temporal, and spatial — into a single security score between 0 and 1.
          </p>
        </div>

        <!-- Equation display -->
        <div class="glass rounded-xl p-8 text-center mb-8">
          <p class="text-2xl font-[family-name:var(--font-mono)] text-[var(--color-accent-tertiary)] mb-4">
            {COHERENCE.formula}
          </p>
          <p class="text-sm text-[var(--color-text-faint)]">
            where &sigma;&sup2;&psi; = phase variance, &sigma;&sup2;&tau; = temporal variance, &sigma;&sup2;&gamma; = spatial variance
          </p>
        </div>

        <!-- Threshold zones -->
        <div class="grid sm:grid-cols-3 gap-4">
          <div class="glass rounded-lg p-5 border-l-3" style={`border-left: 3px solid ${COHERENCE.thresholds.safe.color};`}>
            <div class="text-lg font-bold font-[family-name:var(--font-mono)]" style={`color: ${COHERENCE.thresholds.safe.color};`}>
              C<sub>s</sub> &gt; 0.6
            </div>
            <div class="text-sm font-semibold mt-1">{COHERENCE.thresholds.safe.label}</div>
            <p class="text-xs text-[var(--color-text-muted)] mt-2">Signal integrity verified. Normal operating state.</p>
          </div>
          <div class="glass rounded-lg p-5" style={`border-left: 3px solid ${COHERENCE.thresholds.gateway.color};`}>
            <div class="text-lg font-bold font-[family-name:var(--font-mono)]" style={`color: ${COHERENCE.thresholds.gateway.color};`}>
              0.3 &le; C<sub>s</sub> &le; 0.6
            </div>
            <div class="text-sm font-semibold mt-1">{COHERENCE.thresholds.gateway.label}</div>
            <p class="text-xs text-[var(--color-text-muted)] mt-2">Anomalous variance detected. Enhanced monitoring.</p>
          </div>
          <div class="glass rounded-lg p-5" style={`border-left: 3px solid ${COHERENCE.thresholds.breach.color};`}>
            <div class="text-lg font-bold font-[family-name:var(--font-mono)]" style={`color: ${COHERENCE.thresholds.breach.color};`}>
              C<sub>s</sub> &lt; 0.3
            </div>
            <div class="text-sm font-semibold mt-1">{COHERENCE.thresholds.breach.label}</div>
            <p class="text-xs text-[var(--color-text-muted)] mt-2">Signal compromise indicated. Defensive response triggered.</p>
          </div>
        </div>

        <div class="text-center mt-6">
          <a href="/explore/" class="text-sm text-[var(--color-accent-primary)] hover:text-[var(--color-accent-secondary)] transition-colors">
            Try the interactive coherence calculator in QIF Lab &rarr;
          </a>
        </div>
      </section>
    </div>
  </div>
</PageLayout>
