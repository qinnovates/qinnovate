---
import PageLayout from '../layouts/PageLayout.astro';
import { HOURGLASS_BANDS } from '../lib/qif-constants';
import { THREAT_CATEGORIES, THREAT_VECTORS, getThreatStats, getStatusStats } from '../lib/threat-data';
import { getProjectionConfigForClient } from '../lib/tara-projections';

const stats = getThreatStats();
const statusStats = getStatusStats();
const bands = [...HOURGLASS_BANDS];
const allThreatsJson = JSON.stringify(THREAT_VECTORS);
const projectionConfigJson = JSON.stringify(getProjectionConfigForClient());
---

<PageLayout
  title="TARA — Therapeutic Atlas of Risks & Applications"
  description={`${THREAT_VECTORS.length} BCI techniques mapped across modality, clinical, diagnostic, and governance projections. Each technique viewed as both an attack vector and a therapeutic application.`}
  breadcrumbs={[{ label: 'Explore', href: '/explore/' }, { label: 'TARA Registrar' }]}
  maxWidth="wide"
>
  <div id="threat-page" data-projection="modality">
    <div class="mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold font-[family-name:var(--font-heading)] mb-2">TARA Registrar</h1>
      <p class="text-sm text-[var(--color-text-muted)] opacity-70 -mt-1 mb-1">Therapeutic Atlas of Risks &amp; Applications</p>
      <p class="text-base text-[var(--color-text-muted)] max-w-3xl mb-6">
        {THREAT_VECTORS.length} BCI techniques mapped to CVSS v4.0 base vectors across {THREAT_CATEGORIES.length} categories and {bands.length} hourglass bands. Every attack vector is also a therapeutic application.
      </p>

      <!-- Context introduction for newcomers -->
      <div class="glass-subtle rounded-xl p-5 mb-6 text-sm text-[var(--color-text-muted)]">
        <p class="mb-2">
          <strong class="text-[var(--color-text-primary)]">What is TARA?</strong>
          Every BCI technique that can harm a patient can also heal one. TARA maps {THREAT_VECTORS.length} known brain-computer interface techniques across four dimensions:
        </p>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">
          <div><strong class="text-[var(--color-accent-primary)]">Modality</strong> &mdash; Impact severity and physical mechanism</div>
          <div><strong class="text-[#0891b2]">Clinical</strong> &mdash; Therapeutic applications and FDA status</div>
          <div><strong class="text-[#d97706]">Diagnostic</strong> &mdash; DSM-5-TR psychiatric mapping</div>
          <div><strong class="text-[var(--color-accent-tertiary)]">Governance</strong> &mdash; Consent tiers and regulations</div>
        </div>
        <p class="mt-3 text-xs text-[var(--color-text-faint)]">
          Switch tabs to view the same grid through each lens. Click any colored cell to see full details.
        </p>
      </div>

      <!-- TARA Projection Tabs -->
      <nav class="tara-tabs" id="tara-tabs" role="radiogroup" aria-label="TARA projection">
        <button class="tara-tab active" data-projection="modality" role="radio" aria-checked="true">Modality</button>
        <button class="tara-tab" data-projection="clinical" role="radio" aria-checked="false">Clinical</button>
        <button class="tara-tab" data-projection="diagnostic" role="radio" aria-checked="false">Diagnostic</button>
        <button class="tara-tab" data-projection="governance" role="radio" aria-checked="false">Governance</button>
      </nav>

      <!-- Projection description (changes per tab) -->
      <div id="projection-desc" class="text-sm text-[var(--color-text-muted)] mb-4 -mt-2" style="min-height: 1.5rem;">
        How each technique works — toggle between impact severity and physical mechanism
      </div>

      <!-- Sub-view toggle (visible only for Modality projection) -->
      <div id="subview-toggle" class="flex gap-1 mb-3 text-xs" style="display:flex;">
        <span class="text-[var(--color-text-faint)] mr-1 self-center">Color by:</span>
        <button class="subview-btn active" data-subview="impact">Impact</button>
        <button class="subview-btn" data-subview="mechanism">Mechanism</button>
      </div>

      <!-- Stats bar (rebuilt per projection) -->
      <div id="stats-bar">
        <!-- Default: Security stats (server-rendered for initial load) -->
        <div class="flex flex-wrap gap-3 mb-4">
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-[#ef4444]"></span>
            <span class="text-[var(--color-text-faint)]">Confirmed</span>
            <span class="font-bold">{statusStats.CONFIRMED}</span>
          </div>
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-[#f59e0b]"></span>
            <span class="text-[var(--color-text-faint)]">Demonstrated</span>
            <span class="font-bold">{statusStats.DEMONSTRATED}</span>
          </div>
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-[#94a3b8]"></span>
            <span class="text-[var(--color-text-faint)]">Theoretical</span>
            <span class="font-bold">{statusStats.THEORETICAL}</span>
          </div>
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-[#8b5cf6]"></span>
            <span class="text-[var(--color-text-faint)]">Emerging</span>
            <span class="font-bold">{statusStats.EMERGING}</span>
          </div>
        </div>
        <div class="flex flex-wrap gap-3 mb-6">
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
            <span class="text-[var(--color-text-faint)]">Total</span>
            <span class="font-bold ml-2">{stats.total}</span>
          </div>
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
            <span class="severity-dot severity-dot--critical"></span>
            <span class="text-[var(--color-text-faint)]">Critical</span>
            <span class="font-bold ml-1">{stats.critical}</span>
          </div>
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
            <span class="severity-dot severity-dot--high"></span>
            <span class="text-[var(--color-text-faint)]">High</span>
            <span class="font-bold ml-1">{stats.high}</span>
          </div>
          <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
            <span class="severity-dot severity-dot--medium"></span>
            <span class="text-[var(--color-text-faint)]">Medium</span>
            <span class="font-bold ml-1">{stats.medium}</span>
          </div>
          {stats.low > 0 && (
            <div class="glass-subtle rounded-lg px-3 py-1.5 text-sm">
              <span class="severity-dot severity-dot--low"></span>
              <span class="text-[var(--color-text-faint)]">Low</span>
              <span class="font-bold ml-1">{stats.low}</span>
            </div>
          )}
        </div>
      </div>

      <!-- Always-visible legend bar (rebuilt per projection by JS) -->
      <div id="legend-bar" class="flex flex-wrap items-center gap-4 text-xs text-[var(--color-text-faint)] mb-4 px-1">
        <!-- Default: Security legend (server-rendered for initial load) -->
        <div class="flex items-center gap-1.5"><span class="inline-block w-3 h-3 rounded" style="background: rgba(239, 68, 68, 0.35);"></span> Critical</div>
        <div class="flex items-center gap-1.5"><span class="inline-block w-3 h-3 rounded" style="background: rgba(245, 158, 11, 0.30);"></span> High</div>
        <div class="flex items-center gap-1.5"><span class="inline-block w-3 h-3 rounded" style="background: rgba(234, 179, 8, 0.25);"></span> Medium</div>
        <div class="flex items-center gap-1.5"><span class="inline-block w-3 h-3 rounded" style="background: rgba(148, 163, 184, 0.25);"></span> Low</div>
        <button id="legend-help-btn" class="ml-2 w-5 h-5 rounded-full border border-[var(--color-border)] text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)] hover:border-[var(--color-border-hover)] text-xs cursor-pointer flex items-center justify-center" aria-label="How to read this grid" title="How to read this grid">?</button>
      </div>

      <!-- Expanded help (hidden by default, toggled by ? button) -->
      <div id="how-to-read" class="glass-subtle rounded-lg mb-6 hidden">
        <div class="px-4 py-3 text-sm text-[var(--color-text-muted)] space-y-3" id="how-to-read-body">
          <div>
            <strong class="text-[var(--color-text-primary)]">Grid axes</strong> &mdash; Rows are hourglass bands (Neural N7&ndash;N1, Interface I0, Synthetic S1&ndash;S3). Columns are attack categories (Signal Injection, Eavesdropping, Data Manipulation, etc.).
          </div>
          <div>
            <strong class="text-[var(--color-text-primary)]">Severity colors</strong> &mdash; Damage potential if the attack succeeds.
            <span class="sev-badge sev-badge--critical ml-1">critical</span>
            <span class="sev-badge sev-badge--high ml-1">high</span>
            <span class="sev-badge sev-badge--medium ml-1">medium</span>
            <span class="sev-badge sev-badge--low ml-1">low</span>
          </div>
          <div>
            <strong class="text-[var(--color-text-primary)]">Status badges</strong> &mdash; Evidence level.
            <span class="status-badge status-badge--CONFIRMED ml-1">confirmed</span> = real-world documented.
            <span class="status-badge status-badge--DEMONSTRATED ml-1">demonstrated</span> = lab-proven.
            <span class="status-badge status-badge--THEORETICAL ml-1">theoretical</span> = plausible from physics/neuroscience.
            <span class="status-badge status-badge--EMERGING ml-1">emerging</span> = newly identified.
          </div>
          <div>
            <strong class="text-[var(--color-text-primary)]">QIF IDs</strong> &mdash; QIF-T0001+ for techniques. Tactics use Qinnovate&rsquo;s TARA Taxonomy (e.g. QIF-N.IJ = Neural Injection). NISS scores rate neural impact 0&ndash;10.
          </div>
        </div>
      </div>

      <!-- Filter toolbar -->
      <div class="flex flex-wrap gap-3 items-center" id="filter-toolbar">
        <input
          type="text"
          id="search-input"
          placeholder="Search threats..."
          class="glass-subtle rounded-lg px-3 py-2 text-sm w-48 focus:outline-none focus:border-[var(--color-accent-primary)] border border-transparent"
        />
        <!-- Dimension-specific filters (rebuilt per projection) -->
        <div id="dimension-filters">
          <div class="flex gap-2 items-center text-sm">
            <span class="text-[var(--color-text-faint)]">Severity:</span>
            <label class="filter-chip active" data-severity="critical"><input type="checkbox" checked class="hidden" /> Critical</label>
            <label class="filter-chip active" data-severity="high"><input type="checkbox" checked class="hidden" /> High</label>
            <label class="filter-chip active" data-severity="medium"><input type="checkbox" checked class="hidden" /> Medium</label>
            <label class="filter-chip active" data-severity="low"><input type="checkbox" checked class="hidden" /> Low</label>
          </div>
          <div class="flex gap-2 items-center text-sm">
            <span class="text-[var(--color-text-faint)]">Status:</span>
            <label class="filter-chip active" data-status="CONFIRMED"><input type="checkbox" checked class="hidden" /> Confirmed</label>
            <label class="filter-chip active" data-status="DEMONSTRATED"><input type="checkbox" checked class="hidden" /> Demonstrated</label>
            <label class="filter-chip active" data-status="THEORETICAL"><input type="checkbox" checked class="hidden" /> Theoretical</label>
            <label class="filter-chip active" data-status="EMERGING"><input type="checkbox" checked class="hidden" /> Emerging</label>
          </div>
        </div>
        <!-- Zone filters (constant across projections) -->
        <div id="zone-filters" class="flex gap-2 items-center text-sm">
          <span class="text-[var(--color-text-faint)]">Zone:</span>
          <label class="filter-chip active" data-zone="neural"><input type="checkbox" checked class="hidden" /> Neural</label>
          <label class="filter-chip active" data-zone="interface"><input type="checkbox" checked class="hidden" /> Interface</label>
          <label class="filter-chip active" data-zone="synthetic"><input type="checkbox" checked class="hidden" /> Synthetic</label>
        </div>
      </div>
    </div>

    <!-- Threat Map Grid -->
    <div class="threat-map-scroll">
      <div class="threat-map" id="threat-map">
        <!-- Header row -->
        <div class="map-header-corner">
          <span class="text-xs text-[var(--color-text-faint)]">Band &darr; &ensp; Category &rarr;</span>
        </div>
        {THREAT_CATEGORIES.map((cat) => (
          <div class="map-header-cell" title={cat.description}>
            <div class="text-xs font-bold font-[family-name:var(--font-mono)] text-[var(--color-accent-secondary)]">{cat.id}</div>
            <div class="text-[10px] text-[var(--color-text-faint)] leading-tight mt-0.5">{cat.name}</div>
          </div>
        ))}

        <!-- Band rows -->
        {bands.map((band, i) => {
          const prevBand = i > 0 ? bands[i - 1] : null;
          const showSeparator = prevBand && prevBand.zone !== band.zone;
          const zoneName = band.zone === 'interface' ? 'I\u2080 Interface' : band.zone === 'synthetic' ? 'Synthetic Domain' : 'Neural Domain';

          return (
            <>
              {showSeparator && (
                <div class="map-zone-separator" style={`grid-column: 1 / -1;`}>
                  <div class="zone-line"></div>
                  <span class="zone-label-text">{zoneName}</span>
                  <div class="zone-line"></div>
                </div>
              )}
              {i === 0 && (
                <div class="map-zone-separator" style="grid-column: 1 / -1;">
                  <div class="zone-line"></div>
                  <span class="zone-label-text">Neural Domain</span>
                  <div class="zone-line"></div>
                </div>
              )}
              <div
                class:list={[
                  "map-row-header",
                  band.zone === 'interface' && "map-row-header--interface",
                ]}
                data-band-id={band.id}
                data-zone={band.zone}
              >
                <span class="font-[family-name:var(--font-mono)] text-xs font-bold" style={`color: ${band.color}`}>{band.id}</span>
                <span class="text-xs text-[var(--color-text-muted)] ml-2 truncate">{band.name}</span>
              </div>
              {THREAT_CATEGORIES.map((cat) => {
                const cellThreats = THREAT_VECTORS.filter(t =>
                  t.bands.includes(band.id as any) && t.category === cat.id
                );
                const maxSev = cellThreats.length > 0
                  ? (['critical', 'high', 'medium', 'low'] as const).find(s => cellThreats.some(t => t.severity === s)) || null
                  : null;

                return (
                  <div
                    class:list={[
                      "map-cell",
                      maxSev && `map-cell--${maxSev}`,
                      band.zone === 'interface' && "map-cell--interface",
                      cellThreats.length === 0 && "map-cell--empty",
                    ]}
                    data-band={band.id}
                    data-category={cat.id}
                    data-zone={band.zone}
                    data-threats={JSON.stringify(cellThreats.map(t => t.id))}
                    data-severity={maxSev || ''}
                  >
                    {cellThreats.length > 0 && (
                      <div class="cell-inner">
                        <span class="cell-count">{cellThreats.length}</span>
                        <span class="cell-sev-dot" data-sev={maxSev}></span>
                      </div>
                    )}
                  </div>
                );
              })}
            </>
          );
        })}
      </div>
    </div>

    <!-- Detail Panel (side drawer) -->
    <div class="detail-drawer" id="detail-drawer">
      <div class="detail-drawer-inner" id="detail-drawer-inner">
        <button class="detail-close" id="detail-close" aria-label="Close">&times;</button>
        <div id="detail-content"></div>
      </div>
    </div>

    <!-- Hover Tooltip -->
    <div class="map-tooltip" id="map-tooltip"></div>
  </div>
</PageLayout>

<style>
  /* ═══ TARA Tabs (Segmented Control) ═══ */
  .tara-tabs {
    display: inline-flex;
    background: rgba(0, 0, 0, 0.04);
    border-radius: 10px;
    padding: 3px;
    margin-bottom: 1.25rem;
    gap: 2px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .tara-tabs::-webkit-scrollbar { display: none; }

  .tara-tab {
    padding: 0.5rem 1.25rem;
    border-radius: 8px;
    border: none;
    background: transparent;
    color: var(--color-text-muted);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    font-family: var(--font-body);
  }
  .tara-tab:hover {
    color: var(--color-text-primary);
  }
  .tara-tab.active {
    background: white;
    color: var(--color-text-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    font-weight: 600;
  }

  /* ═══ Sub-view toggle (Modality projection) ═══ */
  .subview-btn {
    padding: 0.25rem 0.6rem;
    border-radius: 6px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    background: transparent;
    color: var(--color-text-muted);
    font-size: 0.7rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-body);
  }
  .subview-btn:hover {
    color: var(--color-text-primary);
    border-color: rgba(148, 163, 184, 0.4);
  }
  .subview-btn.active {
    background: rgba(var(--color-accent-primary-rgb, 59, 130, 246), 0.1);
    color: var(--color-accent-primary);
    border-color: var(--color-accent-primary);
    font-weight: 600;
  }

  /* ═══ Threat Map Grid ═══ */
  .threat-map-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2rem;
  }

  .threat-map {
    display: grid;
    grid-template-columns: 160px repeat(8, minmax(100px, 1fr));
    gap: 1px;
    min-width: 960px;
  }

  /* Header */
  .map-header-corner {
    position: sticky;
    left: 0;
    z-index: 3;
    background: var(--color-bg-deep);
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: flex-end;
  }

  .map-header-cell {
    background: var(--color-bg-surface);
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--color-border);
    text-align: center;
    cursor: help;
  }

  /* Zone separator */
  .map-zone-separator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.4rem 0.75rem;
    background: var(--color-bg-deep);
  }

  .zone-line {
    flex: 1;
    height: 1px;
    background: var(--color-border);
  }

  .zone-label-text {
    font-size: 0.65rem;
    color: var(--color-text-faint);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
  }

  /* Row headers */
  .map-row-header {
    position: sticky;
    left: 0;
    z-index: 2;
    background: var(--color-bg-deep);
    padding: 0.5rem 0.75rem;
    display: flex;
    align-items: center;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    min-height: 44px;
  }

  .map-row-header--interface {
    background: rgba(245, 158, 11, 0.05);
    border-top: 1px solid rgba(245, 158, 11, 0.15);
    border-bottom: 1px solid rgba(245, 158, 11, 0.15);
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.08);
  }

  /* Grid cells */
  .map-cell {
    background: var(--color-bg-surface);
    padding: 0.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .map-cell--empty { cursor: default; opacity: 0.4; }

  .map-cell:not(.map-cell--empty):hover {
    transform: scale(1.05);
    z-index: 1;
    box-shadow: 0 0 12px rgba(0,0,0,0.12);
  }

  .map-cell--interface { background: rgba(245, 158, 11, 0.05); }

  /* ═══ Cell color classes — Security (severity, default) ═══ */
  .map-cell--critical, .map-cell--sev-critical { background: rgba(239, 68, 68, 0.12); }
  .map-cell--critical:hover, .map-cell--sev-critical:hover { background: rgba(239, 68, 68, 0.22); }
  .map-cell--high, .map-cell--sev-high { background: rgba(245, 158, 11, 0.10); }
  .map-cell--high:hover, .map-cell--sev-high:hover { background: rgba(245, 158, 11, 0.20); }
  .map-cell--medium, .map-cell--sev-medium { background: rgba(234, 179, 8, 0.08); }
  .map-cell--medium:hover, .map-cell--sev-medium:hover { background: rgba(234, 179, 8, 0.18); }
  .map-cell--low, .map-cell--sev-low { background: rgba(148, 163, 184, 0.06); }
  .map-cell--low:hover, .map-cell--sev-low:hover { background: rgba(148, 163, 184, 0.14); }

  /* ═══ Cell color classes — Clinical (dual-use) ═══ */
  .map-cell--du-confirmed { background: rgba(16, 185, 129, 0.12); }
  .map-cell--du-confirmed:hover { background: rgba(16, 185, 129, 0.22); }
  .map-cell--du-probable { background: rgba(6, 182, 212, 0.10); }
  .map-cell--du-probable:hover { background: rgba(6, 182, 212, 0.20); }
  .map-cell--du-possible { background: rgba(139, 92, 246, 0.08); }
  .map-cell--du-possible:hover { background: rgba(139, 92, 246, 0.18); }
  .map-cell--du-silicon_only { background: rgba(148, 163, 184, 0.06); }
  .map-cell--du-silicon_only:hover { background: rgba(148, 163, 184, 0.14); }

  /* ═══ Cell color classes — Governance (consent tier) ═══ */
  .map-cell--ct-standard { background: rgba(34, 197, 94, 0.10); }
  .map-cell--ct-standard:hover { background: rgba(34, 197, 94, 0.20); }
  .map-cell--ct-enhanced { background: rgba(245, 158, 11, 0.10); }
  .map-cell--ct-enhanced:hover { background: rgba(245, 158, 11, 0.20); }
  .map-cell--ct-IRB { background: rgba(239, 68, 68, 0.12); }
  .map-cell--ct-IRB:hover { background: rgba(239, 68, 68, 0.22); }
  .map-cell--ct-prohibited { background: rgba(127, 29, 29, 0.18); }
  .map-cell--ct-prohibited:hover { background: rgba(127, 29, 29, 0.28); }

  /* ═══ Cell color classes — Engineering (coupling) ═══ */
  .map-cell--cp-electromagnetic { background: rgba(59, 130, 246, 0.12); }
  .map-cell--cp-electromagnetic:hover { background: rgba(59, 130, 246, 0.22); }
  .map-cell--cp-mechanical { background: rgba(245, 158, 11, 0.10); }
  .map-cell--cp-mechanical:hover { background: rgba(245, 158, 11, 0.20); }
  .map-cell--cp-thermal { background: rgba(239, 68, 68, 0.10); }
  .map-cell--cp-thermal:hover { background: rgba(239, 68, 68, 0.20); }
  .map-cell--cp-optical { background: rgba(168, 85, 247, 0.10); }
  .map-cell--cp-optical:hover { background: rgba(168, 85, 247, 0.20); }
  .map-cell--cp-none { background: rgba(148, 163, 184, 0.06); }
  .map-cell--cp-none:hover { background: rgba(148, 163, 184, 0.14); }

  /* ═══ Cell color classes — Diagnostic (DSM-5-TR clusters) ═══ */
  .map-cell--dc-cognitive_psychotic { background: rgba(245, 158, 11, 0.12); }
  .map-cell--dc-cognitive_psychotic:hover { background: rgba(245, 158, 11, 0.22); }
  .map-cell--dc-mood_trauma { background: rgba(234, 179, 8, 0.10); }
  .map-cell--dc-mood_trauma:hover { background: rgba(234, 179, 8, 0.20); }
  .map-cell--dc-motor_neurocognitive { background: rgba(239, 68, 68, 0.12); }
  .map-cell--dc-motor_neurocognitive:hover { background: rgba(239, 68, 68, 0.22); }
  .map-cell--dc-persistent_personality { background: rgba(168, 85, 247, 0.10); }
  .map-cell--dc-persistent_personality:hover { background: rgba(168, 85, 247, 0.20); }
  .map-cell--dc-non_diagnostic { background: rgba(148, 163, 184, 0.06); }
  .map-cell--dc-non_diagnostic:hover { background: rgba(148, 163, 184, 0.14); }

  .cell-inner {
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .cell-count {
    font-size: 0.85rem;
    font-weight: 700;
    font-family: var(--font-mono);
    color: var(--color-text-primary);
  }

  .cell-sev-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    transition: background 0.2s, box-shadow 0.2s;
  }
  .cell-sev-dot[data-sev="critical"] { background: #ef4444; }
  .cell-sev-dot[data-sev="high"] { background: #f59e0b; }
  .cell-sev-dot[data-sev="medium"] { background: #eab308; }
  .cell-sev-dot[data-sev="low"] { background: #94a3b8; }
  /* Clinical dot colors */
  .cell-sev-dot[data-sev="confirmed"] { background: #10b981; }
  .cell-sev-dot[data-sev="probable"] { background: #06b6d4; }
  .cell-sev-dot[data-sev="possible"] { background: #8b5cf6; }
  .cell-sev-dot[data-sev="silicon_only"] { background: #94a3b8; }
  /* Governance dot colors */
  .cell-sev-dot[data-sev="standard"] { background: #22c55e; }
  .cell-sev-dot[data-sev="enhanced"] { background: #f59e0b; }
  .cell-sev-dot[data-sev="IRB"] { background: #ef4444; }
  .cell-sev-dot[data-sev="prohibited"] { background: #7f1d1d; }
  /* Engineering dot colors */
  .cell-sev-dot[data-sev="electromagnetic"] { background: #3b82f6; }
  .cell-sev-dot[data-sev="mechanical"] { background: #f59e0b; }
  .cell-sev-dot[data-sev="thermal"] { background: #ef4444; }
  .cell-sev-dot[data-sev="optical"] { background: #a855f7; }
  .cell-sev-dot[data-sev="none"] { background: #94a3b8; }

  /* Severity dots in stats bar */
  .severity-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }
  .severity-dot--critical { background: #ef4444; }
  .severity-dot--high { background: #f59e0b; }
  .severity-dot--medium { background: #eab308; }
  .severity-dot--low { background: #94a3b8; }

  /* Filter chips */
  .filter-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.6rem;
    border-radius: 99px;
    border: 1px solid var(--color-border);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--color-text-faint);
    user-select: none;
  }

  .filter-chip.active {
    border-color: var(--color-accent-secondary);
    color: var(--color-accent-secondary);
    background: rgba(6, 182, 212, 0.1);
  }

  .filter-chip:hover { border-color: var(--color-text-muted); }

  #dimension-filters {
    display: contents;
  }

  /* Detail drawer */
  .detail-drawer {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 460px;
    max-width: 90vw;
    z-index: 60;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .detail-drawer.open {
    transform: translateX(0);
    pointer-events: auto;
  }

  .detail-drawer-inner {
    height: 100%;
    overflow-y: auto;
    background: var(--color-bg-surface);
    border-left: 1px solid var(--color-border);
    padding: 1.5rem;
    position: relative;
  }

  .detail-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: 1px solid var(--color-border);
    color: var(--color-text-muted);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .detail-close:hover {
    border-color: var(--color-text-primary);
    color: var(--color-text-primary);
    background: var(--color-bg-elevated);
  }

  /* Detail content */
  .detail-threat {
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .detail-threat:last-child { border-bottom: none; }

  .detail-threat-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text-primary);
    margin-bottom: 0.25rem;
  }

  .detail-threat-id {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-text-faint);
    margin-bottom: 0.5rem;
  }

  .detail-meta {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.25rem 0.75rem;
    font-size: 0.8rem;
    margin: 0.5rem 0;
  }

  .detail-meta dt { color: var(--color-text-faint); }
  .detail-meta dd { color: var(--color-text-primary); }

  .detail-description {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.5;
    margin-top: 0.5rem;
  }

  .detail-sources {
    font-size: 0.7rem;
    color: var(--color-text-faint);
    margin-top: 0.4rem;
    font-style: italic;
  }

  .detail-niss {
    font-size: 0.7rem;
    color: var(--color-text-faint);
    margin-top: 0.3rem;
    font-family: var(--font-mono);
  }

  .detail-tactic {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    margin-top: 0.3rem;
    font-family: var(--font-mono);
  }

  .sev-badge {
    display: inline-block;
    padding: 0.1rem 0.5rem;
    border-radius: 99px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .sev-badge--critical { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
  .sev-badge--high { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
  .sev-badge--medium { background: rgba(234,179,8,0.15); color: #eab308; border: 1px solid rgba(234,179,8,0.3); }
  .sev-badge--low { background: rgba(148,163,184,0.15); color: #94a3b8; border: 1px solid rgba(148,163,184,0.3); }

  .status-badge {
    display: inline-block;
    padding: 0.1rem 0.5rem;
    border-radius: 99px;
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .status-badge--CONFIRMED { background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.2); }
  .status-badge--DEMONSTRATED { background: rgba(245,158,11,0.12); color: #f59e0b; border: 1px solid rgba(245,158,11,0.2); }
  .status-badge--THEORETICAL { background: rgba(148,163,184,0.12); color: #94a3b8; border: 1px solid rgba(148,163,184,0.2); }
  .status-badge--EMERGING { background: rgba(139,92,246,0.12); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.2); }

  /* Hover tooltip */
  .map-tooltip {
    position: fixed;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 0.6rem 0.8rem;
    font-size: 0.75rem;
    max-width: 300px;
    pointer-events: none;
    opacity: 0;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    transition: opacity 0.15s;
  }

  .map-tooltip.visible { opacity: 1; }

  .map-tooltip .tt-name {
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 0.2rem;
  }

  .map-tooltip .tt-meta {
    color: var(--color-text-faint);
    font-size: 0.7rem;
  }

  /* Hidden by filter */
  .map-cell.filtered-out {
    opacity: 0.08 !important;
    pointer-events: none;
  }

  .map-row-header.filtered-out { opacity: 0.3; }

  /* Responsive */
  @media (max-width: 768px) {
    .threat-map {
      grid-template-columns: 120px repeat(8, 90px);
    }
    .detail-drawer { width: 100%; max-width: 100vw; }
  }
</style>

<script define:vars={{ allThreatsJson, projectionConfigJson }}>
  // ═══════════════════════════════════════════════════════════════
  // TARA Multi-Pane Threat Registry — Client-Side Controller
  //
  // All projection config is driven by data from tara-projections.ts,
  // serialized at build time. The rendering functions below are generic
  // and operate on that config — no hardcoded projection logic.
  // ═══════════════════════════════════════════════════════════════

  // ── Data from server ──
  var ALL_THREATS = JSON.parse(allThreatsJson);
  var PROJ_CONFIG = JSON.parse(projectionConfigJson);

  var THREATS = {};
  for (var i = 0; i < ALL_THREATS.length; i++) {
    THREATS[ALL_THREATS[i].id] = ALL_THREATS[i];
  }

  // Build projection lookup
  var PROJECTIONS = {};
  for (var p = 0; p < PROJ_CONFIG.projections.length; p++) {
    var proj = PROJ_CONFIG.projections[p];
    PROJECTIONS[proj.id] = proj;
  }

  // ── State ──
  var activeProjection = 'modality';
  var activeSubView = 'impact'; // For modality projection: 'impact' or 'mechanism'
  var lastOpenedCell = null;

  var PROJECTION_DESCRIPTIONS = {
    modality: 'How each technique works — toggle between impact severity and physical mechanism',
    clinical: 'Therapeutic applications, FDA status, and evidence levels',
    diagnostic: 'DSM-5-TR psychiatric diagnoses mapped via the Neural Impact Chain',
    governance: 'Consent requirements and regulatory classifications',
  };

  // ── DOM refs ──
  var threatPage = document.getElementById('threat-page');
  var tabsNav = document.getElementById('tara-tabs');
  var statsBar = document.getElementById('stats-bar');
  var dimFilters = document.getElementById('dimension-filters');
  var zoneFiltersEl = document.getElementById('zone-filters');
  var howToRead = document.getElementById('how-to-read');
  var howToReadBody = document.getElementById('how-to-read-body');
  var legendBar = document.getElementById('legend-bar');
  var legendHelpBtn = document.getElementById('legend-help-btn');
  var tooltip = document.getElementById('map-tooltip');
  var drawer = document.getElementById('detail-drawer');
  var drawerContent = document.getElementById('detail-content');
  var drawerClose = document.getElementById('detail-close');
  var searchInput = document.getElementById('search-input');

  // ═══════════════════════════════════════════════════════════════
  // Value extractors per projection (can't serialize functions,
  // so we define them client-side keyed by projection ID)
  // ═══════════════════════════════════════════════════════════════

  var VALUE_EXTRACTORS = {
    modality: function(t) {
      // Sub-view aware: impact uses severity, mechanism uses coupling
      if (activeSubView === 'mechanism') {
        if (!t.tara || !t.tara.engineering || !t.tara.engineering.coupling || t.tara.engineering.coupling.length === 0) return 'none';
        return t.tara.engineering.coupling[0];
      }
      return t.severity;
    },
    clinical: function(t) { return t.tara ? t.tara.dual_use : null; },
    diagnostic: function(t) { return (t.tara && t.tara.dsm5) ? t.tara.dsm5.cluster : null; },
    governance: function(t) { return t.tara ? t.tara.governance.consent_tier : null; },
  };

  // ═══════════════════════════════════════════════════════════════
  // Filter matchers per projection
  // ═══════════════════════════════════════════════════════════════

  var FILTER_MATCHERS = {
    modality: function(t, active) {
      var sevSet = active['severity'];
      var statusSet = active['status'];
      var cpSet = active['coupling'];
      if (sevSet && !sevSet.has(t.severity)) return false;
      if (statusSet && !statusSet.has(t.status)) return false;
      if (cpSet) {
        var val = 'none';
        if (t.tara && t.tara.engineering && t.tara.engineering.coupling && t.tara.engineering.coupling.length > 0) {
          val = t.tara.engineering.coupling[0];
        }
        if (!cpSet.has(val)) return false;
      }
      return true;
    },
    clinical: function(t, active) {
      var duSet = active['dualuse'];
      var fdaSet = active['fda'];
      if (duSet && !duSet.has(t.tara ? t.tara.dual_use : '')) return false;
      if (fdaSet) {
        var fdaVal = (t.tara && t.tara.clinical) ? t.tara.clinical.fda_status : 'none';
        if (!fdaSet.has(fdaVal)) return false;
      }
      return true;
    },
    diagnostic: function(t, active) {
      var clusterSet = active['cluster'];
      var rcSet = active['riskclass'];
      if (clusterSet && !clusterSet.has((t.tara && t.tara.dsm5) ? t.tara.dsm5.cluster : '')) return false;
      if (rcSet && !rcSet.has((t.tara && t.tara.dsm5) ? t.tara.dsm5.risk_class : '')) return false;
      return true;
    },
    governance: function(t, active) {
      var ctSet = active['consent'];
      if (ctSet && !ctSet.has(t.tara ? t.tara.governance.consent_tier : '')) return false;
      return true;
    },
  };

  // ═══════════════════════════════════════════════════════════════
  // Detail renderers per projection
  // ═══════════════════════════════════════════════════════════════

  function makeBadge(text, bg, color, border) {
    var b = border ? 'border:1px solid ' + border + ';' : '';
    return '<span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:99px;font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;background:' + bg + ';color:' + color + ';' + b + '">' + text + '</span>';
  }

  var STATUS_BADGE_COLORS = {
    CONFIRMED: { bg: 'rgba(239,68,68,0.12)', color: '#ef4444', border: 'rgba(239,68,68,0.2)' },
    DEMONSTRATED: { bg: 'rgba(245,158,11,0.12)', color: '#f59e0b', border: 'rgba(245,158,11,0.2)' },
    THEORETICAL: { bg: 'rgba(148,163,184,0.12)', color: '#94a3b8', border: 'rgba(148,163,184,0.2)' },
    EMERGING: { bg: 'rgba(139,92,246,0.12)', color: '#8b5cf6', border: 'rgba(139,92,246,0.2)' },
  };

  var DUAL_USE_BADGE = {
    confirmed: { bg: 'rgba(16,185,129,0.15)', color: '#10b981', border: 'rgba(16,185,129,0.3)' },
    probable: { bg: 'rgba(6,182,212,0.15)', color: '#06b6d4', border: 'rgba(6,182,212,0.3)' },
    possible: { bg: 'rgba(139,92,246,0.15)', color: '#8b5cf6', border: 'rgba(139,92,246,0.3)' },
    silicon_only: { bg: 'rgba(148,163,184,0.15)', color: '#94a3b8', border: 'rgba(148,163,184,0.3)' },
  };

  var FDA_BADGE = {
    cleared: { bg: 'rgba(16,185,129,0.12)', color: '#10b981' },
    approved: { bg: 'rgba(34,197,94,0.12)', color: '#22c55e' },
    breakthrough: { bg: 'rgba(6,182,212,0.12)', color: '#06b6d4' },
    investigational: { bg: 'rgba(245,158,11,0.12)', color: '#f59e0b' },
    none: { bg: 'rgba(148,163,184,0.12)', color: '#94a3b8' },
    'N/A': { bg: 'rgba(100,116,139,0.12)', color: '#64748b' },
  };

  var CONSENT_BADGE = {
    standard: { bg: 'rgba(34,197,94,0.12)', color: '#22c55e' },
    enhanced: { bg: 'rgba(245,158,11,0.12)', color: '#f59e0b' },
    IRB: { bg: 'rgba(239,68,68,0.12)', color: '#ef4444' },
    prohibited: { bg: 'rgba(127,29,29,0.2)', color: '#ef4444' },
  };

  var COUPLING_BADGE = {
    electromagnetic: { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', border: 'rgba(59,130,246,0.3)' },
    mechanical: { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b', border: 'rgba(245,158,11,0.3)' },
    thermal: { bg: 'rgba(239,68,68,0.15)', color: '#ef4444', border: 'rgba(239,68,68,0.3)' },
    optical: { bg: 'rgba(168,85,247,0.15)', color: '#a855f7', border: 'rgba(168,85,247,0.3)' },
    none: { bg: 'rgba(148,163,184,0.15)', color: '#94a3b8', border: 'rgba(148,163,184,0.3)' },
  };

  var CLUSTER_BADGE = {
    cognitive_psychotic: { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b', border: 'rgba(245,158,11,0.3)' },
    mood_trauma: { bg: 'rgba(234,179,8,0.15)', color: '#eab308', border: 'rgba(234,179,8,0.3)' },
    motor_neurocognitive: { bg: 'rgba(239,68,68,0.15)', color: '#ef4444', border: 'rgba(239,68,68,0.3)' },
    persistent_personality: { bg: 'rgba(168,85,247,0.15)', color: '#a855f7', border: 'rgba(168,85,247,0.3)' },
    non_diagnostic: { bg: 'rgba(148,163,184,0.15)', color: '#94a3b8', border: 'rgba(148,163,184,0.3)' },
  };

  var CLUSTER_LABELS = {
    cognitive_psychotic: 'Cognitive/Psychotic',
    mood_trauma: 'Mood/Trauma',
    motor_neurocognitive: 'Motor/Neurocognitive',
    persistent_personality: 'Persistent/Personality',
    non_diagnostic: 'Non-Diagnostic',
  };

  var RISK_CLASS_BADGE = {
    direct: { bg: 'rgba(239,68,68,0.12)', color: '#ef4444', border: 'rgba(239,68,68,0.2)' },
    indirect: { bg: 'rgba(245,158,11,0.12)', color: '#f59e0b', border: 'rgba(245,158,11,0.2)' },
    none: { bg: 'rgba(148,163,184,0.12)', color: '#94a3b8', border: 'rgba(148,163,184,0.2)' },
  };

  var CONFIDENCE_BADGE = {
    established: { bg: 'rgba(16,185,129,0.12)', color: '#10b981' },
    probable: { bg: 'rgba(245,158,11,0.12)', color: '#f59e0b' },
    theoretical: { bg: 'rgba(148,163,184,0.12)', color: '#94a3b8' },
  };

  var DETAIL_RENDERERS = {
    modality: function(t) {
      // Merged security + engineering detail
      var sc = STATUS_BADGE_COLORS[t.status] || STATUS_BADGE_COLORS.THEORETICAL;
      var statusBdg = makeBadge(t.status, sc.bg, sc.color, sc.border);
      var html = '<div class="detail-threat-name">' + t.name + ' <span class="sev-badge sev-badge--' + t.severity + '">' + t.severity + '</span> ' + statusBdg + '</div>';
      html += '<div class="detail-threat-id">' + t.id + '</div>';
      html += '<dl class="detail-meta">';
      html += '<dt>Bands</dt><dd>' + t.bandsStr + '</dd>';
      if (t.coupling) html += '<dt>Coupling</dt><dd>' + t.coupling + '</dd>';
      if (t.access) html += '<dt>Access</dt><dd>' + t.access + '</dd>';
      var detColor = t.classicalDetection === 'Yes' ? '#10b981' : t.classicalDetection === 'Partial' ? '#f59e0b' : '#ef4444';
      html += '<dt>Classical</dt><dd style="color:' + detColor + '">' + t.classicalDetection + '</dd>';
      html += '<dt>Quantum</dt><dd style="color:#8b5cf6">' + t.quantumDetection + '</dd>';
      html += '</dl>';
      html += '<div class="detail-description">' + t.description + '</div>';
      if (t.niss && t.niss.score > 0) {
        html += '<div class="detail-niss">NISS ' + t.niss.score.toFixed(1) + ' (' + t.niss.severity + ') \u2014 ' + t.niss.vector + '</div>';
      }
      // Engineering data
      if (t.tara && t.tara.engineering) {
        var eng = t.tara.engineering;
        var couplingVal = (eng.coupling && eng.coupling.length > 0) ? eng.coupling[0] : 'none';
        var cpC = COUPLING_BADGE[couplingVal] || COUPLING_BADGE.none;
        var cpBdg = makeBadge(couplingVal, cpC.bg, cpC.color, cpC.border);
        html += '<div style="margin-top:0.5rem;font-size:0.75rem;color:var(--color-text-muted);"><strong>Mechanism:</strong> ' + cpBdg + '</div>';
        var paramKeys = Object.keys(eng.parameters || {});
        if (paramKeys.length > 0) {
          html += '<dl class="detail-meta">';
          for (var pk = 0; pk < paramKeys.length; pk++) {
            html += '<dt>' + paramKeys[pk].replace(/_/g, ' ') + '</dt><dd>' + eng.parameters[paramKeys[pk]] + '</dd>';
          }
          html += '</dl>';
        }
        if (eng.hardware && eng.hardware.length > 0) {
          html += '<div style="font-size:0.75rem;color:var(--color-text-muted);"><strong>Hardware:</strong></div>';
          html += '<ul style="font-size:0.75rem;color:var(--color-text-muted);margin:0 0 0.4rem 1rem;padding:0;">';
          for (var h = 0; h < eng.hardware.length; h++) html += '<li>' + eng.hardware[h].replace(/_/g, ' ') + '</li>';
          html += '</ul>';
        }
        if (eng.detection) {
          html += '<div style="font-size:0.75rem;color:var(--color-text-muted);"><strong>Detection:</strong> ' + eng.detection + '</div>';
        }
      }
      html += '<div class="detail-tactic">' + t.tactic + '</div>';
      if (t.crossRefs && t.crossRefs.secondary_tactics && t.crossRefs.secondary_tactics.length > 0) {
        html += '<div class="detail-tactic">Also: ' + t.crossRefs.secondary_tactics.join(', ') + '</div>';
      }
      if (t.sources && t.sources.length > 0) {
        html += '<div class="detail-sources">Sources: ' + t.sources.join('; ') + '</div>';
      }
      return html;
    },

    clinical: function(t) {
      var du = t.tara ? t.tara.dual_use : 'silicon_only';
      var duC = DUAL_USE_BADGE[du] || DUAL_USE_BADGE.silicon_only;
      var duBdg = makeBadge(du.replace('_', ' '), duC.bg, duC.color, duC.border);
      var html = '<div class="detail-threat-name">' + t.name + ' ' + duBdg + '</div>';
      html += '<div class="detail-threat-id">' + t.id + '</div>';

      if (t.tara && t.tara.clinical) {
        var c = t.tara.clinical;
        var fdaC = FDA_BADGE[c.fda_status] || FDA_BADGE.none;
        var fdaBdg = makeBadge(c.fda_status, fdaC.bg, fdaC.color);
        html += '<div style="margin:0.5rem 0;font-size:0.85rem;color:var(--color-text-primary);font-weight:600;">' + c.therapeutic_analog + '</div>';
        html += '<div style="margin-bottom:0.5rem;">' + fdaBdg + ' <span style="font-size:0.7rem;color:var(--color-text-faint);margin-left:0.3rem;">Evidence: ' + c.evidence_level + '</span></div>';
        if (c.conditions && c.conditions.length > 0) {
          html += '<div style="font-size:0.75rem;color:var(--color-text-muted);margin-bottom:0.4rem;"><strong>Conditions:</strong></div>';
          html += '<ul style="font-size:0.75rem;color:var(--color-text-muted);margin:0 0 0.5rem 1rem;padding:0;">';
          for (var j = 0; j < c.conditions.length; j++) html += '<li>' + c.conditions[j] + '</li>';
          html += '</ul>';
        }
        if (c.safe_parameters) {
          html += '<div style="font-size:0.75rem;color:var(--color-text-muted);"><strong>Safe parameters:</strong> ' + c.safe_parameters + '</div>';
        }
        if (c.sources && c.sources.length > 0) {
          html += '<div class="detail-sources">Clinical sources: ' + c.sources.join('; ') + '</div>';
        }
      } else {
        html += '<div style="font-size:0.8rem;color:var(--color-text-faint);font-style:italic;margin-top:0.5rem;">No therapeutic analog \u2014 pure digital/silicon attack vector</div>';
      }
      return html;
    },

    governance: function(t) {
      if (!t.tara) return '<div class="detail-threat-name">' + t.name + '</div><div class="detail-threat-id">' + t.id + '</div><div style="font-size:0.8rem;color:var(--color-text-faint);">No governance data</div>';
      var gov = t.tara.governance;
      var ctC = CONSENT_BADGE[gov.consent_tier] || CONSENT_BADGE.standard;
      var ctBdg = makeBadge(gov.consent_tier, ctC.bg, ctC.color);
      var html = '<div class="detail-threat-name">' + t.name + ' ' + ctBdg + '</div>';
      html += '<div class="detail-threat-id">' + t.id + '</div>';
      html += '<dl class="detail-meta">';
      html += '<dt>Safety Ceiling</dt><dd>' + gov.safety_ceiling + '</dd>';
      html += '<dt>Data Class.</dt><dd>' + gov.data_classification + '</dd>';
      html += '</dl>';
      if (gov.monitoring && gov.monitoring.length > 0) {
        html += '<div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.4rem;"><strong>Monitoring:</strong></div>';
        html += '<ul style="font-size:0.75rem;color:var(--color-text-muted);margin:0 0 0.4rem 1rem;padding:0;">';
        for (var m = 0; m < gov.monitoring.length; m++) html += '<li>' + gov.monitoring[m].replace(/_/g, ' ') + '</li>';
        html += '</ul>';
      }
      if (gov.regulations && gov.regulations.length > 0) {
        html += '<div style="font-size:0.75rem;color:var(--color-text-muted);"><strong>Regulations:</strong></div>';
        html += '<ul style="font-size:0.75rem;color:var(--color-text-muted);margin:0 0 0 1rem;padding:0;">';
        for (var r = 0; r < gov.regulations.length; r++) html += '<li>' + gov.regulations[r] + '</li>';
        html += '</ul>';
      }
      return html;
    },

    diagnostic: function(t) {
      var dsm = (t.tara && t.tara.dsm5) ? t.tara.dsm5 : null;
      var cluster = dsm ? dsm.cluster : 'non_diagnostic';
      var clC = CLUSTER_BADGE[cluster] || CLUSTER_BADGE.non_diagnostic;
      var clBdg = makeBadge(CLUSTER_LABELS[cluster] || cluster, clC.bg, clC.color, clC.border);
      var rc = dsm ? dsm.risk_class : 'none';
      var rcC = RISK_CLASS_BADGE[rc] || RISK_CLASS_BADGE.none;
      var rcBdg = makeBadge('risk: ' + rc, rcC.bg, rcC.color, rcC.border);
      var html = '<div class="detail-threat-name">' + t.name + ' ' + clBdg + ' ' + rcBdg + '</div>';
      html += '<div class="detail-threat-id">' + t.id + '</div>';
      if (!dsm || cluster === 'non_diagnostic') {
        html += '<div style="font-size:0.8rem;color:var(--color-text-faint);font-style:italic;margin-top:0.5rem;">Silicon-only technique \u2014 no direct psychiatric diagnostic mapping.</div>';
        return html;
      }
      if (dsm.pathway) {
        html += '<div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.5rem;"><strong>Neural pathway:</strong> ' + dsm.pathway + '</div>';
      }
      if (dsm.niss_correlation) {
        html += '<div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.2rem;"><strong>NISS \u2192 DSM:</strong> ' + dsm.niss_correlation + '</div>';
      }
      if (dsm.primary && dsm.primary.length > 0) {
        html += '<div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.5rem;"><strong>Primary diagnoses:</strong></div>';
        html += '<ul style="font-size:0.75rem;color:var(--color-text-muted);margin:0 0 0.4rem 1rem;padding:0;">';
        for (var i = 0; i < dsm.primary.length; i++) {
          var d = dsm.primary[i];
          var confC = CONFIDENCE_BADGE[d.confidence] || CONFIDENCE_BADGE.theoretical;
          var confBdg = makeBadge(d.confidence, confC.bg, confC.color);
          html += '<li><code style="font-size:0.7rem;background:rgba(148,163,184,0.1);padding:0.1rem 0.3rem;border-radius:3px;">' + d.code + '</code> ' + d.name + ' ' + confBdg + '</li>';
        }
        html += '</ul>';
      }
      if (dsm.secondary && dsm.secondary.length > 0) {
        html += '<details style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.3rem;">';
        html += '<summary style="cursor:pointer;"><strong>Secondary diagnoses</strong> (' + dsm.secondary.length + ')</summary>';
        html += '<ul style="margin:0.2rem 0 0 1rem;padding:0;">';
        for (var j = 0; j < dsm.secondary.length; j++) {
          var sd = dsm.secondary[j];
          var sConfC = CONFIDENCE_BADGE[sd.confidence] || CONFIDENCE_BADGE.theoretical;
          var sConfBdg = makeBadge(sd.confidence, sConfC.bg, sConfC.color);
          html += '<li><code style="font-size:0.7rem;background:rgba(148,163,184,0.1);padding:0.1rem 0.3rem;border-radius:3px;">' + sd.code + '</code> ' + sd.name + ' ' + sConfBdg + '</li>';
        }
        html += '</ul></details>';
      }
      return html;
    },
  };

  // ═══════════════════════════════════════════════════════════════
  // Grid recoloring
  // ═══════════════════════════════════════════════════════════════

  // All possible color class prefixes for stripping
  var COLOR_PREFIXES = ['map-cell--critical', 'map-cell--high', 'map-cell--medium', 'map-cell--low',
    'map-cell--sev-critical', 'map-cell--sev-high', 'map-cell--sev-medium', 'map-cell--sev-low',
    'map-cell--du-confirmed', 'map-cell--du-probable', 'map-cell--du-possible', 'map-cell--du-silicon_only',
    'map-cell--ct-standard', 'map-cell--ct-enhanced', 'map-cell--ct-IRB', 'map-cell--ct-prohibited',
    'map-cell--cp-electromagnetic', 'map-cell--cp-mechanical', 'map-cell--cp-thermal', 'map-cell--cp-optical', 'map-cell--cp-none',
    'map-cell--dc-cognitive_psychotic', 'map-cell--dc-mood_trauma', 'map-cell--dc-motor_neurocognitive', 'map-cell--dc-persistent_personality', 'map-cell--dc-non_diagnostic'];

  function recolorGrid(projId) {
    var proj = PROJECTIONS[projId];
    var prefix = proj.cellClassPrefix;
    var ranking = proj.valueRanking;
    var extractor = VALUE_EXTRACTORS[projId];

    // Handle sub-views for modality projection
    if (projId === 'modality' && proj.subViews) {
      var sv = null;
      for (var si = 0; si < proj.subViews.length; si++) {
        if (proj.subViews[si].id === activeSubView) { sv = proj.subViews[si]; break; }
      }
      if (sv) {
        prefix = sv.cellClassPrefix;
        ranking = sv.valueRanking;
      }
    }

    document.querySelectorAll('.map-cell').forEach(function(cell) {
      var threatIds = JSON.parse(cell.dataset.threats || '[]');

      // Strip all color classes
      for (var ci = 0; ci < COLOR_PREFIXES.length; ci++) {
        cell.classList.remove(COLOR_PREFIXES[ci]);
      }

      if (threatIds.length === 0) return;

      var threats = threatIds.map(function(id) { return THREATS[id]; }).filter(Boolean);

      // Find dominant value (hottest by ranking)
      var dominant = null;
      for (var ri = 0; ri < ranking.length; ri++) {
        for (var ti = 0; ti < threats.length; ti++) {
          var val = extractor(threats[ti]);
          if (val === ranking[ri]) {
            dominant = val;
            break;
          }
        }
        if (dominant) break;
      }

      // Apply new color class
      if (dominant) {
        // For modality/impact sub-view, use original class names (backward compat with CSS)
        if (projId === 'modality' && activeSubView === 'impact') {
          cell.classList.add('map-cell--' + dominant);
        } else {
          cell.classList.add('map-cell--' + prefix + '-' + dominant);
        }
      }

      // Update dot indicator
      var dot = cell.querySelector('.cell-sev-dot');
      if (dot) {
        dot.setAttribute('data-sev', dominant || '');
      }
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // Stats bar rebuild
  // ═══════════════════════════════════════════════════════════════

  function rebuildStats(projId) {
    var proj = PROJECTIONS[projId];
    var statRows = proj.stats;
    var extractor = VALUE_EXTRACTORS[projId];

    // No special-case needed — all stats are computed at build time

    var html = '';
    for (var r = 0; r < statRows.length; r++) {
      html += '<div class="flex flex-wrap gap-3 mb-' + (r < statRows.length - 1 ? '4' : '6') + '">';
      for (var s = 0; s < statRows[r].items.length; s++) {
        var it = statRows[r].items[s];
        html += '<div class="glass-subtle rounded-lg px-3 py-1.5 text-sm flex items-center gap-2">';
        if (it.dotColor) {
          html += '<span class="w-2 h-2 rounded-full" style="background:' + it.dotColor + ';"></span>';
        }
        html += '<span class="text-[var(--color-text-faint)]">' + it.label + '</span>';
        html += '<span class="font-bold">' + it.count + '</span>';
        html += '</div>';
      }
      html += '</div>';
    }
    statsBar.innerHTML = html;
  }

  // ═══════════════════════════════════════════════════════════════
  // Filter rebuild
  // ═══════════════════════════════════════════════════════════════

  function rebuildFilters(projId) {
    var proj = PROJECTIONS[projId];
    var groups = proj.filters;

    var html = '';
    for (var g = 0; g < groups.length; g++) {
      var grp = groups[g];
      html += '<div class="flex gap-2 items-center text-sm">';
      html += '<span class="text-[var(--color-text-faint)]">' + grp.label + ':</span>';
      for (var v = 0; v < grp.values.length; v++) {
        var val = grp.values[v];
        html += '<label class="filter-chip active" data-' + grp.attr + '="' + val.key + '">';
        html += '<input type="checkbox" checked class="hidden" /> ' + val.label;
        html += '</label>';
      }
      html += '</div>';
    }
    dimFilters.innerHTML = html;

    // Wire up new chips
    dimFilters.querySelectorAll('.filter-chip').forEach(function(chip) {
      chip.addEventListener('click', function() {
        chip.classList.toggle('active');
        applyFilters();
      });
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // How to read this grid (updated per projection)
  // ═══════════════════════════════════════════════════════════════

  var GRID_AXES_HTML = '<div><strong class="text-[var(--color-text-primary)]">Grid axes</strong> \u2014 Rows are hourglass bands (Neural N7\u2013N1, Interface I0, Synthetic S1\u2013S3). Columns are attack categories (Signal Injection, Eavesdropping, Data Manipulation, etc.).</div>';
  var QIF_IDS_HTML = '<div><strong class="text-[var(--color-text-primary)]">QIF IDs</strong> \u2014 QIF-T0001+ for techniques. Tactics use Qinnovate\u2019s TARA Taxonomy (e.g. QIF-N.IJ = Neural Injection). NISS scores rate neural impact 0\u201310.</div>';

  function updateHowToRead(projId) {
    var proj = PROJECTIONS[projId];
    howToReadBody.innerHTML = GRID_AXES_HTML + proj.explanation.body + QIF_IDS_HTML;
  }

  // ═══════════════════════════════════════════════════════════════
  // Legend bar rebuild
  // ═══════════════════════════════════════════════════════════════

  var LEGEND_SWATCHES = {
    security: [
      { color: 'rgba(239, 68, 68, 0.35)', label: 'Critical' },
      { color: 'rgba(245, 158, 11, 0.30)', label: 'High' },
      { color: 'rgba(234, 179, 8, 0.25)', label: 'Medium' },
      { color: 'rgba(148, 163, 184, 0.25)', label: 'Low' },
    ],
    clinical: [
      { color: 'rgba(16, 185, 129, 0.35)', label: 'Confirmed' },
      { color: 'rgba(6, 182, 212, 0.30)', label: 'Probable' },
      { color: 'rgba(139, 92, 246, 0.25)', label: 'Possible' },
      { color: 'rgba(148, 163, 184, 0.25)', label: 'Silicon Only' },
    ],
    governance: [
      { color: 'rgba(34, 197, 94, 0.30)', label: 'Standard' },
      { color: 'rgba(245, 158, 11, 0.30)', label: 'Enhanced' },
      { color: 'rgba(239, 68, 68, 0.35)', label: 'IRB' },
      { color: 'rgba(127, 29, 29, 0.40)', label: 'Prohibited' },
    ],
    engineering: [
      { color: 'rgba(59, 130, 246, 0.35)', label: 'EM' },
      { color: 'rgba(245, 158, 11, 0.30)', label: 'Mechanical' },
      { color: 'rgba(239, 68, 68, 0.30)', label: 'Thermal' },
      { color: 'rgba(168, 85, 247, 0.30)', label: 'Optical' },
      { color: 'rgba(148, 163, 184, 0.25)', label: 'None' },
    ],
  };

  function rebuildLegend(projId) {
    var swatches = LEGEND_SWATCHES[projId] || LEGEND_SWATCHES.security;
    var html = '';
    for (var i = 0; i < swatches.length; i++) {
      html += '<div class="flex items-center gap-1.5"><span class="inline-block w-3 h-3 rounded" style="background:' + swatches[i].color + ';"></span> ' + swatches[i].label + '</div>';
    }
    html += '<button id="legend-help-btn" class="ml-2 w-5 h-5 rounded-full border border-[var(--color-border)] text-[var(--color-text-faint)] hover:text-[var(--color-text-primary)] hover:border-[var(--color-border-hover)] text-xs cursor-pointer flex items-center justify-center" aria-label="How to read this grid" title="How to read this grid">?</button>';
    legendBar.innerHTML = html;
    // Re-wire the help button
    var newBtn = document.getElementById('legend-help-btn');
    if (newBtn) {
      newBtn.addEventListener('click', function() {
        howToRead.classList.toggle('hidden');
      });
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // Projection-aware filter application
  // ═══════════════════════════════════════════════════════════════

  function getActiveSetFromContainer(container, attr) {
    var active = new Set();
    container.querySelectorAll('.filter-chip').forEach(function(f) {
      if (f.classList.contains('active')) {
        // Get the data-attribute value
        active.add(f.dataset[attr]);
      }
    });
    return active;
  }

  function applyFilters() {
    var query = searchInput.value.toLowerCase().trim();
    var proj = PROJECTIONS[activeProjection];
    var matcher = FILTER_MATCHERS[activeProjection];

    // Collect active dimension filter values
    var activeValues = {};
    for (var g = 0; g < proj.filters.length; g++) {
      var grp = proj.filters[g];
      activeValues[grp.attr] = getActiveSetFromContainer(dimFilters, grp.attr);
    }

    // Zone filters
    var activeZones = new Set();
    zoneFiltersEl.querySelectorAll('.filter-chip').forEach(function(f) {
      if (f.classList.contains('active')) activeZones.add(f.dataset.zone);
    });

    document.querySelectorAll('.map-cell').forEach(function(cell) {
      var zone = cell.dataset.zone || '';
      var threatIds = JSON.parse(cell.dataset.threats || '[]');

      // Zone filter
      if (!activeZones.has(zone)) {
        cell.classList.add('filtered-out');
        return;
      }

      // Empty cells
      if (threatIds.length === 0) {
        cell.classList.remove('filtered-out');
        return;
      }

      // Get matching threats
      var threats = threatIds.map(function(id) { return THREATS[id]; }).filter(Boolean);

      // Dimension filter — at least one threat must match
      var hasMatch = threats.some(function(t) {
        return matcher(t, activeValues);
      });
      if (!hasMatch) {
        cell.classList.add('filtered-out');
        return;
      }

      // Search filter
      if (query) {
        var matchesSearch = threats.some(function(t) {
          return t.name.toLowerCase().indexOf(query) !== -1 ||
            t.description.toLowerCase().indexOf(query) !== -1 ||
            t.id.toLowerCase().indexOf(query) !== -1 ||
            (t.coupling && t.coupling.toLowerCase().indexOf(query) !== -1) ||
            (t.tactic && t.tactic.toLowerCase().indexOf(query) !== -1);
        });
        if (!matchesSearch) {
          cell.classList.add('filtered-out');
          return;
        }
      }

      cell.classList.remove('filtered-out');
    });

    // Filter row headers by zone
    document.querySelectorAll('.map-row-header').forEach(function(header) {
      var zone = header.dataset.zone || '';
      header.classList.toggle('filtered-out', !activeZones.has(zone));
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // Drawer
  // ═══════════════════════════════════════════════════════════════

  function openDrawer(cell) {
    var threatIds = JSON.parse(cell.dataset.threats || '[]');
    var band = cell.dataset.band;
    var category = cell.dataset.category;
    if (threatIds.length === 0) return;

    lastOpenedCell = cell;
    var threats = threatIds.map(function(id) { return THREATS[id]; }).filter(Boolean);
    var renderer = DETAIL_RENDERERS[activeProjection];

    var html = '<div style="margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid var(--color-border);">' +
      '<div style="font-size:0.7rem;color:var(--color-text-faint);font-family:var(--font-mono);">' + band + ' \u00d7 ' + category + '</div>' +
      '<div style="font-size:1.1rem;font-weight:600;margin-top:0.25rem;">' + threats.length + ' Threat' + (threats.length !== 1 ? 's' : '') + '</div>' +
      '<div style="font-size:0.6rem;color:var(--color-text-faint);margin-top:0.15rem;text-transform:uppercase;letter-spacing:0.08em;">' + PROJECTIONS[activeProjection].label + ' view</div>' +
    '</div>';

    for (var i = 0; i < threats.length; i++) {
      html += '<div class="detail-threat">' + renderer(threats[i]) + '</div>';
    }

    drawerContent.innerHTML = html;
    drawer.classList.add('open');
  }

  function closeDrawer() {
    drawer.classList.remove('open');
    lastOpenedCell = null;
  }

  // ═══════════════════════════════════════════════════════════════
  // Tooltip
  // ═══════════════════════════════════════════════════════════════

  function showTooltip(cell, e) {
    var threatIds = JSON.parse(cell.dataset.threats || '[]');
    if (threatIds.length === 0) return;

    var threats = threatIds.map(function(id) { return THREATS[id]; }).filter(Boolean);
    var html = '';
    for (var i = 0; i < threats.length; i++) {
      var t = threats[i];
      html += '<div class="tt-name">' + t.id + ' \u2014 ' + t.name + '</div>';
      html += '<div class="tt-meta">' + t.severity.toUpperCase() + ' \u00b7 ' + t.status + ' \u00b7 ' + t.bandsStr + (t.coupling ? ' \u00b7 ' + t.coupling : '') + '</div>';
    }

    tooltip.innerHTML = html;
    positionTooltip(e);
    tooltip.classList.add('visible');
  }

  function positionTooltip(e) {
    var x = Math.min(e.clientX + 12, window.innerWidth - 320);
    var y = Math.min(e.clientY - 8, window.innerHeight - 150);
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
  }

  function hideTooltip() {
    tooltip.classList.remove('visible');
  }

  // ═══════════════════════════════════════════════════════════════
  // Projection switching — the main orchestrator
  // ═══════════════════════════════════════════════════════════════

  function switchProjection(projId) {
    if (!PROJECTIONS[projId]) return;
    activeProjection = projId;
    threatPage.setAttribute('data-projection', projId);

    // 1. Tab active state + aria
    tabsNav.querySelectorAll('.tara-tab').forEach(function(tab) {
      var isActive = tab.dataset.projection === projId;
      tab.classList.toggle('active', isActive);
      tab.setAttribute('aria-checked', String(isActive));
    });

    // 1b. Update projection description
    var projDesc = document.getElementById('projection-desc');
    if (projDesc) projDesc.textContent = PROJECTION_DESCRIPTIONS[projId] || '';

    // 1c. Show/hide sub-view toggle
    var svToggle = document.getElementById('subview-toggle');
    if (svToggle) {
      svToggle.style.display = (projId === 'modality') ? 'flex' : 'none';
    }

    // 2. Grid recoloring
    recolorGrid(projId);

    // 3. Stats bar
    rebuildStats(projId);

    // 4. Filters
    rebuildFilters(projId);

    // 5. How to read + legend
    updateHowToRead(projId);
    rebuildLegend(projId);

    // 6. Re-apply filters
    applyFilters();

    // 7. If drawer is open, re-render with new projection
    if (drawer.classList.contains('open') && lastOpenedCell) {
      openDrawer(lastOpenedCell);
    }

    // 8. URL hash
    window.history.replaceState(null, '', '#' + projId);
  }

  // ═══════════════════════════════════════════════════════════════
  // Event wiring
  // ═══════════════════════════════════════════════════════════════

  // Tab clicks
  tabsNav.querySelectorAll('.tara-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      switchProjection(tab.dataset.projection);
    });
  });

  // Sub-view toggle for Modality
  document.querySelectorAll('.subview-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      activeSubView = btn.dataset.subview;
      document.querySelectorAll('.subview-btn').forEach(function(b) {
        b.classList.toggle('active', b.dataset.subview === activeSubView);
      });
      // Recolor grid with new sub-view
      recolorGrid('modality');
      applyFilters();
    });
  });

  // Drawer
  drawerClose.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeDrawer();
  });

  // Cell interactions
  document.querySelectorAll('.map-cell:not(.map-cell--empty)').forEach(function(cell) {
    cell.addEventListener('mouseenter', function(e) { showTooltip(cell, e); });
    cell.addEventListener('mousemove', function(e) { positionTooltip(e); });
    cell.addEventListener('mouseleave', hideTooltip);
    cell.addEventListener('click', function() {
      hideTooltip();
      openDrawer(cell);
    });
  });

  // Zone filter chips (constant, wired once)
  zoneFiltersEl.querySelectorAll('.filter-chip').forEach(function(chip) {
    chip.addEventListener('click', function() {
      chip.classList.toggle('active');
      applyFilters();
    });
  });

  // Search
  searchInput.addEventListener('input', applyFilters);

  // ═══════════════════════════════════════════════════════════════
  // Init: check URL hash for initial projection
  // ═══════════════════════════════════════════════════════════════

  (function init() {
    // Wire up legend help button
    if (legendHelpBtn) {
      legendHelpBtn.addEventListener('click', function() {
        howToRead.classList.toggle('hidden');
      });
    }

    var hash = window.location.hash.replace('#', '');
    if (hash && PROJECTIONS[hash]) {
      switchProjection(hash);
    }
    // Security is default — already server-rendered
  })();
</script>
