---
import BaseLayout from './BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import { formatDate, cleanTag, readingTime } from '../lib/utils';
import '../styles/global.css';

interface Props {
  title: string;
  date: string | Date;
  tags: string[];
  source?: string;
  subtitle?: string;
  factChecked?: boolean;
  factCheckDate?: string;
}

const { title, date: rawDate, tags, source, subtitle, factChecked, factCheckDate } = Astro.props;
const date = rawDate instanceof Date ? rawDate : new Date(rawDate);
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const pubBreadcrumbs = [
  { label: 'News', href: '/news/' },
  { label: title },
];
---

<BaseLayout
  title={title}
  description={subtitle || `${title} â€” Qinnovate Publications`}
  ogType="article"
  articleMeta={{ publishedTime: date.toISOString(), author: "Qinnovate", tags }}
  breadcrumbs={pubBreadcrumbs}
>
  <Nav />

  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-16">
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": title,
      "description": subtitle || title,
      "datePublished": date.toISOString(),
      "author": { "@type": "Organization", "name": "Qinnovate", "url": "https://qinnovate.com" },
      "publisher": { "@type": "Organization", "name": "Qinnovate", "url": "https://qinnovate.com" },
      "mainEntityOfPage": canonicalURL.toString(),
    })} />

    <Breadcrumbs items={pubBreadcrumbs} />

    <!-- Article header -->
    <header class="mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold font-[family-name:var(--font-heading)] leading-tight mb-4">
        {title}
      </h1>

      {subtitle && (
        <p class="text-lg text-[var(--color-text-muted)] mb-6 italic">{subtitle}</p>
      )}

      <div class="flex flex-wrap items-center gap-4 text-sm text-[var(--color-text-faint)]">
        <time datetime={date.toISOString()}>{formatDate(date.toISOString())}</time>
        {source && (
          <>
            <span>&middot;</span>
            <a href={source} target="_blank" rel="noopener noreferrer" class="hover:text-[var(--color-accent-primary)] transition-colors">
              Original source
            </a>
          </>
        )}
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        {tags.map((tag) => (
          <span class="text-xs px-2 py-1 rounded-full bg-[var(--color-bg-elevated)] text-[var(--color-text-muted)]">
            {cleanTag(tag)}
          </span>
        ))}
      </div>

      {factChecked && factCheckDate && (
        <div class="mt-3 inline-flex items-center gap-1.5 text-xs text-green-600 dark:text-green-400">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M16.403 12.652a3 3 0 000-5.304 3 3 0 00-3.75-3.751 3 3 0 00-5.305 0 3 3 0 00-3.751 3.75 3 3 0 000 5.305 3 3 0 003.75 3.751 3 3 0 005.305 0 3 3 0 003.751-3.75zm-2.546-4.46a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
          </svg>
          <span>Links and references verified {factCheckDate}</span>
        </div>
      )}
    </header>

    <!-- Article body -->
    <div class="prose">
      <slot />
    </div>

    <!-- Article footer -->
    <footer class="mt-16 pt-8 border-t border-[var(--color-border)]">
      <a href="/news/" class="text-sm text-[var(--color-accent-primary)] hover:text-[var(--color-accent-secondary)] transition-colors">
        &larr; All news
      </a>
    </footer>
  </article>

  <!-- Derivation timeline (only activates if #derivation-timeline exists in post) -->
  <script is:inline src="/js/derivation-timeline.js"></script>

  <Footer />
</BaseLayout>
